<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>å°æ‰‹æœº</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.loli.net">
    <link rel="preconnect" href="https://gstatic.loli.net" crossorigin>
    <link href="https://fonts.loli.net/css2?family=Dancing+Script:wght@700&family=Ma+Shan+Zheng&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>
</head>

<body>
    <div id="phone-container">
        <div class="status-bar text-dark" id="status-bar">
            <div class="sb-left" id="clock">12:00</div>
            <div class="sb-right">
                <svg width="22" height="11" viewBox="0 0 22 11" fill="currentColor">
                    <path d="M4 5 l1.5 2.5 h-3 z" />
                    <path d="M4 11 l-1.5 -2.5 h3 z" />
                    <path d="M7 5.5h2v6H7v-6zm4-3h2v9H11v-9zm4-3h2v12h-2V-.5z"></path>
                </svg>
                <svg id="battery-icon" width="22" height="11" viewBox="0 0 25 11" fill="currentColor">
                    <rect x="0.5" y="0.5" width="20" height="10" rx="2.5" stroke="currentColor" fill="none"></rect>
                    <path d="M23 4v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
                    <rect id="battery-fill" x="2.5" y="2.5" width="16" height="6" rx="1" fill="currentColor"></rect>
                </svg>
            </div>
        </div>
        <div id="home-screen" class="screen">
            <div id="home-clock">12:00</div>
            <div class="app-grid">
                <div class="app-item" onclick="openMessageList()">
                    <div class="app-icon-box app-icon-style">
                        <div class="app-icon-image"
                            style="-webkit-mask-image: url('https://api.iconify.design/basil:wechat-solid.svg'); mask-image: url('https://api.iconify.design/basil:wechat-solid.svg');">
                        </div>
                    </div>
                    <span class="app-name">èŠå¤©</span>
                </div>
                <div class="app-item">
                    <div class="app-icon-box app-icon-style">
                        <div class="app-icon-image"
                            style="-webkit-mask-image: url('https://api.iconify.design/material-symbols:forum-rounded.svg'); mask-image: url('https://api.iconify.design/material-symbols:forum-rounded.svg');">
                        </div>
                    </div>
                    <span class="app-name">è®ºå›</span>
                </div>
                <div class="app-item">
                    <div class="app-icon-box app-icon-style">
                        <div class="app-icon-image"
                            style="-webkit-mask-image: url('https://api.iconify.design/fa-brands:discord.svg'); mask-image: url('https://api.iconify.design/fa-brands:discord.svg');">
                        </div>
                    </div>
                    <span class="app-name">Discord</span>
                </div>

                <div class="app-item" onclick="openUserSettings()">
                    <div class="app-icon-box app-icon-style">
                        <div class="app-icon-image"
                            style="-webkit-mask-image: url('https://api.iconify.design/tabler:mood-edit.svg'); mask-image: url('https://api.iconify.design/tabler:mood-edit.svg');">
                        </div>
                    </div>
                    <span class="app-name">userè®¾ç½®</span>
                </div>
                <div class="app-item" onclick="openCharacterSetup('world')">
                    <div class="app-icon-box app-icon-style">
                        <div class="app-icon-image"
                            style="-webkit-mask-image: url('https://api.iconify.design/bxs:book-heart.svg'); mask-image: url('https://api.iconify.design/bxs:book-heart.svg');">
                        </div>
                    </div>
                    <span class="app-name">ä¸–ç•Œä¹¦</span>
                </div>
                <div class="app-item" onclick="openNpcSettings()">
                    <div class="app-icon-box app-icon-style">
                        <div class="app-icon-image"
                            style="-webkit-mask-image: url('https://api.iconify.design/game-icons:love-mystery.svg'); mask-image: url('https://api.iconify.design/game-icons:love-mystery.svg');">
                        </div>
                    </div>
                    <span class="app-name">è§’è‰²è®¾ç½®</span>
                </div>
                <div class="app-item" onclick="openSettings()">
                    <div class="app-icon-box app-icon-style"><svg viewBox="0 0 24 24">
                            <path
                                d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L3.16 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z">
                            </path>
                        </svg></div>
                    <span class="app-name">è®¾ç½®</span>
                </div>
                <div class="app-item" onclick="openRegexScreen()">
                    <div class="app-icon-box app-icon-style">
                        <div class="app-icon-image"
                            style="-webkit-mask-image: url('https://api.iconify.design/tabler:regex.svg'); mask-image: url('https://api.iconify.design/tabler:regex.svg');">
                        </div>
                    </div>
                    <span class="app-name">æ­£åˆ™</span>
                </div>
            </div>
        </div>
        <div id="message-list-screen" class="screen">
            <div class="app-header">
                <div class="header-content">
                    <div class="header-btn" onclick="goBack()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title" id="message-list-header-title">æ¶ˆæ¯åˆ—è¡¨</span>
                    <div class="header-btn header-btn-right" onclick="showAddActionSheet()"><svg viewBox="0 0 24 24">
                            <path d="M12 5v14M5 12h14" stroke="#181818" stroke-width="2" stroke-linecap="round"></path>
                        </svg></div>
                </div>
            </div>
            <div class="message-list-body" id="message-list-body">
                <!-- åˆ—è¡¨é¡¹å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="contacts-list-body" id="contacts-list-body" style="display: none; flex: 1; overflow-y: auto;">
                <!-- é€šè®¯å½•å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="moments-body" id="moments-body" style="display: none; flex: 1; overflow-y: auto;">
                <!-- åŠ¨æ€å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="me-body" id="me-body" style="display: none; flex: 1; overflow-y: auto;">
                <!-- æˆ‘å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div id="bottom-nav">
                <div class="nav-item active" onclick="switchNavTab('message')">
                    <div class="nav-icon">
                        <div class="nav-icon-image"
                            style="-webkit-mask-image: url('https://api.iconify.design/tabler:message-circle-2.svg'); mask-image: url('https://api.iconify.design/tabler:message-circle-2.svg');">
                        </div>
                    </div>
                    <div class="nav-label">æ¶ˆæ¯</div>
                </div>
                <div class="nav-item" onclick="switchNavTab('contacts')">
                    <div class="nav-icon">
                        <div class="nav-icon-image"
                            style="-webkit-mask-image: url('https://api.iconify.design/ri:contacts-book-2-fill.svg'); mask-image: url('https://api.iconify.design/ri:contacts-book-2-fill.svg');">
                        </div>
                    </div>
                    <div class="nav-label">é€šè®¯å½•</div>
                </div>
                <div class="nav-item" onclick="switchNavTab('moments')">
                    <div class="nav-icon">
                        <div class="nav-icon-image"
                            style="-webkit-mask-image: url('https://api.iconify.design/iconoir:compass.svg'); mask-image: url('https://api.iconify.design/iconoir:compass.svg');">
                        </div>
                    </div>
                    <div class="nav-label">åŠ¨æ€</div>
                </div>
                <div class="nav-item" onclick="switchNavTab('me')">
                    <div class="nav-icon">
                        <div class="nav-icon-image"
                            style="-webkit-mask-image: url('https://api.iconify.design/clarity:avatar-line.svg'); mask-image: url('https://api.iconify.design/clarity:avatar-line.svg');">
                        </div>
                    </div>
                    <div class="nav-label">æˆ‘</div>
                </div>
            </div>
        </div>
        <div id="chat-screen" class="screen">
            <div class="app-header">
                <div class="header-content">
                    <div class="header-btn" onclick="goBack()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title" id="header-title"></span>
                    <div class="header-btn header-btn-right" style="display: flex; gap: 0; right: 0; width: auto;">
                        <div id="offline-mode-btn" onclick="toggleOfflineMode()" title="çº¿ä¸‹äº¤æµæ¨¡å¼"
                            style="padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="#181818"
                                stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 21V3h12l4 4v14H3z" />
                                <path d="M9 21v-8h6v8" />
                                <circle cx="15" cy="13" r="1" fill="#181818" stroke="none" />
                            </svg>
                        </div>
                        <div onclick="openChatSettings()"
                            style="padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" width="24" height="24">
                                <circle cx="6" cy="12" r="1.6" fill="#181818"></circle>
                                <circle cx="12" cy="12" r="1.6" fill="#181818"></circle>
                                <circle cx="18" cy="12" r="1.6" fill="#181818"></circle>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            <div id="chat-messages"></div>
            <div id="love-effect-layer" class="love-effect-container"></div>

            <!-- å¼•ç”¨æ¶ˆæ¯é¢„è§ˆæ¡ -->
            <div id="quote-preview-bar">
                <div class="quote-preview-content">
                    <div class="quote-preview-name" id="quote-preview-name"></div>
                    <div class="quote-preview-text" id="quote-preview-text"></div>
                </div>
                <div class="quote-preview-close" onclick="cancelQuote()">Ã—</div>
            </div>

            <!-- åª’ä½“é¢„è§ˆæ¡ -->
            <div id="media-preview-bar">
                <div class="preview-item">
                    <img id="preview-image" src="" style="display:none">
                    <div id="preview-file-icon" class="preview-file-icon" style="display:none">ğŸµ</div>
                    <div class="preview-close" onclick="clearPreview()">Ã—</div>
                </div>
            </div>

            <div id="input-bar">
                <button id="plus-button" class="toolbar-btn" title="æ›´å¤šåŠŸèƒ½"><svg viewBox="0 0 24 24">
                        <path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg></button>
                <button id="emoji-button" class="toolbar-btn"><svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9" stroke-width="2" stroke-linecap="round"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9" stroke-width="2" stroke-linecap="round"></line>
                    </svg></button>
                <textarea id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
                <button id="send-button">å‘é€</button>
            </div>
            <input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
            <input type="file" id="audio-upload-input" accept="audio/*" style="display: none;">
            <input type="file" id="video-upload-input" accept="video/*" style="display: none;">
            <input type="file" id="settings-file-input" accept="image/*" style="display: none;">
            <div id="action-menu">
                <div class="action-item" onclick="handleAction('photo')">
                    <div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="#333" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg></div><span>ç…§ç‰‡</span>
                </div>
                <div class="action-item" onclick="handleAction('voice')">
                    <div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="#333" stroke-width="1.5">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg></div><span>è¯­éŸ³</span>
                </div>
                <div class="action-item" onclick="handleAction('call')">
                    <div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="#333" stroke-width="1.5">
                            <path
                                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
                            </path>
                        </svg></div><span>é€šè¯</span>
                </div>
                <div class="action-item" onclick="handleAction('camera')">
                    <div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="#333" stroke-width="1.5">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z">
                            </path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg></div><span>ç›¸æœº</span>
                </div>
                <div class="action-item" onclick="handleAction('location')">
                    <div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="#333" stroke-width="1.5">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg></div><span>ä½ç½®</span>
                </div>
                <div class="action-item" onclick="handleAction('transfer')">
                    <div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="#333" stroke-width="1.5">
                            <path d="M7 10h14l-4-4"></path>
                            <path d="M17 14H3l4 4"></path>
                        </svg></div><span>è½¬è´¦</span>
                </div>
                <div class="action-item" onclick="handleAction('file')">
                    <div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="#333" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg></div><span>æ–‡ä»¶</span>
                </div>
            </div>
            <div id="emoji-menu"></div>
        </div>
        <!-- è®¾ç½®å¯¼èˆªé¡µé¢ -->
        <div id="settings-screen" class="screen">
            <div class="app-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeSettings()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title">æ‰‹æœºè®¾ç½®</span>
                    <div class="header-btn header-btn-right" style="visibility:hidden;"></div>
                </div>
            </div>
            <div class="settings-nav-body">
                <!-- æ—¶é—´è®¾ç½® -->
                <div class="settings-nav-card" style="cursor:default;">
                    <div class="settings-nav-icon" style="background: rgba(255,154,158,0.15);">
                        <div class="settings-nav-icon-img"
                            style="-webkit-mask-image: url('https://api.iconify.design/mdi:clock-outline.svg'); mask-image: url('https://api.iconify.design/mdi:clock-outline.svg'); background-color: #e88a9a;">
                        </div>
                    </div>
                    <div class="settings-nav-text" style="flex:1;">
                        <div class="settings-nav-title">è‡ªå®šä¹‰æ—¶é—´</div>
                        <div class="settings-nav-subtitle">è®¾ç½®çŠ¶æ€æ æ˜¾ç¤ºæ—¶é—´</div>
                    </div>
                    <input type="text" id="set-custom-time" class="setting-input-sm"
                        style="width: 70px; text-align: center; border: 1px solid #eee; border-radius: 8px; padding: 4px 8px; font-size: 13px;"
                        placeholder="HH:MM">
                </div>

                <!-- å¤–è§‚è®¾ç½® -->
                <div class="settings-nav-card" onclick="openBeautifySettings()">
                    <div class="settings-nav-icon" style="background: rgba(255,154,158,0.15);">
                        <div class="settings-nav-icon-img"
                            style="-webkit-mask-image: url('https://api.iconify.design/fluent-emoji-high-contrast:artist-palette.svg'); mask-image: url('https://api.iconify.design/fluent-emoji-high-contrast:artist-palette.svg'); background-color: #e88a9a;">
                        </div>
                    </div>
                    <div class="settings-nav-text">
                        <div class="settings-nav-title">å¤–è§‚è®¾ç½®</div>
                        <div class="settings-nav-subtitle">ä¸»é¢˜ Â· å›¾æ ‡ Â· å­—ä½“</div>
                    </div>
                    <svg class="settings-nav-arrow" viewBox="0 0 24 24">
                        <path d="M10 6l6 6-6 6" stroke="#ccc" stroke-width="2" fill="none" stroke-linecap="round"
                            stroke-linejoin="round"></path>
                    </svg>
                </div>

                <!-- APIè®¾ç½® -->
                <div class="settings-nav-card" onclick="openApiSettings()">
                    <div class="settings-nav-icon" style="background: rgba(255,154,158,0.15);">
                        <div class="settings-nav-icon-img"
                            style="-webkit-mask-image: url('https://api.iconify.design/ant-design:api-outlined.svg'); mask-image: url('https://api.iconify.design/ant-design:api-outlined.svg'); background-color: #e88a9a;">
                        </div>
                    </div>
                    <div class="settings-nav-text">
                        <div class="settings-nav-title">APIè®¾ç½®</div>
                        <div class="settings-nav-subtitle">å¯†é’¥ Â· ç«¯ç‚¹ Â· æ–‡æ¡£</div>
                    </div>
                    <svg class="settings-nav-arrow" viewBox="0 0 24 24">
                        <path d="M10 6l6 6-6 6" stroke="#ccc" stroke-width="2" fill="none" stroke-linecap="round"
                            stroke-linejoin="round"></path>
                    </svg>
                </div>

                <!-- æ•°æ®è®¾ç½® -->
                <div class="settings-nav-card" onclick="openDataSettings()">
                    <div class="settings-nav-icon" style="background: rgba(255,154,158,0.15);">
                        <div class="settings-nav-icon-img"
                            style="-webkit-mask-image: url('https://api.iconify.design/material-symbols:database-outline.svg'); mask-image: url('https://api.iconify.design/material-symbols:database-outline.svg'); background-color: #e88a9a;">
                        </div>
                    </div>
                    <div class="settings-nav-text">
                        <div class="settings-nav-title">æ•°æ®è®¾ç½®</div>
                        <div class="settings-nav-subtitle">å¤‡ä»½ Â· æ¢å¤ Â· æ¸…é™¤</div>
                    </div>
                    <svg class="settings-nav-arrow" viewBox="0 0 24 24">
                        <path d="M10 6l6 6-6 6" stroke="#ccc" stroke-width="2" fill="none" stroke-linecap="round"
                            stroke-linejoin="round"></path>
                    </svg>
                </div>

                <!-- NAI ç”Ÿå›¾è®¾ç½® -->
                <div class="settings-nav-card" onclick="openNaiSettings()">
                    <div class="settings-nav-icon" style="background: rgba(168,130,255,0.15);">
                        <div class="settings-nav-icon-img"
                            style="-webkit-mask-image: url('https://api.iconify.design/material-symbols:palette-outline.svg'); mask-image: url('https://api.iconify.design/material-symbols:palette-outline.svg'); background-color: #a882ff;">
                        </div>
                    </div>
                    <div class="settings-nav-text">
                        <div class="settings-nav-title">NAI ç”Ÿå›¾è®¾ç½®</div>
                        <div class="settings-nav-subtitle">NovelAI Â· æç¤ºè¯ Â· å‚æ•°</div>
                    </div>
                    <svg class="settings-nav-arrow" viewBox="0 0 24 24">
                        <path d="M10 6l6 6-6 6" stroke="#ccc" stroke-width="2" fill="none" stroke-linecap="round"
                            stroke-linejoin="round"></path>
                    </svg>
                </div>

            </div>
        </div>

        <!-- APIè®¾ç½®å­é¡µé¢ -->
        <div id="api-settings-screen" class="screen">
            <div class="app-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeApiSettings()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title">APIè®¾ç½®</span>
                </div>
            </div>
            <div class="settings-body">
                <div>
                    <div class="settings-section-title">API è®¾ç½®</div>
                    <div class="setting-group">
                        <div class="setting-row">
                            <label>API åœ°å€</label>
                            <input type="text" id="set-api-endpoint" class="setting-input"
                                placeholder="https://api.openai.com/v1">
                        </div>
                        <div class="setting-row">
                            <label>API Key</label>
                            <input type="password" id="set-api-key" class="setting-input" placeholder="sk-...">
                        </div>
                        <div class="setting-row">
                            <label>æ¨¡å‹</label>
                            <select id="set-api-model" class="setting-input" style="flex: 1; min-width: 0;">
                                <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <label>AI æ¸©åº¦ (Temperature)</label>
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <input type="range" id="set-api-temp" class="setting-range" min="0" max="2" step="0.1"
                                    value="1.0" style="flex: 1;"
                                    oninput="document.getElementById('temp-value-display').textContent = this.value">
                                <span id="temp-value-display"
                                    style="width: 30px; text-align: right; font-size: 13px; color: #666;">1.0</span>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 10px 0; text-align: right;">
                        <button onclick="refreshModelList()" class="action-btn"
                            style="display: inline-block; padding: 6px 16px; white-space: nowrap; background: linear-gradient(135deg, #ff9a9e, #fecfef); color: white; border: none; border-radius: 8px; font-size: 12px; cursor: pointer;">è·å–æ¨¡å‹åˆ—è¡¨</button>
                    </div>

                    <div class="setting-group">
                        <div class="setting-row">
                            <label>è°ƒè¯•æ¨¡å¼ (æ˜¾ç¤ºAIåŸå§‹è¾“å‡º)</label>
                            <div><input type="checkbox" id="set-debug-mode" class="toggle-switch"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-footer" style="padding: 10px;">
                <button class="modal-btn btn-save"
                    style="width: 100%; padding: 8px; border-radius: 12px; font-size: 13px;"
                    onclick="saveApiSettings()">ä¿å­˜</button>
            </div>
        </div>

        <!-- æ•°æ®è®¾ç½®å­é¡µé¢ -->
        <div id="data-settings-screen" class="screen">
            <div class="app-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeDataSettings()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title">æ•°æ®è®¾ç½®</span>
                </div>
            </div>
            <div class="settings-body">
                <div>
                    <div class="settings-section-title">æ•°æ®ç®¡ç†</div>
                    <div class="setting-group">
                        <div class="setting-row" style="cursor:pointer" onclick="exportAllData()">
                            <label style="cursor:pointer">å¤‡ä»½æ•°æ®</label>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" />
                            </svg>
                        </div>
                        <div class="setting-row" style="cursor:pointer" onclick="importAllData()">
                            <label style="cursor:pointer">æ¢å¤æ•°æ®</label>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12" />
                            </svg>
                        </div>
                        <div class="setting-row" style="cursor:pointer" onclick="clearAllData()">
                            <label style="cursor:pointer; color:#e53935;">æ¸…é™¤æ‰€æœ‰æ•°æ®</label>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#e53935"
                                stroke-width="2">
                                <path
                                    d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NAI ç”Ÿå›¾è®¾ç½®å­é¡µé¢ -->
        <div id="nai-settings-screen" class="screen">
            <div class="app-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeNaiSettings()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title">NAI ç”Ÿå›¾è®¾ç½®</span>
                </div>
            </div>
            <div class="settings-body">
                <!-- åŸºæœ¬ API é…ç½® -->
                <div>
                    <div class="settings-section-title">API é…ç½®</div>
                    <div class="setting-group">
                        <div class="setting-row">
                            <label>NAI API Key</label>
                            <input type="password" id="set-nai-api-key" class="setting-input" placeholder="pst-...">
                        </div>
                        <div class="setting-row">
                            <div style="display:flex; flex-direction:column; gap:2px; flex:1;">
                                <label style="font-size:14px;">å¯ç”¨ NAI ç”Ÿå›¾</label>
                                <span style="font-size:11px; color:#aaa; line-height:1.4;">å¼€å¯åï¼ŒAIå‘é€å›¾ç‰‡æ—¶è‡ªåŠ¨è°ƒç”¨NAIç”Ÿæˆ</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="set-nai-enabled">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å‹ä¸é‡‡æ · -->
                <div>
                    <div class="settings-section-title">æ¨¡å‹ä¸é‡‡æ ·</div>
                    <div class="setting-group">
                        <div class="setting-row">
                            <label>æ¨¡å‹</label>
                            <select id="set-nai-model" class="setting-input" style="flex: 1; min-width: 0;">
                                <option value="nai-diffusion-4-curated-preview">NAI Diffusion 4 Curated</option>
                                <option value="nai-diffusion-4-full-preview">NAI Diffusion 4 Full</option>
                                <option value="nai-diffusion-3">NAI Diffusion 3 (Anime V3)</option>
                                <option value="nai-diffusion-3-inpainting">NAI Diffusion 3 Inpainting</option>
                                <option value="nai-diffusion-2">NAI Diffusion 2</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <label>é‡‡æ ·å™¨ (Sampler)</label>
                            <select id="set-nai-sampler" class="setting-input" style="flex: 1; min-width: 0;">
                                <option value="k_euler">Euler</option>
                                <option value="k_euler_ancestral" selected>Euler Ancestral</option>
                                <option value="k_dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
                                <option value="k_dpmpp_2m_sde">DPM++ 2M SDE</option>
                                <option value="k_dpmpp_sde">DPM++ SDE</option>
                                <option value="ddim_v3">DDIM</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <label>å™ªå£°è°ƒåº¦ (Schedule)</label>
                            <select id="set-nai-schedule" class="setting-input" style="flex: 1; min-width: 0;">
                                <option value="native" selected>Native</option>
                                <option value="karras">Karras</option>
                                <option value="exponential">Exponential</option>
                                <option value="polyexponential">Polyexponential</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <label>æ­¥æ•° (Steps)</label>
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <input type="range" id="set-nai-steps" class="setting-range" min="1" max="50" step="1"
                                    value="28" style="flex: 1;"
                                    oninput="document.getElementById('nai-steps-display').textContent = this.value">
                                <span id="nai-steps-display"
                                    style="width: 30px; text-align: right; font-size: 13px; color: #666;">28</span>
                            </div>
                        </div>
                        <div class="setting-row">
                            <label>å¼•å¯¼å¼ºåº¦ (Scale/CFG)</label>
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <input type="range" id="set-nai-scale" class="setting-range" min="0" max="10" step="0.1"
                                    value="5" style="flex: 1;"
                                    oninput="document.getElementById('nai-scale-display').textContent = this.value">
                                <span id="nai-scale-display"
                                    style="width: 30px; text-align: right; font-size: 13px; color: #666;">5</span>
                            </div>
                        </div>
                        <div class="setting-row">
                            <label>Seed (-1 ä¸ºéšæœº)</label>
                            <input type="number" id="set-nai-seed" class="setting-input" value="-1"
                                style="width:80px; text-align:center;">
                        </div>
                    </div>
                </div>

                <!-- å›¾ç‰‡å°ºå¯¸ -->
                <div>
                    <div class="settings-section-title">å›¾ç‰‡å°ºå¯¸</div>
                    <div class="setting-group">
                        <div class="setting-row">
                            <label>é¢„è®¾å°ºå¯¸</label>
                            <select id="set-nai-size-preset" class="setting-input" style="flex: 1; min-width: 0;"
                                onchange="applyNaiSizePreset()">
                                <option value="832x1216" selected>ç«–ç‰ˆ (832Ã—1216)</option>
                                <option value="1216x832">æ¨ªç‰ˆ (1216Ã—832)</option>
                                <option value="1024x1024">æ­£æ–¹å½¢ (1024Ã—1024)</option>
                                <option value="512x768">å°ç«–ç‰ˆ (512Ã—768)</option>
                                <option value="768x512">å°æ¨ªç‰ˆ (768Ã—512)</option>
                                <option value="640x640">å°æ­£æ–¹ (640Ã—640)</option>
                                <option value="custom">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        <div class="setting-row" id="nai-custom-size-row" style="display:none;">
                            <label>å®½åº¦</label>
                            <input type="number" id="set-nai-width" class="setting-input" value="832"
                                style="width:70px; text-align:center;">
                            <label style="margin:0 6px;">Ã—</label>
                            <label>é«˜åº¦</label>
                            <input type="number" id="set-nai-height" class="setting-input" value="1216"
                                style="width:70px; text-align:center;">
                        </div>
                    </div>
                </div>

                <!-- æç¤ºè¯è®¾ç½® -->
                <div>
                    <div class="settings-section-title">æç¤ºè¯ (Prompt)</div>
                    <div class="setting-group">
                        <div class="setting-row" style="flex-direction:column; align-items:stretch; gap:8px;">
                            <label>æ­£é¢æç¤ºè¯å‰ç¼€ (Quality Tags)</label>
                            <textarea id="set-nai-positive-prefix" class="setting-input"
                                style="height:60px; font-size:12px; resize:vertical; font-family:monospace;"
                                placeholder="best quality, amazing quality, very aesthetic, absurdres">best quality, amazing quality, very aesthetic, absurdres</textarea>
                        </div>
                        <div class="setting-row" style="flex-direction:column; align-items:stretch; gap:8px;">
                            <label>æ­£é¢æç¤ºè¯åç¼€ (å›ºå®šé™„åŠ å†…å®¹)</label>
                            <textarea id="set-nai-positive-suffix" class="setting-input"
                                style="height:40px; font-size:12px; resize:vertical; font-family:monospace;"
                                placeholder="å¯é€‰ï¼Œå¦‚ï¼šmasterpiece, 1girl"></textarea>
                        </div>
                        <div class="setting-row" style="flex-direction:column; align-items:stretch; gap:8px;">
                            <label>è´Ÿé¢æç¤ºè¯ (Negative Prompt)</label>
                            <textarea id="set-nai-negative" class="setting-input"
                                style="height:80px; font-size:12px; resize:vertical; font-family:monospace;"
                                placeholder="lowres, {bad}, error, fewer, extra, missing, ...">lowres, {bad}, error, fewer, extra, missing, worst quality, jpeg artifacts, bad quality, watermark, unfinished, displeasing, chromatic aberration, signature, extra digits, artistic error, username, scan, [abstract]</textarea>
                        </div>
                    </div>
                </div>

                <!-- AI æç¤ºè¯æ„å»ºæ ¼å¼ -->
                <div>
                    <div class="settings-section-title">AI å›¾ç‰‡æç¤ºè¯æ ¼å¼</div>
                    <div class="setting-group">
                        <div class="setting-row" style="flex-direction:column; align-items:stretch; gap:8px;">
                            <label style="font-size:13px;">AI å‘é€å›¾ç‰‡æ—¶çš„æç¤ºè¯æ„å»ºæŒ‡ä»¤</label>
                            <span style="font-size:11px; color:#aaa; line-height:1.5;">æ­¤æŒ‡ä»¤ä¼šæ·»åŠ åˆ°ç³»ç»Ÿæç¤ºè¯ä¸­ï¼Œæ•™å¯¼ AI åœ¨å‘é€
                                type="img" æ¶ˆæ¯æ—¶ï¼ŒæŒ‰ç…§ NAI tag æ ¼å¼æè¿°å›¾ç‰‡å†…å®¹ã€‚<br>å¯ç”¨å˜é‡ï¼š<code>{char_name}</code> è§’è‰²å</span>
                            <textarea id="set-nai-prompt-instruction" class="setting-input"
                                style="height:130px; font-size:11px; resize:vertical; font-family:monospace;"
                                placeholder="æŒ‡å¯¼AIå¦‚ä½•æ„å»ºNAIå›¾ç‰‡Tag...">When sending type="img" messages, write the content as NovelAI image generation tags (Danbooru tag format). Rules:
1. Use comma-separated English tags, NOT natural language descriptions.
2. Include character appearance tags: hair color, eye color, expression, pose, clothing.
3. Include scene/background tags: location, lighting, atmosphere.
4. Use tag weighting: {{important tag}}, [less important tag].
5. Character name tag: {char_name}.
6. Example: 1girl, {char_name}, silver hair, blue eyes, smile, school uniform, sitting, classroom, window, sunlight, upper body</textarea>
                        </div>
                    </div>
                </div>

                <!-- SMEA å’Œé«˜çº§é€‰é¡¹ -->
                <div>
                    <div class="settings-section-title">é«˜çº§é€‰é¡¹</div>
                    <div class="setting-group">
                        <div class="setting-row">
                            <div style="display:flex; flex-direction:column; gap:2px; flex:1;">
                                <label style="font-size:14px;">SMEA</label>
                                <span style="font-size:11px; color:#aaa; line-height:1.4;">æ”¹å–„å¤§å°ºå¯¸å›¾åƒçš„æ„å›¾</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="set-nai-smea" checked>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="setting-row">
                            <div style="display:flex; flex-direction:column; gap:2px; flex:1;">
                                <label style="font-size:14px;">Dynamic SMEA</label>
                                <span style="font-size:11px; color:#aaa; line-height:1.4;">SMEA çš„åŠ¨æ€ç‰ˆæœ¬ï¼Œæ•ˆæœæ›´å¥½ä½†è¾ƒæ…¢</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="set-nai-dynamic">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="setting-row">
                            <label>CFG Rescale</label>
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <input type="range" id="set-nai-cfg-rescale" class="setting-range" min="0" max="1"
                                    step="0.01" value="0" style="flex: 1;"
                                    oninput="document.getElementById('nai-cfg-rescale-display').textContent = this.value">
                                <span id="nai-cfg-rescale-display"
                                    style="width: 36px; text-align: right; font-size: 13px; color: #666;">0</span>
                            </div>
                        </div>
                        <div class="setting-row">
                            <label>Uncond Scale</label>
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <input type="range" id="set-nai-uncond-scale" class="setting-range" min="0" max="1.5"
                                    step="0.05" value="1" style="flex: 1;"
                                    oninput="document.getElementById('nai-uncond-scale-display').textContent = this.value">
                                <span id="nai-uncond-scale-display"
                                    style="width: 36px; text-align: right; font-size: 13px; color: #666;">1</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="settings-footer" style="padding: 10px;">
                <button class="modal-btn btn-save"
                    style="width: 100%; padding: 8px; border-radius: 12px; font-size: 13px;"
                    onclick="saveNaiSettings()">ä¿å­˜</button>
            </div>
        </div>


        <!-- ç¾åŒ–è®¾ç½®é¡µé¢ -->
        <div id="beautify-screen" class="screen">
            <div class="app-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeBeautifySettings()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title">å¤–è§‚è®¾ç½®</span>
                </div>
            </div>
            <div class="settings-body">
                <!-- å›¾æ ‡ä¸æ–‡å­— -->
                <div>
                    <div class="settings-section-title">å›¾æ ‡ä¸æ–‡å­—</div>
                    <div class="setting-group">
                        <div class="setting-row"><label>å›¾æ ‡åº•è‰²</label> <input type="color" id="set-icon-bg"
                                class="color-picker"></div>
                        <div class="setting-row"><label>å›¾æ ‡å›¾æ¡ˆ</label> <input type="color" id="set-icon-color"
                                class="color-picker"></div>
                        <div class="setting-row"><label>å­—ä½“é¢œè‰²</label> <input type="color" id="set-home-text-color"
                                class="color-picker"></div>
                    </div>
                </div>

                <!-- ä¸»å±å¹•å£çº¸ -->
                <div>
                    <div class="settings-section-title">ä¸»å±å¹•å£çº¸</div>
                    <div class="setting-group">
                        <div class="setting-row"
                            style="display: flex; flex-direction: column; align-items: stretch; gap: 12px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label style="font-weight: bold;">å½“å‰å£çº¸é¢„è§ˆ</label>
                                <div>
                                    <button class="file-upload-label"
                                        onclick="triggerSettingsUpload('home-bg')">æœ¬åœ°ä¸Šä¼ </button>
                                    <button class="file-upload-label"
                                        style="margin-left: 5px; background-color: #f0f0f0; color: #333;"
                                        onclick="openUrlUploadModal('home-bg')">urlä¸Šä¼ </button>
                                </div>
                            </div>
                            <div
                                style="background: #f7f7f7; border-radius: 12px; border: 1px solid #eee; display: flex; justify-content: center; align-items: center; padding: 20px;">
                                <img id="preview-home-bg" src=""
                                    style="width: 140px; height: 280px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #fff;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è‡ªå®šä¹‰CSS -->
                <div>
                    <div class="settings-section-title">è‡ªå®šä¹‰CSS</div>
                    <div class="setting-group">
                        <style>
                            #set-custom-css::-webkit-scrollbar {
                                display: none;
                            }
                        </style>
                        <textarea id="set-custom-css" class="setting-input"
                            style="height: 200px; font-family: monospace; font-size: 12px; width: 100%; box-sizing: border-box; border: none; resize: vertical; padding: 10px; outline: none; scrollbar-width: none; -ms-overflow-style: none;"
                            placeholder="è¾“å…¥CSSä»£ç ..."></textarea>
                    </div>
                </div>
            </div>
            <div class="settings-footer" style="padding: 10px;">
                <button class="modal-btn btn-save"
                    style="width: 100%; padding: 8px; border-radius: 12px; font-size: 13px;"
                    onclick="saveBeautifySettings()">ä¿å­˜å¹¶åº”ç”¨</button>
            </div>
        </div>
        <div id="input-modal" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-title" id="modal-title">è¾“å…¥å†…å®¹</div>
                <div id="modal-inputs-container"></div>
                <div class="modal-actions"><button class="modal-btn btn-cancel"
                        onclick="closeModal()">å–æ¶ˆ</button><button class="modal-btn btn-grey"
                        id="modal-confirm-btn">å‘é€</button></div>
            </div>
        </div>

        <div id="update-modal" class="modal-overlay">
            <div class="modal-box"
                style="background: #fff0f5; border: 3px solid #ffb6c1; border-radius: 25px; box-shadow: 0 10px 30px rgba(255,182,193,0.4);">
                <div class="modal-title"
                    style="color: #ff69b4; font-family: 'Ma Shan Zheng', cursive; font-size: 22px;">æ›´æ–°å•¦
                </div>
                <style>
                    #update-content::-webkit-scrollbar {
                        display: none;
                    }
                </style>
                <div id="update-content"
                    style="font-size: 14px; color: #888; line-height: 1.8; max-height: 300px; overflow-y: auto; text-align: left; padding: 15px; white-space: pre-wrap; background: rgba(255,255,255,0.6); border-radius: 15px; margin: 10px 0; scrollbar-width: none; -ms-overflow-style: none;">
                </div>
                <div class="modal-actions">
                    <button class="modal-btn btn-grey" onclick="closeUpdateModal()"
                        style="width: 100%; background: #ffb6c1; color: white; border: none; font-weight: bold; border-radius: 20px;">æˆ‘çŸ¥é“å•¦</button>
                </div>
            </div>
        </div>

        <div id="add-contact-modal" class="modal-overlay">
            <div class="modal-box group-modal-cute">
                <div class="modal-title group-modal-title" id="add-contact-title">å‘èµ·èŠå¤©</div>
                <div id="add-contact-private-section">
                    <div class="group-modal-field">
                        <label class="group-modal-label">é€‰æ‹©æˆ‘çš„èº«ä»½</label>
                        <select id="private-chat-user-select" class="group-modal-select"></select>
                    </div>
                    <div class="group-modal-field">
                        <label class="group-modal-label">é€‰æ‹©èŠå¤©å¯¹è±¡</label>
                        <select id="private-chat-npc-select" class="group-modal-select"></select>
                    </div>
                </div>
                <div id="add-contact-group-section" style="display:none">
                    <div class="group-modal-field">
                        <label class="group-modal-label">ç¾¤èŠåç§°</label>
                        <input type="text" id="group-name-input" class="group-modal-input" placeholder="è¾“å…¥ç¾¤èŠåç§°">
                    </div>

                    <div class="group-modal-field">
                        <label class="group-modal-label">é€‰æ‹©ç¾¤ä¸» (User)</label>
                        <select id="group-chat-user-select" class="group-modal-select"></select>
                    </div>

                    <div class="group-modal-field">
                        <div class="group-modal-label-row">
                            <label class="group-modal-label">ç¾¤æˆå‘˜ (è§’è‰²)</label>
                            <button type="button" class="group-add-role-btn" onclick="addGroupNpcSelect()">
                                <svg viewBox="0 0 24 24" width="14" height="14">
                                    <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2.5"
                                        stroke-linecap="round" />
                                </svg>
                                <span>æ·»åŠ </span>
                            </button>
                        </div>
                        <div id="group-npc-select-list" class="group-npc-select-list">
                            <!-- åŠ¨æ€æ·»åŠ çš„è§’è‰²ä¸‹æ‹‰æ¡† -->
                        </div>
                    </div>
                </div>
                <div class="modal-actions" style="margin-top: 14px; gap: 10px;">
                    <button class="modal-btn group-modal-cancel" onclick="closeAddContactModal()">å–æ¶ˆ</button>
                    <button class="modal-btn group-modal-confirm" onclick="confirmAddContact()">ç¡®è®¤</button>
                </div>
            </div>
        </div>
        <div id="chat-settings-screen" class="screen">
            <div class="app-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeChatSettings()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title">èŠå¤©è®¾ç½®</span>
                </div>
            </div>
            <div class="settings-nav-body">
                <!-- å¤´åƒè®¾ç½® (Moved back) -->
                <div>
                    <div class="settings-section-title">å¤´åƒè®¾ç½®</div>
                    <div class="setting-group no-border" style="background: transparent; box-shadow: none;">
                        <div id="avatar-settings-container" class="avatar-grid"></div>
                    </div>
                </div>

                <!-- å¤‡æ³¨è®¾ç½® -->
                <div style="margin-top: 10px;">
                    <div class="settings-section-title">å¤‡æ³¨</div>
                    <div class="setting-group">
                        <div class="setting-row">
                            <label>å¤‡æ³¨å</label>
                            <input type="text" id="set-chat-remark" class="uc-input" placeholder="è®¾ç½®å¤‡æ³¨å..."
                                style="width: 140px; text-align: right; border: none; background: transparent; font-size: 14px; color: #333;"
                                oninput="saveChatRemarkAuto()">
                        </div>
                    </div>
                </div>

                <!-- ç¾åŒ–è®¾ç½® -->
                <div class="settings-nav-card" onclick="openChatBeautifySettings()">
                    <div class="settings-nav-icon" style="background: rgba(255,154,158,0.15);">
                        <div class="settings-nav-icon-img"
                            style="-webkit-mask-image: url('https://api.iconify.design/fluent-emoji-high-contrast:artist-palette.svg'); mask-image: url('https://api.iconify.design/fluent-emoji-high-contrast:artist-palette.svg'); background-color: #e88a9a;">
                        </div>
                    </div>
                    <div class="settings-nav-text">
                        <div class="settings-nav-title">ç¾åŒ–è®¾ç½®</div>
                        <div class="settings-nav-subtitle">æ°”æ³¡ Â· å­—ä½“ Â· èƒŒæ™¯</div>
                    </div>
                    <svg class="settings-nav-arrow" viewBox="0 0 24 24">
                        <path d="M10 6l6 6-6 6" stroke="#ccc" stroke-width="2" fill="none" stroke-linecap="round"
                            stroke-linejoin="round"></path>
                    </svg>
                </div>

                <!-- è®°å¿†è®¾ç½® -->
                <div class="settings-nav-card" onclick="openChatMemorySettings()">
                    <div class="settings-nav-icon" style="background: rgba(255,154,158,0.15);">
                        <div class="settings-nav-icon-img"
                            style="-webkit-mask-image: url('https://api.iconify.design/material-symbols:memory.svg'); mask-image: url('https://api.iconify.design/material-symbols:memory.svg'); background-color: #e88a9a;">
                        </div>
                    </div>
                    <div class="settings-nav-text">
                        <div class="settings-nav-title">è®°å¿†è®¾ç½®</div>
                        <div class="settings-nav-subtitle">Tokenç»Ÿè®¡ Â· è®°å¿†æ€»ç»“</div>
                    </div>
                    <svg class="settings-nav-arrow" viewBox="0 0 24 24">
                        <path d="M10 6l6 6-6 6" stroke="#ccc" stroke-width="2" fill="none" stroke-linecap="round"
                            stroke-linejoin="round"></path>
                    </svg>
                </div>

                <!-- æ—¶åŒºè®¾ç½® -->
                <div style="margin-top: 10px;">
                    <div class="settings-section-title">æ—¶åŒºè®¾ç½®</div>
                    <div class="setting-group">
                        <div class="setting-row">
                            <label>åŒä¸€æ—¶åŒº</label>
                            <label class="switch">
                                <input type="checkbox" id="set-char-same-tz" checked onchange="toggleCharTimezone()">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div id="char-tz-detail" style="display: none;">
                            <div class="setting-row">
                                <label>æ—¶å·®</label>
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <select id="set-char-tz-offset" class="setting-input-sm"
                                        style="width: 120px; text-align: center; border: 1px solid #eee; border-radius: 8px; padding: 4px 6px; font-size: 13px;"
                                        onchange="updateCharTimePreview()">
                                    </select>
                                </div>
                            </div>
                            <div
                                style="display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 8px 0;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 12px; color: #999;">æˆ‘çš„æ—¶é—´ï¼š</span>
                                    <span id="preview-user-tz-time"
                                        style="font-size: 13px; color: #333; font-weight: 500;">--:--</span>
                                </div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <span style="font-size: 12px; color: #999;">å¯¹æ–¹æ—¶é—´ï¼š</span>
                                    <span id="preview-char-tz-time"
                                        style="font-size: 13px; color: #e88a9a; font-weight: 600;">--:--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ‹‰é»‘è®¾ç½® -->
                <div style="margin-top: 10px;">
                    <div class="settings-section-title">éšç§ä¸å®‰å…¨</div>
                    <div class="setting-group">
                        <div class="setting-row">
                            <label>æ‹’æ”¶å¯¹æ–¹æ¶ˆæ¯</label>
                            <label class="switch">
                                <input type="checkbox" id="set-block-char" onchange="saveChatBlockSettings()">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="setting-row">
                            <label>æ¶ˆæ¯è¢«å¯¹æ–¹æ‹’æ”¶</label>
                            <label class="switch">
                                <input type="checkbox" id="set-block-user" onchange="saveChatBlockSettings()">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- è§’è‰²æ‰®æ¼”è®¾ç½® -->
                <div style="margin-top: 10px;">
                    <div class="settings-section-title">è§’è‰²æ‰®æ¼”</div>
                    <div class="setting-group">
                        <div class="setting-row">
                            <div style="display:flex; flex-direction:column; gap:2px; flex:1;">
                                <label style="font-size:14px;">Mate æ¨¡å¼</label>
                                <span
                                    style="font-size:11px; color:#aaa; line-height:1.4;">å¼€å¯åï¼Œè§’è‰²çŸ¥é“è‡ªå·±æ˜¯AIè§’è‰²æ‰®æ¼”ï¼Œè€ŒéçœŸå®å­˜åœ¨</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="set-mate-mode" onchange="saveChatMateModeAuto()">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="setting-row">
                            <div style="display:flex; flex-direction:column; gap:2px; flex:1;">
                                <label style="font-size:14px;">å¿ƒå£°æ¨¡å¼</label>
                                <span
                                    style="font-size:11px; color:#aaa; line-height:1.4;">å¼€å¯åï¼ŒAIæ¯æ¬¡å›å¤è‡³å°‘ä¸¤æ¡æ¶ˆæ¯æœ«å°¾ä¼šé™„ä¸Šè§’è‰²å†…å¿ƒç‹¬ç™½</span>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="set-inner-voice-mode"
                                    onchange="saveChatInnerVoiceModeAuto()">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- åª’ä½“ç®¡ç† (å·²ç§»é™¤ï¼ŒåŠŸèƒ½ç§»åŠ¨è‡³å…¨å±€è®¾ç½®) -->


                <!-- æ•°æ®ç®¡ç† (Moved back) -->
                <div>
                    <div class="settings-section-title">æ•°æ®ç®¡ç†</div>
                    <div class="setting-group">
                        <div class="setting-row" onclick="exportCurrentChat()" style="cursor: pointer;">
                            <label style="cursor: pointer;">å¯¼å‡ºèŠå¤©è®°å½•</label>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" />
                            </svg>
                        </div>
                        <div class="setting-row" onclick="clearCurrentChatMessages()" style="cursor: pointer;">
                            <label style="cursor: pointer; color: #e53935;">æ¸…ç©ºèŠå¤©å†…å®¹</label>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#e53935"
                                stroke-width="2">
                                <path
                                    d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
                            </svg>
                        </div>
                        <div class="setting-row" onclick="deleteCurrentChat()" style="cursor: pointer;">
                            <label style="cursor: pointer; color: #e53935;">åˆ é™¤è¯¥èŠå¤©</label>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#e53935"
                                stroke-width="2">
                                <path
                                    d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¾åŒ–è®¾ç½®å­é¡µé¢ -->
        <div id="chat-beautify-screen" class="screen">
            <div class="app-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeChatBeautifySettings()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title">ç¾åŒ–è®¾ç½®</span>
                </div>
            </div>
            <div class="settings-body">
                <!-- æ°”æ³¡ä¸å­—ä½“ -->
                <div>
                    <div class="settings-section-title">æ°”æ³¡ä¸å­—ä½“</div>
                    <div class="setting-group">
                        <div class="setting-row"><label>å¯¹æ–¹æ°”æ³¡/æ–‡å­—</label>
                            <div><input type="color" id="set-char-bubble" class="color-picker"> <input type="color"
                                    id="set-char-text" class="color-picker"></div>
                        </div>
                        <div class="setting-row"><label>æˆ‘æ–¹æ°”æ³¡/æ–‡å­—</label>
                            <div><input type="color" id="set-user-bubble" class="color-picker"> <input type="color"
                                    id="set-user-text" class="color-picker"></div>
                        </div>
                        <div class="setting-row"><label>å­—ä½“å¤§å°</label>
                            <div><input type="number" id="set-font-size" class="setting-input-sm" placeholder="14"
                                    style="width: 60px;"> px</div>
                        </div>
                    </div>
                </div>

                <!-- é¢œè‰²è®¾ç½® -->
                <div>
                    <div class="settings-section-title">é¢œè‰²è®¾ç½®</div>
                    <div class="setting-group">
                        <div class="setting-row"><label>åå­—/æ—¶é—´</label>
                            <div><input type="color" id="set-msg-name-color" class="color-picker"> <input type="color"
                                    id="set-msg-time-color" class="color-picker"></div>
                        </div>
                        <div class="setting-row"><label>ç•Œé¢</label>
                            <div><input type="color" id="set-interface-color" class="color-picker"></div>
                        </div>
                    </div>
                </div>

                <!-- æŒ‰é’®è®¾ç½® -->
                <div>
                    <div class="settings-section-title">æŒ‰é’®è®¾ç½®</div>
                    <div class="setting-group">
                        <div class="setting-row"><label>æŒ‰é’®é¢œè‰²</label>
                            <div><input type="color" id="set-chat-btn-text" class="color-picker"></div>
                        </div>
                    </div>
                </div>

                <!-- èƒŒæ™¯è®¾ç½® -->
                <div>
                    <div class="settings-section-title">èƒŒæ™¯è®¾ç½®</div>
                    <div class="setting-group">
                        <div class="setting-row"
                            style="display: flex; flex-direction: column; align-items: stretch; gap: 12px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label style="font-weight: bold;">èŠå¤©èƒŒæ™¯é¢„è§ˆ</label>
                                <div><button class="file-upload-label"
                                        onclick="triggerSettingsUpload('chat-bg')">æœ¬åœ°ä¸Šä¼ </button>
                                    <button class="file-upload-label"
                                        style="margin-left: 5px; background-color: #f0f0f0; color: #333;"
                                        onclick="openUrlUploadModal('chat-bg')">urlä¸Šä¼ </button>
                                </div>
                            </div>
                            <div
                                style="background: #f7f7f7; border-radius: 12px; border: 1px solid #eee; display: flex; justify-content: center; align-items: center; padding: 20px;">
                                <img id="preview-chat-bg" src=""
                                    style="width: 140px; height: 280px; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #fff;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="settings-footer" style="padding: 10px;">
                <button class="modal-btn btn-save" onclick="saveChatBeautifySettings()"
                    style="width: 100%; border-radius: 12px; padding: 8px 0; box-shadow: none; font-size: 13px;">ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <!-- è®°å¿†è®¾ç½®å­é¡µé¢ -->
        <div id="chat-memory-screen" class="screen">
            <div class="app-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeChatMemorySettings()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title">è®°å¿†è®¾ç½®</span>
                </div>
            </div>
            <div class="settings-body">
                <!-- Token ç»Ÿè®¡ -->
                <div>
                    <div class="settings-section-title">Token ç»Ÿè®¡ (ä¼°ç®—)</div>
                    <div class="setting-group">
                        <div class="setting-row">
                            <label>è§’è‰²è®¾å®š (Char)</label>
                            <span id="token-char-setup" style="font-size: 13px; color: #888;">0</span>
                        </div>
                        <div class="setting-row">
                            <label>ç”¨æˆ·è®¾å®š (User)</label>
                            <span id="token-user-setup" style="font-size: 13px; color: #888;">0</span>
                        </div>
                        <div class="setting-row">
                            <label>èŠå¤©è®°å½• (Chat)</label>
                            <span id="token-chat-history" style="font-size: 13px; color: #888;">0</span>
                        </div>
                        <div class="setting-row">
                            <label>è®°å¿†æ€»ç»“ (Memory)</label>
                            <span id="token-memory-summary" style="font-size: 13px; color: #888;">0</span>
                        </div>
                        <div class="setting-row">
                            <label>ç³»ç»Ÿæ€»è®¡ (Sys)</label>
                            <span id="token-system-setup" style="font-size: 13px; color: #888;">0</span>
                        </div>
                        <div class="setting-row" style="border-top: 1px solid #f0f0f0;">
                            <label style="font-weight: bold;">æ€»è®¡ (Total)</label>
                            <span id="token-total" style="font-weight: bold; font-size: 13px; color: #333;">0</span>
                        </div>
                    </div>
                </div>

                <!-- è®°å¿†æ€»ç»“è®¾ç½® -->
                <div>
                    <div class="settings-section-title">æ€»ç»“è®¾ç½®</div>
                    <div class="setting-group">
                        <div class="setting-row">
                            <div style="display:flex; flex-direction:column; gap:2px; flex:1;">
                                <label style="font-size:14px;">æ¶ˆæ¯ä¿ç•™æ¡æ•°</label>
                                <span
                                    style="font-size:11px; color:#aaa; line-height:1.4;">æ€»ç»“åä¿ç•™æœ€è¿‘N-5æ¡æ¶ˆæ¯ä¸è¢«æ€»ç»“ï¼Œæœ€è¿‘Næ¡æ¶ˆæ¯ä¸è¢«åˆ é™¤</span>
                            </div>
                            <input type="number" id="memory-keep-count" value="10" min="5" max="100"
                                style="width: 60px; text-align: center; border: 1px solid #ddd; border-radius: 6px; padding: 4px 8px; font-size: 14px;">
                        </div>
                    </div>

                </div>


                <!-- è®°å¿†æ“ä½œ -->
                <div>
                    <div class="settings-section-title">è®°å¿†æ“ä½œ</div>
                    <div class="setting-group">
                        <div class="setting-row" id="memory-action-buttons-container"
                            style="display: flex; gap: 10px; padding: 12px; align-items: stretch;">
                            <button id="btn-summarize-memory" onclick="summarizeChatMemory()" class="modal-btn"
                                style="flex: 1; border-radius: 8px; background-color: #e8f5e9; color: #2e7d32; padding: 10px; font-size: 13px;">
                                AIè‡ªåŠ¨æ€»ç»“
                            </button>
                            <button onclick="addMemoryManual()" class="modal-btn"
                                style="flex: 1; border-radius: 8px; background-color: #e3f2fd; color: #1565c0; padding: 10px; font-size: 13px;">
                                æ‰‹åŠ¨æ·»åŠ 
                            </button>
                        </div>
                    </div>
                </div>

                <!-- è®°å¿†åˆ—è¡¨ -->
                <div>
                    <div class="settings-section-title"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <span>è®°å¿†æ€»ç»“åˆ—è¡¨</span>
                        <div onclick="toggleMemoryBatchMode()"
                            style="cursor: pointer; padding: 8px; display: flex; align-items: center;" title="æ‰¹é‡ç®¡ç†">
                            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #888;">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z">
                                </path>
                            </svg>
                        </div>
                    </div>
                    <div id="memory-list-container" class="setting-group">
                        <div class="setting-row"
                            style="justify-content: center; color: #aaa; font-size: 13px; padding: 20px;">
                            æš‚æ— è®°å¿†æ€»ç»“
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®°å¿†ç¼–è¾‘å¼¹çª— -->
        <div id="memory-edit-modal" class="modal-overlay">
            <div class="modal-box" style="max-width: 360px;">
                <div class="modal-title" id="memory-edit-modal-title">ç¼–è¾‘è®°å¿†</div>
                <div style="display:flex; flex-direction:column; gap:12px;">
                    <div>
                        <label style="font-size:13px; color:#666; margin-bottom:4px; display:block;">è®°å¿†æ ‡é¢˜</label>
                        <input type="text" id="memory-edit-title" class="uc-input" placeholder="å¦‚ï¼šç¬¬ä¸€æ¬¡çº¦ä¼š">
                    </div>
                    <div>
                        <label style="font-size:13px; color:#666; margin-bottom:4px; display:block;">è®°å¿†å†…å®¹</label>
                        <textarea id="memory-edit-content" class="uc-textarea" placeholder="æè¿°è¿™æ®µè®°å¿†çš„å…³é”®ä¿¡æ¯..."
                            style="min-height: 120px; resize: vertical;"></textarea>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:12px; color:#aaa;" id="memory-edit-token-count">0 tokens</span>
                    </div>
                </div>
                <div class="modal-actions" style="justify-content: flex-end; gap: 10px; margin-top:15px;">
                    <button class="modal-btn" onclick="closeMemoryEditModal()"
                        style="background:#f5f5f5; color:#333;">å–æ¶ˆ</button>
                    <button class="modal-btn btn-confirm" onclick="saveMemoryEntry()">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <div id="call-screen" class="screen"
            style="background: linear-gradient(180deg, #2b2b2b 0%, #1a1a1a 100%); color: #fff; flex-direction: column; align-items: center; justify-content: space-between; padding: 60px 20px 40px 20px; z-index: 100; box-sizing: border-box; display: none;">
            <!-- Top: Name + Timer + Status + Avatar (fixed position) -->
            <div
                style="display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100%; flex-shrink: 0;">
                <div id="call-name" style="font-size: 26px; font-weight: 600; letter-spacing: 1px;"></div>
                <div id="call-timer" style="font-size: 16px; opacity: 0.6; font-variant-numeric: tabular-nums;">
                    00:00</div>
                <div id="call-char-text" style="font-size: 12px; opacity: 0.8;"></div>
                <div style="position: relative; margin-top: 10px;">
                    <img id="call-avatar" src=""
                        style="width: 100px; height: 100px; border-radius: 20px; object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);">
                    <div class="ripple-ring"></div>
                </div>
            </div>

            <!-- Middle: Chat bubbles (scrollable, takes remaining space) -->
            <div id="call-chat-container"
                style="width: 100%; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px; flex: 1; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; margin-top: 15px;">
                <!-- Call bubbles will be injected here -->
            </div>
            <style>
                #call-chat-container::-webkit-scrollbar {
                    display: none;
                }

                .call-bubble {
                    max-width: 80%;
                    padding: 8px 12px;
                    border-radius: 16px;
                    font-size: 14px;
                    line-height: 1.4;
                    word-break: break-word;
                    animation: fadeIn 0.3s ease;
                }

                .call-bubble.sent {
                    align-self: flex-end;
                    background: #666666;
                    color: #fff;
                    border-bottom-right-radius: 4px;
                }

                .call-bubble.received {
                    align-self: flex-start;
                    background: #333333;
                    color: #fff;
                    border-bottom-left-radius: 4px;
                }

                @keyframes fadeIn {
                    from {
                        opacity: 0;
                        transform: translateY(5px);
                    }

                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                @keyframes jump-exclamation {

                    0%,
                    100% {
                        transform: translateY(0);
                    }

                    50% {
                        transform: translateY(-5px);
                    }
                }

                .jumping-exclamation {
                    display: inline-block;
                    font-weight: bold;
                    font-size: 18px;
                    animation: jump-exclamation 0.6s infinite;
                }
            </style>

            <div style="width: 100%; display: flex; flex-direction: column; gap: 30px;">
                <div
                    style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 25px; backdrop-filter: blur(10px);">
                    <input type="text" id="call-input" placeholder="æˆ‘æƒ³è¯´..."
                        style="flex: 1; height: 32px; line-height: 32px; padding: 0 15px; border-radius: 20px; border: none; outline: none; background: transparent; color: #fff; font-size: 15px; margin-top: 6px;">
                    <button onclick="sendCallMessage()"
                        style="width: 32px; height: 32px; border-radius: 50%; border: none; background: #333; color: #888; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; padding: 0; margin-left: 5px;">
                        <div
                            style="width: 20px; height: 20px; background-color: currentColor; -webkit-mask: url('https://api.iconify.design/typcn:phone.svg') no-repeat center / contain; mask: url('https://api.iconify.design/typcn:phone.svg') no-repeat center / contain;">
                        </div>
                    </button>
                </div>

                <div style="display: flex; justify-content: space-around; align-items: center;">
                    <div
                        style="display: flex; flex-direction: column; align-items: center; gap: 8px; opacity: 0.5; cursor: not-allowed;">
                        <div
                            style="width: 64px; height: 64px; border-radius: 50%; background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="#fff">
                                <path
                                    d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                                <path
                                    d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                            </svg>
                        </div>
                        <span style="font-size: 12px; font-weight: 500;">å½•éŸ³</span>
                    </div>

                    <div onclick="endVoiceCall()"
                        style="display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: transform 0.1s;">
                        <div
                            style="width: 64px; height: 64px; border-radius: 50%; background: #ff3b30; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);">
                            <img src="https://api.iconify.design/majesticons:phone-hangup.svg?color=white" width="32"
                                height="32">
                        </div>
                        <span style="font-size: 12px; font-weight: 500;">æŒ‚æ–­</span>
                    </div>
                </div>
            </div>
            <style>
                @keyframes ripple {
                    0% {
                        transform: scale(1);
                        opacity: 0.4;
                    }

                    100% {
                        transform: scale(1.5);
                        opacity: 0;
                    }
                }

                .ripple-ring {
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    border-radius: 20px;
                    border: 2px solid rgba(255, 255, 255, 0.5);
                    animation: ripple 2s infinite;
                    z-index: -1;
                    display: none;
                }

                #call-screen.speaking .ripple-ring {
                    display: block;
                }

                @keyframes wave-jump {

                    0%,
                    100% {
                        transform: translateY(0);
                    }

                    50% {
                        transform: translateY(-5px);
                    }
                }

                .jumping-dot {
                    display: inline-block;
                    animation: wave-jump 1s infinite;
                    font-size: 32px;
                    /* ç‚¹å¤§ä¸€äº› */
                    margin: 0 4px;
                    /* è·ç¦»å®½ä¸€äº› */
                    line-height: 10px;
                    /* é˜²æ­¢æ’‘å¼€é«˜åº¦ */
                }

                .jumping-dot:nth-child(1) {
                    animation-delay: 0s;
                }

                .jumping-dot:nth-child(2) {
                    animation-delay: 0.1s;
                }

                .jumping-dot:nth-child(3) {
                    animation-delay: 0.2s;
                }
            </style>
        </div>

        <div id="incoming-call-screen" class="screen"
            style="display:none; background: linear-gradient(180deg, #2b2b2b 0%, #1a1a1a 100%); color: #fff; flex-direction: column; align-items: center; justify-content: space-between; padding: 60px 20px 80px 20px; z-index: 110;">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                <div id="incoming-call-name" style="font-size: 26px; font-weight: 600;"></div>
                <div style="font-size: 16px; opacity: 0.6;">é‚€è¯·ä½ è¿›è¡Œè¯­éŸ³é€šè¯...</div>
            </div>

            <div style="position: relative;">
                <img id="incoming-call-avatar" src=""
                    style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div class="ripple-ring" style="display:block;"></div>
            </div>

            <div style="width: 100%; display: flex; justify-content: space-around; align-items: center;">
                <div onclick="declineIncomingCall()"
                    style="display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer;">
                    <div
                        style="width: 64px; height: 64px; border-radius: 50%; background: #ff3b30; display: flex; align-items: center; justify-content: center;">
                        <img src="https://api.iconify.design/majesticons:phone-hangup.svg?color=white" width="32"
                            height="32">
                    </div>
                    <span style="font-size: 12px;">æ‹’ç»</span>
                </div>

                <div onclick="acceptIncomingCall()"
                    style="display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer;">
                    <div
                        style="width: 64px; height: 64px; border-radius: 50%; background: #30d158; display: flex; align-items: center; justify-content: center;">
                        <img src="https://api.iconify.design/majesticons:phone.svg?color=white" width="32" height="32">
                    </div>
                    <span style="font-size: 12px;">æ¥å¬</span>
                </div>
            </div>
        </div>

        <div id="cropper-modal" class="modal-overlay" style="z-index: 300;">
            <div class="modal-box"
                style="width: 90%; height: 80%; max-width: 500px; max-height: 800px; padding: 0; background: #000; display: flex; flex-direction: column;">
                <div style="flex: 1; position: relative; overflow: hidden; background: #333;">
                    <img id="cropper-image" src="" style="max-width: 100%; display: block;">
                </div>
                <div class="modal-actions"
                    style="padding: 15px; background: #fff; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; justify-content: space-between;">
                    <button class="modal-btn btn-cancel" onclick="closeCropper()">å–æ¶ˆ</button>
                    <button class="modal-btn btn-confirm" onclick="confirmCrop()">è£å‰ªå¹¶ä½¿ç”¨</button>
                </div>
            </div>
        </div>

        <!-- Character Setup Screen - NPCåˆ—è¡¨ -->
        <div id="character-setup-screen" class="screen">
            <div class="app-header pink-header">
                <div class="header-content">
                    <div class="header-btn" onclick="goBack()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title">è§’è‰²è®¾ç½®</span>
                    <div class="header-btn header-btn-right" onclick="openNpcCreatePage()"><svg viewBox="0 0 24 24">
                            <path d="M12 5v14M5 12h14" stroke="#181818" stroke-width="2" stroke-linecap="round"></path>
                        </svg></div>
                </div>
            </div>
            <div id="npc-list-container" class="pink-scroll-area"></div>
        </div>

        <!-- NPC Create/Edit Screen (å…¨é¡µé¢ï¼Œä¸Useråˆ›å»ºé¡µé¢ä¸€è‡´) -->
        <div id="npc-create-screen" class="screen">
            <div class="app-header pink-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeNpcCreatePage()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title" id="npc-create-title">åˆ›å»ºè§’è‰²</span>
                    <div class="header-btn header-btn-right" onclick="saveNpc()">
                        <span style="font-size: 14px; color: #e398b1; font-weight: bold;">ä¿å­˜</span>
                    </div>
                </div>
            </div>
            <div class="user-create-body pink-scroll-area">
                <!-- å¤´åƒ -->
                <div class="uc-avatar-section">
                    <img id="npc-avatar-preview" class="uc-avatar"
                        src="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23d1d1d6'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E"
                        onclick="document.getElementById('npc-avatar-input').click()">
                    <input type="file" id="npc-avatar-input" accept="image/*" style="display:none">
                    <div class="uc-avatar-hint">ç‚¹å‡»æ›´æ¢å¤´åƒ <span
                            style="color: #e398b1; cursor: pointer; margin-left: 5px; font-weight: bold;"
                            onclick="event.stopPropagation(); openUrlUploadModal('npc-avatar')">urlä¸Šä¼ </span></div>
                </div>

                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="uc-card">
                    <div class="uc-field">
                        <label>å§“å</label>
                        <input type="text" id="npc-name-input-page" class="uc-input" placeholder="è§’è‰²åå­—">
                    </div>
                    <div class="uc-field">
                        <label>æ˜µç§°</label>
                        <input type="text" id="npc-nickname-input-page" class="uc-input" placeholder="æ˜µç§°/åˆ«åï¼ˆå¯é€‰ï¼‰">
                    </div>
                    <div class="uc-field">
                        <label>æ€§åˆ«</label>
                        <div class="uc-gender-group">
                            <label class="uc-gender-option selected" data-value="female">
                                <input type="radio" name="npc-gender-page" value="female" checked> å¥³
                            </label>
                            <label class="uc-gender-option" data-value="male">
                                <input type="radio" name="npc-gender-page" value="male"> ç”·
                            </label>
                        </div>
                    </div>
                </div>

                <!-- äººè®¾ -->
                <div class="uc-card">
                    <div class="uc-field">
                        <div class="uc-field-header">
                            <label>äººè®¾</label>
                            <span class="uc-token-count" id="npc-desc-token">0 tokens</span>
                        </div>
                        <textarea id="npc-desc-input-page" class="uc-textarea"
                            placeholder="æè¿°è§’è‰²çš„æ€§æ ¼ã€å¤–è²Œã€èƒŒæ™¯æ•…äº‹..."></textarea>
                    </div>
                </div>

                <!-- ä¸–ç•Œä¹¦ -->
                <div class="uc-card">
                    <div class="uc-field">
                        <label>ä¸–ç•Œä¹¦</label>
                        <div id="npc-worldbook-select" class="wb-select-container">
                            <div class="wb-option-empty">æš‚æ— ä¸–ç•Œä¹¦</div>
                        </div>
                        <div class="uc-hint">é€‰æ‹©ä¸€ä¸ªä¸–ç•Œä¹¦æ¥è®¾å®šæ•…äº‹èƒŒæ™¯</div>
                    </div>
                </div>

                <!-- å­NPCåˆ—è¡¨ -->
                <div class="uc-card">
                    <div class="uc-field">
                        <div class="uc-field-header">
                            <label>å…³è”NPC</label>
                            <button class="uc-add-npc-btn" onclick="addSubNpcToNpc()">+ æ·»åŠ NPC</button>
                        </div>
                        <div id="npc-sub-npc-list" class="uc-npc-list">
                        </div>
                    </div>
                </div>

                <div style="height: 30px;"></div>
            </div>
        </div>
        <!-- World Book List Screen -->
        <div id="worldbook-list-screen" class="screen">
            <div class="app-header pink-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeWorldbookList()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title">ä¸–ç•Œä¹¦</span>
                    <div class="header-btn header-btn-right" onclick="openWorldbookEdit(null)"><svg viewBox="0 0 24 24">
                            <path d="M12 5v14M5 12h14" stroke="#181818" stroke-width="2" stroke-linecap="round"></path>
                        </svg></div>
                </div>
            </div>
            <div id="worldbook-list-container" class="pink-scroll-area"></div>
        </div>

        <!-- World Book Edit Screen -->
        <div id="worldbook-edit-screen" class="screen">
            <div class="app-header pink-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeWorldbookEdit()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title" id="worldbook-edit-title">æ–°å»ºä¸–ç•Œä¹¦</span>
                    <div class="header-btn header-btn-right" onclick="saveWorldBookData()">
                        <span style="font-size: 14px; color: #e398b1; font-weight: bold;">ä¿å­˜</span>
                    </div>
                </div>
            </div>
            <div class="user-create-body pink-scroll-area">
                <div class="uc-card">
                    <div class="uc-field">
                        <label>ä¸–ç•Œä¹¦åç§°</label>
                        <input type="text" id="worldbook-name-input" class="uc-input" placeholder="è¾“å…¥ä¸–ç•Œä¹¦åç§°">
                    </div>
                </div>

                <div class="uc-card">
                    <div class="uc-field">
                        <div class="uc-field-header">
                            <label>æ¡ç›®åˆ—è¡¨</label>
                            <button class="uc-add-npc-btn" onclick="addWorldbookEntry()">+ æ·»åŠ æ¡ç›®</button>
                        </div>
                        <div id="worldbook-entries-container"></div>
                    </div>
                </div>

                <div style="height: 30px;"></div>
            </div>
        </div>

        <!-- User Settings Screen (Useråˆ—è¡¨) -->
        <div id="user-settings-screen" class="screen">
            <div class="app-header pink-header">
                <div class="header-content">
                    <div class="header-btn" onclick="goBack()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title">æˆ‘çš„è§’è‰²</span>
                    <div class="header-btn header-btn-right" onclick="openUserCreatePage()"><svg viewBox="0 0 24 24">
                            <path d="M12 5v14M5 12h14" stroke="#181818" stroke-width="2" stroke-linecap="round"></path>
                        </svg></div>
                </div>
            </div>
            <div id="user-list-container" class="pink-scroll-area"></div>
        </div>

        <!-- User Create/Edit Screen (å…¨é¡µé¢) -->
        <div id="user-create-screen" class="screen">
            <div class="app-header pink-header">
                <div class="header-content">
                    <div class="header-btn" onclick="closeUserCreatePage()"><svg viewBox="0 0 24 24">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                        </svg></div>
                    <span class="header-title" id="user-create-title">åˆ›å»ºè§’è‰²</span>
                    <div class="header-btn header-btn-right" onclick="saveUser()">
                        <span style="font-size: 14px; color: #e398b1; font-weight: bold;">ä¿å­˜</span>
                    </div>
                </div>
            </div>
            <div class="user-create-body pink-scroll-area">
                <!-- å¤´åƒ -->
                <div class="uc-avatar-section">
                    <img id="user-avatar-preview" class="uc-avatar"
                        src="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23d1d1d6'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E"
                        onclick="document.getElementById('user-avatar-input').click()">
                    <input type="file" id="user-avatar-input" accept="image/*" style="display:none">
                    <div class="uc-avatar-hint">ç‚¹å‡»æ›´æ¢å¤´åƒ <span
                            style="color: #e398b1; cursor: pointer; margin-left: 5px; font-weight: bold;"
                            onclick="event.stopPropagation(); openUrlUploadModal('user-avatar')">urlä¸Šä¼ </span></div>
                </div>

                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="uc-card">
                    <div class="uc-field">
                        <label>æ˜µç§°</label>
                        <input type="text" id="user-name-input" class="uc-input" placeholder="ç»™è§’è‰²èµ·ä¸ªåå­—å§~">
                    </div>
                    <div class="uc-field">
                        <label>æ€§åˆ«</label>
                        <div class="uc-gender-group">
                            <label class="uc-gender-option selected" data-value="female">
                                <input type="radio" name="user-gender" value="female" checked> å¥³
                            </label>
                        </div>
                        <input type="hidden" name="user-gender" value="female">
                    </div>
                </div>

                <!-- äººè®¾ -->
                <div class="uc-card">
                    <div class="uc-field">
                        <div class="uc-field-header">
                            <label>äººè®¾</label>
                            <span class="uc-token-count" id="user-desc-token">0 tokens</span>
                        </div>
                        <textarea id="user-desc-input" class="uc-textarea" placeholder="æè¿°è§’è‰²çš„æ€§æ ¼ã€å¤–è²Œã€èƒŒæ™¯æ•…äº‹..."></textarea>
                    </div>
                </div>

                <!-- ä¸–ç•Œä¹¦ -->
                <div class="uc-card">
                    <div class="uc-field">
                        <label>ä¸–ç•Œä¹¦</label>
                        <div id="user-worldbook-select" class="wb-select-container">
                            <div class="wb-option-empty">æš‚æ— ä¸–ç•Œä¹¦</div>
                        </div>
                        <div class="uc-hint">é€‰æ‹©ä¸€ä¸ªä¸–ç•Œä¹¦æ¥è®¾å®šæ•…äº‹èƒŒæ™¯</div>
                    </div>
                </div>

                <!-- NPCåˆ—è¡¨ -->
                <div class="uc-card">
                    <div class="uc-field">
                        <div class="uc-field-header">
                            <label>NPC è§’è‰²</label>
                            <button class="uc-add-npc-btn" onclick="addNpcToUser()">+ æ·»åŠ NPC</button>
                        </div>
                        <div id="user-npc-list" class="uc-npc-list">
                            <!-- NPC cards will be dynamically added here -->
                        </div>
                    </div>
                </div>

                <div style="height: 30px;"></div>
            </div>
        </div>

    </div>

    <div id="add-action-sheet-overlay" class="action-sheet-overlay" onclick="hideAddActionSheet()"></div>
    <div id="add-action-sheet" class="action-popup">
        <div class="action-popup-item" onclick="openAddContactModal('private')">
            <div class="action-popup-icon"><svg viewBox="0 0 24 24">
                    <path
                        d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
                </svg></div>
            <span>å‘èµ·ç§èŠ</span>
        </div>
        <div class="action-popup-item" onclick="openAddContactModal('group')">
            <div class="action-popup-icon"><svg viewBox="0 0 24 24">
                    <path
                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                </svg></div>
            <span>å‘èµ·ç¾¤èŠ</span>
        </div>
    </div>

    <script src="script.js"></script>

    <!-- URL Upload Modal -->
    <div id="url-upload-modal" class="modal-overlay" style="display:none; z-index: 500;">
        <div class="modal-box"
            style="width: 85%; max-width: 320px; padding: 20px; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; margin-bottom: 15px; font-size: 18px;">urlä¸Šä¼ </h3>
            <p style="font-size: 13px; color: #666; margin-bottom: 10px; line-height: 1.5;">
                è¾“å…¥ Catbox åç¼€ (å¦‚ 31onrh.jpeg) æˆ–å®Œæ•´ URL é“¾æ¥ã€‚
                <br>
            </p>
            <input type="text" id="url-upload-input" class="uc-input" placeholder="è¾“å…¥åç¼€æˆ–é“¾æ¥..."
                style="margin-bottom: 15px;">
            <div class="modal-actions" style="justify-content: flex-end; gap: 10px;">
                <button class="modal-btn" onclick="closeUrlUploadModal()"
                    style="background:#f5f5f5; color:#333;">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="confirmUrlUpload()">ç¡®å®š</button>
            </div>
        </div>
    </div>
    <!-- Regex Settings Screen -->
    <div id="regex-screen" class="screen">
        <div class="app-header">
            <div class="header-content">
                <div class="header-btn" onclick="closeRegexScreen()"><svg viewBox="0 0 24 24">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                    </svg></div>
                <span class="header-title">æ­£åˆ™è„šæœ¬</span>
                <div class="header-btn header-btn-right" onclick="addNewRegexRule()"><svg viewBox="0 0 24 24">
                        <path d="M12 5v14M5 12h14" stroke="#181818" stroke-width="2" stroke-linecap="round"></path>
                    </svg></div>
            </div>
        </div>
        <div class="settings-body" id="regex-list-container">
            <!-- Regex rules will be rendered here by JS -->
        </div>
    </div>

    <!-- Regex Edit Modal -->
    <div id="regex-edit-modal" class="modal-overlay">
        <div class="modal-box" style="max-width: 340px;">
            <div class="modal-title" id="regex-edit-modal-title">ç¼–è¾‘æ­£åˆ™</div>
            <div style="display:flex; flex-direction:column; gap:12px;">
                <div>
                    <label style="font-size:13px; color:#666; margin-bottom:4px; display:block;">è§„åˆ™åç§°</label>
                    <input type="text" id="regex-edit-name" class="uc-input" placeholder="å¦‚ï¼šå»é™¤æ˜Ÿå·">
                </div>
                <div>
                    <label style="font-size:13px; color:#666; margin-bottom:4px; display:block;">æ­£åˆ™è¡¨è¾¾å¼</label>
                    <input type="text" id="regex-edit-pattern" class="uc-input" placeholder="å¦‚ï¼š\*([^*]+)\*">
                </div>
                <div>
                    <label style="font-size:13px; color:#666; margin-bottom:4px; display:block;">æ›¿æ¢å†…å®¹</label>
                    <input type="text" id="regex-edit-replace" class="uc-input" placeholder="å¦‚ï¼š$1 (ç•™ç©ºåˆ™åˆ é™¤åŒ¹é…)">
                </div>
                <div style="display:flex; gap:20px; align-items:center; padding:4px 0;">
                    <label
                        style="display:flex; align-items:center; gap:6px; font-size:13px; color:#333; cursor:pointer;">
                        <input type="checkbox" id="regex-edit-user" style="width:16px; height:16px;"> userè¾“å…¥
                    </label>
                    <label
                        style="display:flex; align-items:center; gap:6px; font-size:13px; color:#333; cursor:pointer;">
                        <input type="checkbox" id="regex-edit-ai" checked style="width:16px; height:16px;"> AIè¾“å‡º
                    </label>
                </div>
            </div>
            <div class="modal-actions" style="justify-content: flex-end; gap: 10px; margin-top:15px;">
                <button class="modal-btn" onclick="closeRegexEditModal()"
                    style="background:#f5f5f5; color:#333;">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="saveRegexRule()">ä¿å­˜</button>
            </div>
        </div>
    </div>

</body>

</html>
