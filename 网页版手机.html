<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>fayeå°æ‰‹æœº</title>
<!-- å¼•å…¥ Google Fonts æ‰‹å†™å­—ä½“ -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
<style>
/* CSSå˜é‡å®šä¹‰ */
:root {
--interface-bg: rgba(247, 247, 247, 0.6);
--msg-name-color: #999999;
--msg-time-color: #b0b0b0;
}

/* CSSæ ·å¼ */
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
display: flex;
justify-content: center;
align-items: center;
margin: 0;
background-color: transparent;
user-select: none;
-webkit-user-select: none;
min-height: 100vh;
overflow: hidden;
}

/* æ‰‹æœºå®¹å™¨ */
#phone-container {
opacity: 0; /* é»˜è®¤éšè—ï¼Œé˜²æ­¢é—ªçƒ */
width: 330px;
height: 660px;
max-width: 95vw;
max-height: 95vh;
border: 8px solid #707070; 
border-radius: 42px;
background: #fff; /* é»˜è®¤ç™½è‰²èƒŒæ™¯ï¼Œé˜²æ­¢åŠ è½½æ—¶é—ªé»‘ */
background-size: cover;
background-position: center;
box-shadow:
inset 0 0 0 2px rgba(0,0,0,0.1),
0 20px 50px rgba(0, 0, 0, 0.3);
display: flex;
flex-direction: column;
overflow: hidden;
position: relative;
transition: width 0.3s, height 0.3s, border-color 0.3s, opacity 0.5s ease-in;
box-sizing: content-box;
}

/* Home Indicator */
#home-indicator {
    position: absolute;
    bottom: 5px;
    left: 50%;
    transform: translateX(-50%);
    width: 130px;
    height: 3px; /* æ›´ç»† */
    background-color: #000;
    border-radius: 10px;
    z-index: 200;
    pointer-events: none;
}

/* --- çµåŠ¨å²› --- */
.status-bar {
position: absolute; top: 0; left: 0; width: 100%; height: 50px;
display: flex; justify-content: space-between; align-items: flex-start;
padding-top: 14px; padding-left: 26px; padding-right: 26px; box-sizing: border-box;
z-index: 100; font-size: 14px; font-weight: 600; pointer-events: none; transition: color 0.3s;
}
.status-bar.text-dark { color: #000; } .status-bar.text-dark svg { fill: #000; }
.status-bar.text-light { color: #fff; } .status-bar.text-light svg { fill: #fff; }
.sb-left { width: 60px; text-align: center; }
.sb-right { width: 60px; display: flex; justify-content: center; align-items: center; gap: 6px; }
.dynamic-island {
width: 96px; height: 28px; background-color: #000; border-radius: 14px;
position: absolute; left: 50%; top: 10px; transform: translateX(-50%); z-index: 101;
display: flex; justify-content: flex-end; align-items: center; padding-right: 10px; pointer-events: auto;
}
.island-camera {
width: 10px; height: 10px; background: #1a1a1a; border-radius: 50%;
box-shadow: inset 0 0 3px rgba(255,255,255,0.2);
}

/* --- å±å¹•ç®¡ç† --- */
.screen {
flex: 1; display: none; flex-direction: column; width: 100%; height: 100%;
position: absolute; top: 0; left: 0; background-size: cover; background-position: center;
transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1), opacity 0.4s, filter 0.4s;
overflow: hidden;
background-color: #fff;
/* ä¿®å¤çª„å±ä¸‹é¡µé¢å·¦å³æ™ƒåŠ¨çš„é—®é¢˜ */
overflow-x: hidden;
box-sizing: border-box;
}
#home-screen {
 
    z-index: 1; padding-top: 0;
    align-items: center;
    overflow-x: hidden;
    width: 100%;
    justify-content: center;
    background-color: #f3e5f5;
    /* é»˜è®¤éšè—ï¼Œç­‰å¾…JSåˆå§‹åŒ– */
    opacity: 1;
    display: none;
}

/* ç§»é™¤.slide-out åŠ¨ç”» */

/* ä¸»å±å¹•æ—¶é—´ */
#home-clock {
font-family: 'Dancing Script', 'Ma Shan Zheng', cursive, sans-serif;
font-size: 60px;
letter-spacing: 4px;
color: #4a3b5e;
margin-bottom: 80px;
font-weight: normal;
text-shadow: 0 2px 5px rgba(0,0,0,0.1);
z-index: 5;
}

/* å­é¡µé¢ */
#message-list-screen {
    z-index: 8;
    box-shadow: -5px 0 15px rgba(0,0,0,0.05);
    background-color: #fff;
}

/* Right side sliders */
#chat-screen, #dark-search-screen {
    z-index: 10;
    box-shadow: -5px 0 15px rgba(0,0,0,0.05);
    background-color: var(--interface-bg, #fff);
}

#chat-settings-screen {
    z-index: 20; /* Ensure it covers the chat screen */
    box-shadow: -5px 0 15px rgba(0,0,0,0.05);
    background-color: var(--interface-bg, #fdf6f9);
}

/* Left side sliders */
#settings-screen, #diary-screen {
    z-index: 10;
    box-shadow: 5px 0 15px rgba(0,0,0,0.05);
}

/* ç§»é™¤ visible çŠ¶æ€åŠ¨ç”» */

/* Message List Styles */
.message-list-body {
flex: 1;
background: #fff;
overflow-y: auto;
}
.message-list-item {
display: flex;
padding: 12px 15px;
border-bottom: 1px solid #f0f0f0;
cursor: pointer;
align-items: center;
transition: background-color 0.2s;
}
.message-list-item:active {
background-color: #f5f5f5;
}
.message-list-avatar {
width: 48px;
height: 48px;
border-radius: 6px;
margin-right: 12px;
object-fit: cover;
background-color: #eee;
}
.message-list-info {
flex: 1;
display: flex;
flex-direction: column;
justify-content: center;
overflow: hidden;
}
.message-list-top {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 4px;
}
.message-list-name {
font-size: 16px;
font-weight: 500;
color: #333;
}
.message-list-time {
font-size: 12px;
color: #999;
}
.message-list-preview {
font-size: 14px;
color: #999;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

.app-grid {
display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px 15px; padding: 0 24px; width: 100%; box-sizing: border-box;
margin-bottom: 50px;
}
.app-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; position: relative; }
.app-item:active { opacity: 0.7; transform: scale(0.95); transition: 0.1s; }
.app-icon-box {
width: 58px; height: 58px; border-radius: 16px; display: flex; align-items: center; justify-content: center;
background: #e6e6fa;
transition: background 0.3s;
box-shadow: none;
opacity: 0.72;
}
.app-icon-box svg { width: 32px; height: 32px; transition: fill 0.3s; fill: #483d8b; }
.app-icon-image {
width: 32px; height: 32px;
background-color: #483d8b;
-webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center;
mask-size: contain; mask-repeat: no-repeat; mask-position: center;
transition: background-color 0.3s;
}
.app-name { font-size: 12px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.3); color: #4a3b5e; }

/* Header */
.app-header {
    height: 80px; padding-top: 40px;
    display: flex; align-items: center;
    padding-left: 15px; padding-right: 15px;
    /* é»˜è®¤èƒŒæ™¯è‰² */
    background-color: #fff;
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(0,0,0,0.05);
    flex-shrink: 0; z-index: 10; box-sizing: border-box;
    transition: background-color 0.3s;
}

/* èŠå¤©ç›¸å…³é¡µé¢çš„ header ç”¨ interface-bg */
#chat-screen .app-header {
    background-color: var(--interface-bg);
}
#chat-settings-screen .app-header {
    background-color: #fff;
}
.header-content { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; position: relative; }
.header-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: flex-start; cursor: pointer; position: absolute; left: 0; }
.header-btn-right { left: auto; right: 0; justify-content: flex-end; }
.header-btn svg { width: 24px; height: 24px; fill: #181818; }
.header-title { font-size: 17px; font-weight: 600; color: #181818; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; max-width: 70%; }

/* Chat Area */
#chat-messages {
flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
scroll-behavior: smooth; scrollbar-width: none;
}
#chat-messages::-webkit-scrollbar { display: none; }

.settings-body {
flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
background: #f2f2f7;
}
.settings-body::-webkit-scrollbar { display: none; }

/* Blocked Status Icon */
.msg-status-blocked {
    color: #ff3b30;
    font-size: 17px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: help;
    flex-shrink: 0;
    line-height: 1.2;
}

/* Message Meta Container (Time + Status) */
.msg-meta {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    gap: 1px;
    margin-bottom: 0px;
}
/* Adjust margins for meta container based on sender */
.message-row.sent .msg-meta { margin-right: 2px; }
.message-row.received .msg-meta { margin-left: 2px; }

/* Toggle Switch */
.switch { position: relative; display: inline-block; width: 40px; height: 20px; vertical-align: middle; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #2196F3; }
input:focus + .slider { box-shadow: 0 0 1px #2196F3; }
input:checked + .slider:before { transform: translateX(20px); }

/* Add Contact Styles */
.contact-type-tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 15px; padding-bottom: 5px; }
.contact-type-tabs .tab { flex: 1; text-align: center; padding: 8px; cursor: pointer; color: #999; font-size: 14px; position: relative; transition: color 0.3s; }
.contact-type-tabs .tab.active { color: #333; font-weight: bold; }
.contact-type-tabs .tab.active::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background: #07c160; border-radius: 2px; }
.group-input-item { margin-top: 8px; }

/* Avatar Grid in Settings */
.avatar-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px 10px;
    padding: 10px 0;
}
.avatar-grid-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}
.avatar-sq {
    width: 48px;
    height: 48px;
    border-radius: 12px; /* Rounded Square */
    object-fit: cover;
    background: #eee;
    border: 1px solid #ddd;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.1s;
}
.avatar-sq:active { transform: scale(0.95); }
.avatar-name {
    font-size: 11px;
    color: #666;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
}

/* Message Styles */
/* Love Effect */
.love-effect-container {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 999;
}
.love-heart {
    position: absolute; bottom: -20px; font-size: 24px; animation: floatUp 4s ease-in-out forwards; opacity: 0;
}
/* Typing indicator without avatar: make bubble align like received messages */
.typing-only { margin-left: 0; border-radius: 12px; }

/* Group badge near name: 5px spacing and slight upward offset */
.group-badge { font-size:10px; color:#999; background:#f0f0f0; padding:1px 4px; border-radius:4px; margin-left:5px; position:relative; top:-1px; }
@keyframes floatUp {
    0% { transform: translateY(0) scale(0.5); opacity: 0; }
    10% { opacity: 1; }
    100% { transform: translateY(-600px) scale(1.5); opacity: 0; }
}

/* Group input button styles */
.group-add-btn, .group-remove-btn {
    transition: background 0.12s ease, transform 0.08s ease;
}
.group-add-btn:hover, .group-remove-btn:hover {
    background: rgba(0,0,0,0.03);
}
.group-add-btn:active, .group-remove-btn:active {
    transform: scale(0.96);
}

/* é€šè¯é¡µé¢æ ·å¼ */
#call-screen, #incoming-call-screen {
    display: none; /* é»˜è®¤éšè—ï¼Œé˜²æ­¢é—ªçƒ */
    transition: none !important;
    background: linear-gradient(180deg, #2b2b2b 0%, #1a1a1a 100%);
    color: #fff;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    padding: 60px 20px 40px 20px;
    z-index: 100;
    box-sizing: border-box;
}
#incoming-call-screen {
    padding-bottom: 80px;
    z-index: 110;
}

/* æ¶ˆæ¯è¡Œå®¹å™¨ï¼šåŒ…å«å¤´åƒã€æ¶ˆæ¯å†…å®¹ã€æ—¶é—´ç­‰ */
.message-row { display: flex; align-items: flex-start; gap: 8px; width: 100%; flex-shrink: 0; }
/* å‘é€æ–¹ï¼ˆå³ä¾§ï¼‰æ ·å¼ */
.message-row.sent { flex-direction: row-reverse; }
/* æ¥æ”¶æ–¹ï¼ˆå·¦ä¾§ï¼‰æ ·å¼ */
.message-row.received { flex-direction: row; }
/* å¤´åƒæ ·å¼ */
.avatar { width: 38px; height: 38px; border-radius: 6px; background-color: #e0e0e0; object-fit: cover; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.05); margin-top: 0; }

/* æ¶ˆæ¯å†…å®¹å®¹å™¨ï¼šåŒ…å«åå­—ã€æ°”æ³¡ã€å¿ƒå£°ç­‰ */
.msg-container { display: flex; flex-direction: column; max-width: 65%; }
.message-row.sent .msg-container { align-items: flex-end; }
.message-row.received .msg-container { align-items: flex-start; }

/* åå­—æ ·å¼ */
.msg-name {
font-size: 12px; color: var(--msg-name-color);
margin: 0 2px 2px 2px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

/* æ°”æ³¡å’Œæ—¶é—´çš„åŒ…è£…å™¨ */
.msg-wrapper {
display: flex; flex-direction: row; align-items: flex-end; gap: 3px; margin-top: 2px;
}
.message-row.sent .msg-wrapper { flex-direction: row-reverse; }
.message-row.received .msg-wrapper { flex-direction: row; }

/* å¿ƒå£°æ°”æ³¡æ ·å¼ */
.msg-thought {
font-size: 12px; color: #333; background-color: rgba(200, 200, 200, 0.5);
border-radius: 14px; padding: 4px 8px; margin-top: 0; 
line-height: 1.3; word-wrap: break-word; max-width: 100%; box-sizing: border-box;
text-align: left;
}

/* æ‰€æœ‰æ°”æ³¡ç±»å‹çš„é€šç”¨æ ·å¼ */
.bubble, .location-card, .transfer-card, .file-card, .voice-card, .photo-card, .sticker-bubble, .real-audio-card {
flex-shrink: 0; cursor: pointer; position: relative; transition: transform 0.1s; max-width: 100%;
}
/* æŒ‰å‹æ•ˆæœ */
.bubble.pressing, .location-card.pressing, .transfer-card.pressing, .file-card.pressing, .voice-card.pressing, .photo-card.pressing, .sticker-bubble.pressing, .real-audio-card.pressing {
transform: scale(0.98); filter: brightness(0.95);
}

/* æ™®é€šæ–‡æœ¬æ°”æ³¡æ ·å¼ */
.bubble {
    padding: 7px 14px; border-radius: 18px; line-height: 1.5;
    word-break: break-word;
    white-space: pre-line;
    font-size: var(--msg-font-size, 14px);
    opacity: 0.8;
}
/* å‘é€æ–¹æ–‡æœ¬æ°”æ³¡ */
.bubble-sent {
background: #dcd0ff; color: #000; border-top-right-radius: 0px;
}
/* æ¥æ”¶æ–¹æ–‡æœ¬æ°”æ³¡ */
.bubble-received {
background: #ffffff; color: #000; box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05); border-top-left-radius: 0px;
}

/* æ¶ˆæ¯æ—¶é—´æ ·å¼ */
.msg-time {
font-size: 10px; color: var(--msg-time-color); line-height: 1; user-select: none; padding: 0 2px; margin-bottom: 0px; flex-shrink: 0; min-width: 28px;
}
.message-row.sent .msg-time { text-align: right; }
.message-row.received .msg-time { text-align: left; }

/* å›¾ç‰‡/è§†é¢‘å¡ç‰‡æ ·å¼ */
.photo-card { border-radius: 18px; padding: 6px; overflow: visible; box-shadow: 0 2px 3px rgba(0,0,0,0.1); font-size: 0; max-width: 160px; width: 100%; box-sizing: border-box; }
.photo-card.sent { border-top-right-radius: 0px; }
.photo-card.received { border-top-left-radius: 0px; }
.photo-card img { width: 100%; height: auto; display: block; border-radius: 12px; }

/* è¡¨æƒ…åŒ…æ°”æ³¡æ ·å¼ */
.sticker-bubble { border-radius: 14px; overflow: visible; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0; max-width: 100px; }
.sticker-bubble img { width: 100%; height: auto; display: block; border-radius: 14px; }

/* æ¨¡æ‹Ÿè¯­éŸ³å¡ç‰‡æ ·å¼ */
.voice-card {
    padding: 7px 6px; border-radius: 18px; display: flex; flex-direction: column; gap: 3px; min-width: 18px; position: relative;
    word-break: break-word;
    white-space: normal;
}
.voice-card.sent { background: #dcd0ff; color: #000; border-top-right-radius: 0px; }
.voice-card.received { background: #ffffff; color: #000; box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05); border-top-left-radius: 0px; }
.voice-bar { display: flex; align-items: center; gap: 6px; height: 20px; padding: 0; margin: 0; }
.voice-card.sent .voice-bar { flex-direction: row-reverse; }
.voice-duration { font-size: 14px; font-weight: 500; min-width: 12px; padding: 0 3px; text-align: center; }
.voice-waves { display: flex; align-items: center; gap: 2.5px; height: 100%; justify-content: flex-start; overflow: hidden; margin: 0; }
.wave { width: 2px; background-color: currentColor; border-radius: 2px; opacity: 0.7; }
.voice-text {
    font-size: 13px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1); display: none;
    white-space: normal; line-height: 1.4; text-align: left; word-break: break-word; overflow-wrap: anywhere;
    width: 100%;
}
.voice-card.show-text .voice-text { display: block; max-height: 400px; overflow: auto; }
.voice-card.sent .voice-text { text-align: right; }

/* çœŸå®éŸ³é¢‘å¡ç‰‡æ ·å¼ */
.real-audio-card {
padding: 5px; border-radius: 18px; display: flex; align-items: center; justify-content: center;
background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); overflow: hidden; max-width: 220px;
}
.real-audio-card audio {
max-width: 100%; height: 32px;
}
.real-audio-card.sent { border-top-right-radius: 0px; background: #dcd0ff; }
.real-audio-card.received { border-top-left-radius: 0px; background: #ffffff; }

/* ä½ç½®ã€è½¬è´¦ã€æ–‡ä»¶å¡ç‰‡é€šç”¨æ ·å¼ */
.location-card, .transfer-card, .file-card { width: 200px; overflow: visible; }
/* ä½ç½®å¡ç‰‡ */
.location-card { background: white; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #eee; }
.location-info { padding: 8px 10px; background: #fff; border-top-left-radius: 6px; border-top-right-radius: 6px; }
.location-name { font-size: 13px; color: #333; font-weight: 500; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.location-map { width: 100%; height: 60px; background-color: #f2f2f2; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="220" height="90" viewBox="0 0 220 90"><rect width="220" height="90" fill="%23f2f2f2"/><path d="M-10,30 Q50,10 110,30 T230,30" stroke="%23ddd" stroke-width="6" fill="none"/><path d="M30,90 Q60,50 90,90" stroke="%23ddd" stroke-width="6" fill="none"/><path d="M150,0 Q180,40 210,0" stroke="%23ddd" stroke-width="6" fill="none"/><circle cx="110" cy="45" r="4" fill="%23ea4e3d"/></svg>'); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }
.location-pin { width: 20px; height: 20px; fill: #ea4e3d; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); margin-bottom: 8px; }

/* è½¬è´¦å¡ç‰‡ */
.transfer-card { background: #ffacac; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.transfer-top { padding: 12px; display: flex; align-items: center; gap: 10px; border-top-left-radius: 6px; border-top-right-radius: 6px; }
.transfer-icon-circle { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.transfer-icon-circle svg { width: 20px; height: 20px; stroke: #fff; stroke-width: 2; fill: none; }
.transfer-content { flex: 1; color: #fff; display: flex; flex-direction: column; overflow: hidden; }
.transfer-amount { font-size: 15px; font-weight: bold; }
.transfer-note { font-size: 11px; opacity: 0.9; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.transfer-bottom { background: #fff; padding: 4px 12px; font-size: 10px; color: #999; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }

/* æ–‡ä»¶å¡ç‰‡ */
.file-card { background: white; border-radius: 6px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; border: 1px solid #eee; }
.file-info { flex: 1; overflow: hidden; }
.file-name { font-size: 13px; color: #333; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; word-break: break-all; }
.file-size { font-size: 9px; color: #999; margin-top: 3px; }
.file-icon { width: 34px; height: 34px; flex-shrink: 0; }
.file-icon svg { width: 100%; height: 100%; fill: #ddd; }

/* Media Preview Bar */
#media-preview-bar {
    display: none; padding: 8px 12px;
    background: #fff;
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(0,0,0,0.05);
    flex-shrink: 0; z-index: 10;
    align-items: center;
}
#chat-screen #media-preview-bar,
#chat-settings-screen #media-preview-bar {
    background: var(--interface-bg);
}
#media-preview-bar.visible { display: flex; }
.preview-item {
position: relative; width: 60px; height: 60px;
background: #fff; border-radius: 8px; border: 1px solid #ddd;
display: flex; align-items: center; justify-content: center;
overflow: visible;
}
.preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
.preview-file-icon { font-size: 24px; }
.preview-close {
position: absolute; top: -6px; right: -6px;
width: 18px; height: 18px; background: #ff5555; color: white;
border-radius: 50%; font-size: 12px; line-height: 16px; text-align: center;
cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
font-weight: bold;
}

/* Input Bar */
#input-bar {
    display: flex; padding: 2px 5px 10px 5px;
    border-top: none; /* No white line */
    background-color: #fff;
    backdrop-filter: blur(10px);
    align-items: flex-end; flex-shrink: 0; z-index: 10;
    /* å‡å°è¾“å…¥æ¡†ä¸ä¸Šè¾¹ç¼˜é—´éš™ */
    padding-bottom: 10px;
    transition: background-color 0.3s;
}

#chat-screen #input-bar {
    background-color: var(--interface-bg);
}
#chat-settings-screen #input-bar {
    background-color: #fff;
}
#input-bar textarea {
    margin-top: 5px;
    flex: 1; border: none; border-radius: 15px; padding: 8px 10px;
    font-size: 15px; resize: none; max-height: 80px; outline: none; min-height: 20px;
    background: rgba(245, 245, 245, 0.9); color: #000;
    margin-right: 4px;
    scrollbar-width: none; /* Firefox */
    overflow-y: auto;
    box-sizing: border-box;
    /* éšè—æ»šåŠ¨æ¡ */
    -ms-overflow-style: none; /* IE and Edge */
    scrollbar-width: none; /* Firefox */
}
#input-bar textarea::-webkit-scrollbar {
    display: none;
}
#input-bar textarea::-webkit-scrollbar { display: none; } /* Chrome/Safari */

.toolbar-btn {
background: transparent; color: var(--chat-btn-text, #333); border: none;
width: 30px; height: 30px;
display: flex; align-items: center; justify-content: center; flex-shrink: 0;
cursor: pointer; transition: background 0.2s;
margin-bottom: 2px; border-radius: 6px;
}
.toolbar-btn:hover { opacity: 0.9; }
.toolbar-btn svg { width: 22px; height: 22px; stroke: var(--chat-btn-text, #580000); stroke-width: 1.5; fill: none; transition: stroke 0.2s; }
.toolbar-btn.active svg { transform: rotate(45deg); }

#plus-button { margin-right: 0px; padding: 0; }
#emoji-button { margin-left: 0px; margin-right: 4px; }

#send-button {
background: transparent; color: var(--chat-btn-text, #ffffff); border-radius: 6px;
height: 32px; padding: 0 12px; font-size: 15px; font-weight: 600;
margin-left: 0px; margin-bottom: 3px; width: auto;
display: flex; align-items: center; justify-content: center;
border: none; cursor: pointer; transition: background 0.2s; flex-shrink: 0;
}
#send-button:hover { opacity: 0.9; }

/* Menus */
#action-menu, #emoji-menu {
height: 0; background: #f7f7f7; border-top: none; transition: height 0.2s ease; overflow: hidden;
flex-shrink: 0; z-index: 10;
}
#action-menu { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 0 20px; }
#action-menu.open { height: 220px; padding: 25px 20px; border-top: 1px solid #e5e5e5; }
#emoji-menu { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 0 12px; overflow-y: auto; box-sizing: border-box; align-content: flex-start; justify-items: center; }
#emoji-menu.open { height: 220px; padding: 15px 12px; border-top: 1px solid #e5e5e5; }
#emoji-menu::-webkit-scrollbar { display: none; }

.action-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; color: #666; font-size: 12px; }
.action-icon-box { width: 55px; height: 55px; background: #fff; border-radius: 16px; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e5e5; }

.sticker-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; }
.sticker-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #fff; }
.sticker-add-btn { width: 60px; height: 60px; border-radius: 8px; background: #f7f7f7; display: flex; align-items: center; justify-content: center; border: 1px dashed #ccc; box-sizing: border-box; }
.sticker-add-btn svg { width: 28px; height: 28px; fill: #999; }
.sticker-name { font-size: 10px; color: #666; margin-top: 4px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

/* Modals */
.modal-overlay {
position: absolute; top: 0; left: 0; right: 0; bottom: 0;
background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center;
z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
#input-modal { z-index: 210; } /* Ensure input modal is on top */
.modal-overlay.show { opacity: 1; pointer-events: auto; }
.modal-box {
box-sizing: border-box;
width: 85%; max-width: 300px; background: #fff; border-radius: 12px; padding: 20px;
box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 15px;
transform: scale(0.9); transition: transform 0.2s; max-height: 70%; overflow-y: auto; scrollbar-width: none;
}
.modal-overlay.show .modal-box { transform: scale(1); }
.modal-title { font-size: 18px; font-weight: bold; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 5px; }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
.modal-btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; border: none; font-weight: 500; }
.btn-cancel { background: #f0f0f0; color: #333; }
.btn-confirm { background: #07c160; color: white; }
.btn-grey { background: #e5e5e5; color: #333; } .btn-grey:active { background: #d1d1d1; }

#modal-inputs-container { display: flex; flex-direction: column; gap: 12px; }
.modal-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; outline: none; }
.modal-input:focus { border-color: #07c160; }

/* Settings UI */
.settings-body {
flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;
background: #fdf6f9; /* å¯çˆ±ç²‰è‰²èƒŒæ™¯ */
}
.settings-body::-webkit-scrollbar { display: none; }

.settings-section-title {
display: block;
font-size: 13px;
color: #999;
margin-left: 12px;
margin-bottom: 8px;
font-weight: 600;
letter-spacing: 0.5px;
}

.setting-group {
background: #fff;
border-radius: 18px;
padding: 0;
display: flex;
flex-direction: column;
border: 1px solid rgba(0,0,0,0.02);
overflow: hidden;
box-shadow: 0 2px 10px rgba(0,0,0,0.02);
}
.setting-group.no-border { border: none; }

.setting-row {
display: grid; grid-template-columns: 1fr auto; align-items: center; font-size: 15px; color: #333; gap: 10px;
padding: 16px 18px; border-bottom: 1px solid #f7f7f7;
}
.settings-footer {
padding: 20px; background: #fff; border-top: 1px solid #eee;
flex-shrink: 0; z-index: 10;
}
.btn-save {
background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
color: #fff;
border: none;
font-weight: 600;
box-shadow: 0 4px 12px rgba(255, 154, 158, 0.4);
transition: transform 0.1s, box-shadow 0.1s;
}
.btn-save:active {
transform: scale(0.98);
box-shadow: 0 2px 6px rgba(255, 154, 158, 0.3);
}

.setting-row:last-child { border-bottom: none; }
.setting-row > div { display: flex; align-items: center; gap: 8px; justify-content: flex-end; }
.color-picker { width: 28px; height: 28px; border: 1px solid #ddd; padding: 0; border-radius: 50%; overflow: hidden; cursor: pointer; }
.color-picker::-webkit-color-swatch-wrapper { padding: 0; }
.color-picker::-webkit-color-swatch { border: none; border-radius: 50%; }
.setting-input-sm { width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
.file-upload-label {
font-size: 12px; background: #f2f2f7; border: 1px solid #ddd; padding: 5px 10px;
border-radius: 14px; cursor: pointer; display: inline-flex; align-items: center;
transition: background 0.2s; appearance: none; color: #333; font-family: inherit;
}
.file-upload-label:active { background: #e5e5ea; }
.file-upload-input { display: none; }
.preview-img { width: 32px; height: 32px; border-radius: 6px; object-fit: cover; background: #eee; border: 1px solid #ddd; }

.delete-btn {
position: absolute; top: -6px; right: -6px; width: 18px; height: 18px;
background-color: #c0c0c0; color: #fff; border-radius: 50%;
display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10;
}
.delete-btn svg { width: 10px; height: 10px; stroke: currentColor; stroke-width: 3; }
.typing-dots span {
display: inline-block; width: 6px; height: 6px; background-color: #888;
border-radius: 50%; margin: 0 2px; animation: typing 1.4s infinite ease-in-out both;
}
.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }
@keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
.dark-result-item {
    border-bottom: 1px solid #333;
    padding: 10px 0;
    color: #ff69b4;
    font-family: monospace;
    animation: fadeIn 0.5s ease;
}
.dark-result-content {
    font-size: 14px;
    margin-bottom: 4px;
    word-break: break-all;
}
.dark-result-time {
    font-size: 10px;
    color: #880044;
    text-align: right;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0"
  }
}
</script>
</head>
<body>
<div id="phone-container">
<div id="home-indicator"></div>
<div class="status-bar text-dark" id="status-bar">
<div class="sb-left" id="clock">12:00</div>
<div class="dynamic-island"><div class="island-camera"></div></div>
<div class="sb-right">
<svg width="22" height="11" viewBox="0 0 22 11" fill="currentColor">
<path d="M4 5 l1.5 2.5 h-3 z" />
<path d="M4 11 l-1.5 -2.5 h3 z" />
<path d="M7 5.5h2v6H7v-6zm4-3h2v9H11v-9zm4-3h2v12h-2V-.5z"></path>
</svg>
<svg width="22" height="11" viewBox="0 0 25 11" fill="currentColor"><rect x="0.5" y="0.5" width="20" height="10" rx="2.5" stroke="currentColor"></rect><path d="M23 4v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path><rect x="2.5" y="2.5" width="16" height="6" rx="1" fill="currentColor"></rect></svg>
</div>
</div>
<div id="home-screen" class="screen">
<div id="home-clock">12:00</div>
<div class="app-grid">
<div class="app-item" onclick="openMessageList()">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/basil:wechat-solid.svg'); mask-image: url('https://api.iconify.design/basil:wechat-solid.svg');"></div></div>
<span class="app-name">èŠå¤©</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/simple-icons:qzone.svg'); mask-image: url('https://api.iconify.design/simple-icons:qzone.svg');"></div></div>
<span class="app-name">æœ‹å‹åœˆ</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/material-symbols:forum-rounded.svg'); mask-image: url('https://api.iconify.design/material-symbols:forum-rounded.svg');"></div></div>
<span class="app-name">è®ºå›</span>
</div>
<div class="app-item" onclick="openDarkSearch()">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/mingcute:search-3-line.svg'); mask-image: url('https://api.iconify.design/mingcute:search-3-line.svg');"></div></div>
<span class="app-name">æš—ç½‘æœç´¢</span>
</div>
<div class="app-item" onclick="openDiary()">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/ri:booklet-line.svg'); mask-image: url('https://api.iconify.design/ri:booklet-line.svg');"></div></div>
<span class="app-name">æ—¥è®°</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('https://api.iconify.design/fa-brands:discord.svg'); mask-image: url('https://api.iconify.design/fa-brands:discord.svg');"></div></div>
<span class="app-name">Discord</span>
</div>
<div class="app-item">
<div class="app-icon-box app-icon-style"><div class="app-icon-image" style="-webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\'><text x=\'50%25\' y=\'50%25\' dy=\'.35em\' font-family=\'Arial\' font-weight=\'900\' font-size=\'14\' text-anchor=\'middle\'>ST</text></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\'><text x=\'50%25\' y=\'50%25\' dy=\'.35em\' font-family=\'Arial\' font-weight=\'900\' font-size=\'14\' text-anchor=\'middle\'>ST</text></svg>');"></div></div>
<span class="app-name">SillyTavern</span>
</div>
<div class="app-item" onclick="openSettings()">
<div class="app-icon-box app-icon-style"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L3.16 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"></path></svg></div>
<span class="app-name">è®¾ç½®</span>
</div>
</div>
</div>
<div id="message-list-screen" class="screen">
<div class="app-header">
<div class="header-content">
<div class="header-btn" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title">æ¶ˆæ¯</span>
<div class="header-btn header-btn-right" onclick="openAddContactModal()"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="#181818" stroke-width="2" stroke-linecap="round"></path></svg></div>
</div>
</div>
<div class="message-list-body" id="message-list-body">
<!-- åˆ—è¡¨é¡¹å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
</div>
</div>
<div id="chat-screen" class="screen">
<div class="app-header">
<div class="header-content">
<div class="header-btn" onclick="goBack()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title" id="header-title">{{char}}</span>
<div class="header-btn header-btn-right" onclick="openChatSettings()"><svg viewBox="0 0 24 24"><circle cx="6" cy="12" r="1.6" fill="#181818"></circle><circle cx="12" cy="12" r="1.6" fill="#181818"></circle><circle cx="18" cy="12" r="1.6" fill="#181818"></circle></svg></div>
</div>
</div>
<div id="chat-messages"></div>
<div id="love-effect-layer" class="love-effect-container"></div>

<!-- åª’ä½“é¢„è§ˆæ¡ -->
<div id="media-preview-bar">
    <div class="preview-item">
        <img id="preview-image" src="" style="display:none">
        <div id="preview-file-icon" class="preview-file-icon" style="display:none">ğŸµ</div>
        <div class="preview-close" onclick="clearPreview()">Ã—</div>
    </div>
</div>

<div id="input-bar">
<button id="plus-button" class="toolbar-btn" title="æ›´å¤šåŠŸèƒ½"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke-linecap="round" stroke-linejoin="round"></path></svg></button>
<button id="emoji-button" class="toolbar-btn"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9" stroke-width="2" stroke-linecap="round"></line><line x1="15" y1="9" x2="15.01" y2="9" stroke-width="2" stroke-linecap="round"></line></svg></button>
<textarea id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
<button id="send-button">å‘é€</button>
</div>
<input type="file" id="photo-upload-input" accept="image/*" style="display: none;">
<input type="file" id="audio-upload-input" accept="audio/*" style="display: none;">
<input type="file" id="video-upload-input" accept="video/*" style="display: none;">
<input type="file" id="settings-file-input" accept="image/*" style="display: none;">
<div id="action-menu">
<div class="action-item" onclick="handleAction('photo')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div><span>ç…§ç‰‡</span></div>
<div class="action-item" onclick="handleAction('voice')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div><span>è¯­éŸ³</span></div>
<div class="action-item" onclick="handleAction('call')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></div><span>é€šè¯</span></div>
<div class="action-item" onclick="handleAction('camera')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg></div><span>ç›¸æœº</span></div>
<div class="action-item" onclick="handleAction('location')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg></div><span>ä½ç½®</span></div>
<div class="action-item" onclick="handleAction('transfer')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M7 10h14l-4-4"></path><path d="M17 14H3l4 4"></path></svg></div><span>è½¬è´¦</span></div>
<div class="action-item" onclick="handleAction('file')"><div class="action-icon-box"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></div><span>æ–‡ä»¶</span></div>
</div>
<div id="emoji-menu"></div>
</div>
<div id="settings-screen" class="screen">
<div class="app-header">
<div class="header-content">
<div class="header-btn" onclick="closeSettings()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title">æ‰‹æœºè®¾ç½®</span>
</div>
</div>
<div class="settings-body">
    <!-- å¤–è§‚ -->
    <div>
        <div class="settings-section-title">å¤–è§‚</div>
        <div class="setting-group">
            <div class="setting-row"><label>æ‰‹æœº (å®½xé«˜)</label> <div><input type="number" id="set-phone-w" class="setting-input-sm" placeholder="350"> x <input type="number" id="set-phone-h" class="setting-input-sm" placeholder="650"></div></div>
            <div class="setting-row"><label>æ‰‹æœºå£³é¢œè‰²</label> <input type="color" id="set-case-color" class="color-picker"></div>
        </div>
    </div>

    <!-- ä¸ªæ€§åŒ– -->
    <div>
        <div class="settings-section-title">ä¸ªæ€§åŒ–</div>
        <div class="setting-group">
            <div class="setting-row"><label>ä¸»å±å¹•å£çº¸</label> <div><button class="file-upload-label" onclick="triggerSettingsUpload('home-bg')">ä¸Šä¼ å›¾ç‰‡</button> <img id="preview-home-bg" class="preview-img" src=""></div></div>
            <div class="setting-row"><label>è‡ªå®šä¹‰æ—¶é—´</label> <input type="text" id="set-custom-time" class="setting-input-sm" style="width: 80px;" placeholder="HH:MM"></div>
        </div>
    </div>

    <!-- å›¾æ ‡ä¸æ–‡å­— -->
    <div>
        <div class="settings-section-title">å›¾æ ‡ä¸æ–‡å­—</div>
        <div class="setting-group">
            <div class="setting-row"><label>å›¾æ ‡åº•è‰²</label> <input type="color" id="set-icon-bg" class="color-picker"></div>
            <div class="setting-row"><label>å›¾æ ‡å›¾æ¡ˆ</label> <input type="color" id="set-icon-color" class="color-picker"></div>
            <div class="setting-row"><label>å­—ä½“é¢œè‰²</label> <input type="color" id="set-home-text-color" class="color-picker"></div>
        </div>
    </div>

    <!-- AI è®¾ç½® -->
    <div>
        <div class="settings-section-title">AI è®¾ç½®</div>
        <div class="setting-group">
            <div class="setting-row"><label>API åœ°å€</label> <input type="text" id="set-api-url" class="modal-input" style="border:none; text-align:right;" placeholder="https://api.openai.com/v1"></div>
            <div class="setting-row">
                <label>API Key</label> 
                <input type="password" id="set-api-key" class="modal-input" style="border:none; text-align:right; width: 150px;" placeholder="sk-...">
            </div>
            <div class="setting-row"><label>æ¨¡å‹åç§°</label> 
                <select id="set-model-name" class="modal-input" style="border:none; text-align:right; background: transparent; width: 150px;">
                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                </select>
            </div>
            <div class="setting-row" style="display: block; padding: 10px;">
                <button onclick="testApiConnection()" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background: #007aff; color: white; font-size: 14px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;">
                    è¿æ¥æµ‹è¯•
                    <div id="api-status-light" style="width: 8px; height: 8px; border-radius: 50%; background: #ccc; transition: background 0.3s;"></div>
                </button>
            </div>
        </div>
    </div>
</div>
<div class="settings-footer" style="padding: 10px;">
<button class="modal-btn btn-save" style="width: 100%; padding: 8px; border-radius: 12px; font-size: 13px;" onclick="saveHomeSettings()">ä¿å­˜å¹¶åº”ç”¨</button>
</div>
</div>
<div id="dark-search-screen" class="screen" style="background-color: #000; color: #ff69b4;">
<div class="app-header" style="background-color: #111; border-bottom: 1px solid #333;">
<div class="header-content">
<div class="header-btn" onclick="closeDarkSearch()"><svg viewBox="0 0 24 24" style="fill: #ff69b4;"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title" style="color: #ff69b4;">æš—ç½‘æœç´¢</span>
</div>
</div>
<div style="padding: 20px; display: flex; flex-direction: column; gap: 20px; align-items: center; height: 100%; box-sizing: border-box;">
<div style="width: 100%; position: relative; flex-shrink: 0;">
<input type="text" id="dark-search-input" placeholder="è¾“å…¥åå­—æŸ¥çœ‹æœç´¢è®°å½•..." style="width: 100%; padding: 12px 40px 12px 15px; background: #111; border: 1px solid #333; color: #ff69b4; border-radius: 8px; box-sizing: border-box; outline: none;">
<div onclick="searchDarkWeb()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer;">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff69b4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
</div>
</div>
<div id="dark-search-results" style="width: 100%; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
    <div style="font-size: 12px; color: #333; text-align: center; margin-top: 50px;">TOR NETWORK CONNECTED</div>
</div>
</div>
</div>
<div id="diary-screen" class="screen" style="background-color: #fdfbfb; color: #5d4037;">
<div class="app-header" style="background-color: #fdfbfb; border-bottom: 1px solid rgba(0,0,0,0.03);">
<div class="header-content">
<div class="header-btn" onclick="closeDiary()"><svg viewBox="0 0 24 24" style="fill: #8d6e63;"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title" style="color: #8d6e63; font-family: 'Ma Shan Zheng', cursive;">ç§å¯†æ—¥è®°</span>
</div>
</div>
<div id="diary-scroll-container" style="padding: 20px; display: flex; flex-direction: column; height: 100%; box-sizing: border-box; overflow-y: auto; scrollbar-width: none;">
<style>
#diary-scroll-container::-webkit-scrollbar { display: none; }
.diary-card {
    background: #fff;
    padding: 15px 20px;
    border-radius: 8px;
    border: 1px solid #f0f0f0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    margin-bottom: 15px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s;
}
.diary-card:active { transform: scale(0.99); }
.diary-header {
    display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; color: #999;
    padding-bottom: 5px;
    border-bottom: 2px solid #f5f5f5;
}
.diary-date { font-weight: bold; color: #d4a5a5; font-family: 'Ma Shan Zheng', cursive; font-size: 15px; }
.diary-weather { background: #f5f5f5; color: #888; padding: 1px 6px; border-radius: 4px; font-size: 10px; height: fit-content; }
.diary-body { 
    font-size: 15px; 
    line-height: 28px; 
    color: #666; 
    background-image: url("data:image/svg+xml;utf8,<svg width='12' height='28' xmlns='http://www.w3.org/2000/svg'><rect x='0' y='27' width='6' height='1' fill='%23e0e0e0'/></svg>");
    background-attachment: local;
    word-break: break-all;
    text-align: justify;
}
.diary-body p { margin: 0; }
</style>
<div id="diary-lock-container" style="flex: 1; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 20px;">
<div style="color: #d4a5a5; font-size: 14px; font-family: 'Ma Shan Zheng', cursive;">æŸ¥çœ‹ <input type="text" id="diary-target-name" placeholder="åå­—" style="border:none; border-bottom:1px solid #d4a5a5; width:60px; text-align:center; color:#8d6e63; font-family:inherit; background:transparent; outline:none;"> çš„æ—¥è®°</div>
<div onclick="generateDiary()" style="cursor: pointer; padding: 25px; border-radius: 50%; background: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.05); transition: transform 0.3s; border: 1px solid #f0f0f0;">
<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#d4a5a5" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
<path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
</svg>
</div>
<div style="color: #d4a5a5; font-size: 14px; font-family: 'Ma Shan Zheng', cursive;">ç‚¹å‡»å·çœ‹æ—¥è®°...</div>
</div>
<div id="diary-content" style="display: none; flex-direction: column; gap: 15px; padding-bottom: 20px;">
<!-- Entries will be injected here -->
</div>
</div>
</div>
<div id="input-modal" class="modal-overlay">
<div class="modal-box">
<div class="modal-title" id="modal-title">è¾“å…¥å†…å®¹</div>
<div id="modal-inputs-container"></div>
<div class="modal-actions"><button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="modal-btn btn-grey" id="modal-confirm-btn">å‘é€</button></div>
</div>
</div>
<div id="add-contact-modal" class="modal-overlay">
<div class="modal-box">
<div class="modal-title">å‘èµ·èŠå¤©</div>
<div class="contact-type-tabs">
<div class="tab active" onclick="switchContactTab('private')">ç§èŠ</div>
<div class="tab" onclick="switchContactTab('group')">ç¾¤èŠ</div>
</div>
<div id="add-contact-private-section">
<input type="text" id="new-contact-name" class="modal-input" placeholder="è¾“å…¥åå­—">
</div>
<div id="add-contact-group-section" style="display:none">
<input type="text" id="group-name-input" class="modal-input" placeholder="ç¾¤èŠåç§°" style="margin-bottom:8px;">
<!-- äººæ•°è¾“å…¥å·²ç§»é™¤ï¼Œæ”¹ä¸ºåŠ¨æ€æ·»åŠ åå­—è¡Œ -->
<div class="setting-row" style="padding: 10px 0; border: none; display: flex; justify-content: space-between; align-items: center;">
    <label style="font-size: 14px; color: #666;">æˆ‘åŠ å…¥ç¾¤èŠ</label> 
    <label class="switch">
        <input type="checkbox" id="group-join-toggle">
        <span class="slider round"></span>
    </label>
</div>
<div style="font-size:12px;color:#888;margin-bottom:8px;">æç¤ºï¼šå¦‚æœå¤´åƒåˆ—è¡¨ä¸­æ²¡æœ‰ <code>{{user}}</code>ï¼Œåˆ™è¡¨ç¤ºä½ ä¸åœ¨è¯¥ç¾¤é‡Œï¼›å¼€å¯â€œæˆ‘åŠ å…¥ç¾¤èŠâ€ä¼šæŠŠä½ åŠ å…¥æˆå‘˜åˆ—è¡¨ã€‚</div>
<div id="group-names-container"></div>
</div>
<div class="modal-actions">
<button class="modal-btn btn-cancel" onclick="closeAddContactModal()">å–æ¶ˆ</button>
<button class="modal-btn btn-grey" onclick="confirmAddContact()">ç¡®è®¤</button>
</div>
</div>
</div>
<div id="chat-settings-screen" class="screen">
<div class="app-header">
<div class="header-content">
<div class="header-btn" onclick="closeChatSettings()"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path></svg></div>
<span class="header-title">èŠå¤©è®¾ç½®</span>
</div>
</div>
<div class="settings-body">

    <!-- å¤´åƒè®¾ç½® -->
    <div>
        <div class="settings-section-title">å¤´åƒè®¾ç½®</div>
        <div class="setting-group no-border" style="background: transparent; box-shadow: none;">
             <div id="avatar-settings-container" class="avatar-grid"></div>
        </div>
    </div>

    <!-- è§’è‰²è®¾ç½® -->
    <div>
        <div class="settings-section-title">è§’è‰²è®¾å®š</div>
        <div class="setting-group">
            <div class="setting-row"><label>æˆ‘çš„åå­—</label> <input type="text" id="set-user-name" class="modal-input" style="border:none; text-align:right;" placeholder="ç”¨æˆ·"></div>
            <div class="setting-row"><label>è§’è‰²åå­—</label> <input type="text" id="set-char-name" class="modal-input" style="border:none; text-align:right;" placeholder="è§’è‰²"></div>
            <div class="setting-row" style="display:block; padding: 10px 18px;">
                <label style="display:block; margin-bottom:5px;">è§’è‰²è®¾å®š (System Prompt)</label>
                <textarea id="set-system-prompt" class="modal-input" style="width:100%; height:100px; resize:none; border:1px solid #eee;" placeholder="ä½ æ˜¯ä¸€ä¸ª..."></textarea>
            </div>
            <div class="setting-row" style="display:block; padding: 10px 18px;">
                <label style="display:block; margin-bottom:5px;">ç”¨æˆ·äººè®¾ (User Persona)</label>
                <textarea id="set-user-persona" class="modal-input" style="width:100%; height:80px; resize:none; border:1px solid #eee;" placeholder="ç”¨æˆ·çš„æ€§æ ¼ã€å¤–è²Œç­‰..."></textarea>
            </div>
        </div>
    </div>

    <!-- æ°”æ³¡ä¸å­—ä½“ -->
    <div>
        <div class="settings-section-title">æ°”æ³¡ä¸å­—ä½“</div>
        <div class="setting-group">
            <div class="setting-row"><label>å¯¹æ–¹æ°”æ³¡/æ–‡å­—</label> <div><input type="color" id="set-char-bubble" class="color-picker"> <input type="color" id="set-char-text" class="color-picker"></div></div>
            <div class="setting-row"><label>æˆ‘æ–¹æ°”æ³¡/æ–‡å­—</label> <div><input type="color" id="set-user-bubble" class="color-picker"> <input type="color" id="set-user-text" class="color-picker"></div></div>
            <div class="setting-row"><label>å­—ä½“å¤§å°</label> <div><input type="number" id="set-font-size" class="setting-input-sm" placeholder="14" style="width: 60px;"> px</div></div>
        </div>
    </div>

    <!-- é¢œè‰²è®¾ç½® -->
    <div>
        <div class="settings-section-title">é¢œè‰²è®¾ç½®</div>
        <div class="setting-group">
            <div class="setting-row"><label>åå­—/æ—¶é—´</label> <div><input type="color" id="set-msg-name-color" class="color-picker"> <input type="color" id="set-msg-time-color" class="color-picker"></div></div>
            <div class="setting-row"><label>ç•Œé¢</label> <div><input type="color" id="set-interface-color" class="color-picker"></div></div>
        </div>
    </div>

    <!-- æŒ‰é’®è®¾ç½® -->
    <div>
        <div class="settings-section-title">æŒ‰é’®è®¾ç½®</div>
        <div class="setting-group">
            <div class="setting-row"><label>æŒ‰é’®é¢œè‰²</label> <div><input type="color" id="set-chat-btn-text" class="color-picker"></div></div>
        </div>
    </div>

    <!-- æ‹‰é»‘è®¾ç½® -->
    <div>
        <div class="settings-section-title">æ‹‰é»‘è®¾ç½®</div>
        <div class="setting-group">
            <div class="setting-row">
                <label>æ‹’æ”¶å¯¹æ–¹æ¶ˆæ¯</label> 
                <label class="switch">
                    <input type="checkbox" id="set-block-char">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="setting-row">
                <label>æ¶ˆæ¯è¢«å¯¹æ–¹ç»æ”¶</label> 
                <label class="switch">
                    <input type="checkbox" id="set-block-user">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- èƒŒæ™¯è®¾ç½® -->
    <div>
        <div class="settings-section-title">èƒŒæ™¯è®¾ç½®</div>
        <div class="setting-group">
            <div class="setting-row"><label>èŠå¤©èƒŒæ™¯</label> <div><button class="file-upload-label" onclick="triggerSettingsUpload('chat-bg')">ä¸Šä¼ å›¾ç‰‡</button> <img id="preview-chat-bg" class="preview-img" src=""></div></div>
        </div>
    </div>

</div>
<div class="settings-footer" style="display: flex; gap: 8px; padding: 10px;">
<button class="modal-btn btn-delete-chat" onclick="deleteCurrentChat()" style="flex: 1; border-radius: 12px; padding: 8px 0; background: #f2f2f2; color: #333; font-size: 13px;">åˆ é™¤èŠå¤©</button>
<button class="modal-btn btn-save" onclick="saveChatSettings()" style="flex: 1; border-radius: 12px; padding: 8px 0; box-shadow: none; font-size: 13px;">ä¿å­˜é…ç½®</button>
</div>
</div>

<div id="call-screen" class="screen" style="display: none !important; visibility: hidden !important;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; width: 100%;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div id="call-name" style="font-size: 26px; font-weight: 600; letter-spacing: 1px;">{{char}}</div>
        </div>
        <div id="call-timer" style="font-size: 16px; opacity: 0.6; font-variant-numeric: tabular-nums; position: relative; top: -2px;">00:00</div>
    </div>
    
    <div style="display: flex; flex-direction: column; align-items: center; gap: 20px; flex: 1; justify-content: center; width: 100%;">
        <div style="position: relative;">
            <img id="call-avatar" src="" style="width: 120px; height: 120px; border-radius: 20px; object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);">
            <div class="ripple-ring"></div>
        </div>
        
        <!-- Middle Message Area -->
        <div id="call-chat-container" style="width: 100%; padding: 0 10px; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px; height: 200px; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none;">
            <!-- Call bubbles will be injected here -->
        </div>
        <style>
            #call-chat-container::-webkit-scrollbar { display: none; }
            .call-bubble {
                max-width: 80%;
                padding: 8px 12px;
                border-radius: 16px;
                font-size: 14px;
                line-height: 1.4;
                word-break: break-word;
                animation: fadeIn 0.3s ease;
            }
            .call-bubble.sent {
                align-self: flex-end;
                background: #666666;
                color: #fff;
                border-bottom-right-radius: 4px;
            }
            .call-bubble.received {
                align-self: flex-start;
                background: #333333;
                color: #fff;
                border-bottom-left-radius: 4px;
            }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
            @keyframes jump-exclamation {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-5px); }
            }
            .jumping-exclamation {
                display: inline-block;
                font-weight: bold;
                font-size: 18px;
                animation: jump-exclamation 0.6s infinite;
            }
        </style>
    </div>

    <div style="width: 100%; display: flex; flex-direction: column; gap: 30px;">
        <div style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 25px; backdrop-filter: blur(10px);">
            <input type="text" id="call-input" placeholder="æˆ‘æƒ³è¯´..." style="flex: 1; height: 32px; line-height: 32px; padding: 0 15px; border-radius: 20px; border: none; outline: none; background: transparent; color: #fff; font-size: 15px; margin-top: 6px;">
            <button onclick="sendCallMessage()" style="width: 32px; height: 32px; border-radius: 50%; border: none; background: #333; color: #888; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; padding: 0; margin-left: 5px;">
                <div style="width: 20px; height: 20px; background-color: currentColor; -webkit-mask: url('https://api.iconify.design/typcn:phone.svg') no-repeat center / contain; mask: url('https://api.iconify.design/typcn:phone.svg') no-repeat center / contain;"></div>
            </button>
        </div>
        
        <div style="display: flex; justify-content: space-around; align-items: center;">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; opacity: 0.5; cursor: not-allowed;">
                <div style="width: 64px; height: 64px; border-radius: 50%; background: rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" width="28" height="28" fill="#fff"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                </div>
                <span style="font-size: 12px; font-weight: 500;">å½•éŸ³</span>
            </div>
            
            <div onclick="endVoiceCall()" style="display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: transform 0.1s;">
                <div style="width: 64px; height: 64px; border-radius: 50%; background: #ff3b30; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);">
                    <img src="https://api.iconify.design/majesticons:phone-hangup.svg?color=white" width="32" height="32">
                </div>
                <span style="font-size: 12px; font-weight: 500;">æŒ‚æ–­</span>
            </div>
        </div>
    </div>
    <style>
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.4; } 100% { transform: scale(1.5); opacity: 0; } }
        .ripple-ring { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 20px; border: 2px solid rgba(255,255,255,0.5); animation: ripple 2s infinite; z-index: -1; display: none; }
        #call-screen.speaking .ripple-ring { display: block; }
        
        @keyframes wave-jump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .jumping-dot {
            display: inline-block;
            animation: wave-jump 1s infinite;
            font-size: 32px; /* ç‚¹å¤§ä¸€äº› */
            margin: 0 4px;   /* è·ç¦»å®½ä¸€äº› */
            line-height: 10px; /* é˜²æ­¢æ’‘å¼€é«˜åº¦ */
        }
        .jumping-dot:nth-child(1) { animation-delay: 0s; }
        .jumping-dot:nth-child(2) { animation-delay: 0.1s; }
        .jumping-dot:nth-child(3) { animation-delay: 0.2s; }
    </style>
</div>

<div id="incoming-call-screen" class="screen" style="display: none !important; visibility: hidden !important;">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
        <div id="incoming-call-name" style="font-size: 26px; font-weight: 600;">{{char}}</div>
        <div style="font-size: 16px; opacity: 0.6;">é‚€è¯·ä½ è¿›è¡Œè¯­éŸ³é€šè¯...</div>
    </div>
    
    <div style="position: relative;">
        <img id="incoming-call-avatar" src="" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <div class="ripple-ring" style="display:block;"></div>
    </div>

    <div style="width: 100%; display: flex; justify-content: space-around; align-items: center;">
        <div onclick="declineIncomingCall()" style="display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer;">
            <div style="width: 64px; height: 64px; border-radius: 50%; background: #ff3b30; display: flex; align-items: center; justify-content: center;">
                <img src="https://api.iconify.design/majesticons:phone-hangup.svg?color=white" width="32" height="32">
            </div>
            <span style="font-size: 12px;">æ‹’ç»</span>
        </div>
        
        <div onclick="acceptIncomingCall()" style="display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer;">
            <div style="width: 64px; height: 64px; border-radius: 50%; background: #30d158; display: flex; align-items: center; justify-content: center;">
                <img src="https://api.iconify.design/majesticons:phone.svg?color=white" width="32" height="32">
            </div>
            <span style="font-size: 12px;">æ¥å¬</span>
        </div>
    </div>
</div>

<script>
(function() {
// Global Variables
const defaultAppSettings = {
charBubble: '#001C77', charText: '#C2C2C2', charAvatar: '',
userBubble: '#016E8F', userText: '#C2C2C2', userAvatar: '',
chatBg: '', chatBgIsDark: false,
homeBg: '', homeBgIsDark: false,
iconBg: '#003673', iconColor: '#00885A',
caseColor: '#707070', phoneWidth: '330', phoneHeight: '660',
homeTextColor: '#749594',
interfaceColor: '#004A88',
msgNameColor: '#C2C2C2',
msgTimeColor: '#ADADAD',
fontSize: 14, // é»˜è®¤å­—ä½“å¤§å°
chatBtnColor: '#A7C6FF', // æŒ‰é’®èƒŒæ™¯è‰²
chatBtnText: '#A7C6FF', // æŒ‰é’®æ–‡å­—/å›¾æ ‡è‰²
customTime: '', // æ ¼å¼ HH:MMï¼Œä¸ºç©ºåˆ™ä½¿ç”¨ç³»ç»Ÿæ—¶é—´
timeOffset: 0, // æ—¶é—´åç§»é‡ (ms)
blockChar: false, // User blocks Char
blockUser: false, // Char blocks User
groups: [], // ç¾¤ç»„åˆ—è¡¨ [{name: 'GroupName', members: ['A', 'B']}]
privateChats: [], // ç§èŠåˆ—è¡¨ ['Name1', 'Name2']
memberAvatars: {}, // NEW: æˆå‘˜å¤´åƒåˆ—è¡¨ { 'Name': 'url', ... }
// AI & Role Settings
apiUrl: 'https://api.openai.com/v1',
apiKey: '',
modelName: 'gpt-3.5-turbo',
userName: 'ç”¨æˆ·',
charName: 'è§’è‰²',
systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªä¹äºåŠ©äººçš„AIåŠ©æ‰‹ã€‚',
userPersona: ''
};
let appSettings = { ...defaultAppSettings };
let currentChatTag = null; // å½“å‰èŠå¤©æ ‡ç­¾ (e.g. chat:Name or group:Name5äºº)
let currentChatId = null; // NEW: å½“å‰èŠå¤©ID (UUID)
let currentChatTarget = null; // å½“å‰èŠå¤©æ˜¾ç¤ºåç§°
let initialCharName = null; // NEW: ç”¨äºå›ºå®šå­˜å‚¨ Keyï¼Œé˜²æ­¢è¿›å…¥èŠå¤©åæ ‡é¢˜å˜åŒ–å¯¼è‡´è®¾ç½®é‡ç½®
let chatHistory = []; // å†…å­˜ä¸­çš„èŠå¤©è®°å½•ç¼“å­˜

function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

function migrateChats() {
    let globalSettings = {};
    try {
        const raw = localStorage.getItem('st-phone-settings-global');
        if (raw) globalSettings = JSON.parse(raw);
    } catch(e) { return; }

    let changed = false;

    // Migrate Private Chats
    if (globalSettings.privateChats && Array.isArray(globalSettings.privateChats)) {
        globalSettings.privateChats = globalSettings.privateChats.map(chat => {
            if (typeof chat === 'string') {
                const id = generateUUID();
                const name = chat;
                // Migrate History
                const oldHistKey = `faye-phone-history-chat:${name}`;
                const newHistKey = `faye-phone-history-chat:${id}`;
                const hist = localStorage.getItem(oldHistKey);
                if (hist) {
                    localStorage.setItem(newHistKey, hist);
                    localStorage.removeItem(oldHistKey);
                }
                // Migrate Settings
                const oldSetKey = `st-phone-settings-${name}`;
                const newSetKey = `st-phone-settings-${id}`;
                const set = localStorage.getItem(oldSetKey);
                if (set) {
                    localStorage.setItem(newSetKey, set);
                    localStorage.removeItem(oldSetKey);
                }
                changed = true;
                return { id: id, name: name };
            }
            return chat;
        });
    }

    // Migrate Groups
    if (globalSettings.groups && Array.isArray(globalSettings.groups)) {
        globalSettings.groups = globalSettings.groups.map(group => {
            if (!group.id) {
                const id = generateUUID();
                group.id = id;
                // Migrate History
                const oldHistKey = `faye-phone-history-group:${group.name}`;
                const newHistKey = `faye-phone-history-group:${id}`;
                const hist = localStorage.getItem(oldHistKey);
                if (hist) {
                    localStorage.setItem(newHistKey, hist);
                    localStorage.removeItem(oldHistKey);
                }
                changed = true;
            }
            return group;
        });
    }

    if (changed) {
        localStorage.setItem('st-phone-settings-global', JSON.stringify(globalSettings));
    }
}

let myStickerList = [];
const defaultStickerList = [
{ name: "ä½ è‡ªé¦–å§", url: "https://catbox.pengcyril.dpdns.org/s1wpw8.jpeg" },
{ name: "æŠ±æŠ±", url: "https://catbox.pengcyril.dpdns.org/31onrh.jpeg" },
{ name: "è´´è´´", url: "https://catbox.pengcyril.dpdns.org/ljqszc.jpeg" },
{ name: "æˆ‘è¦å‘ŠçŠ¶", url: "https://catbox.pengcyril.dpdns.org/icwt52.jpeg" }
];

let activeDeleteBtn = null;
let currentConfirmAction = null;
// NEW: Pending upload file
let pendingFile = null;
// NEW: Last uploaded image for AI vision
let lastUploadedImageForAI = null;
// NEW: Dark Search Flag
let isWaitingForDarkSearch = false;
// NEW: Diary Flag
let isWaitingForDiary = false;

let currentSettingsUploadType = null;

// DOM Elements (Initialized in init to be safe)
let phoneContainer, homeScreen, chatScreen, settingsScreen, messageListScreen, messageListBody, chatMessages, messageInput, sendButton, plusButton, emojiButton, actionMenu, emojiMenu, modal, modalTitle, modalInputsContainer, modalConfirmBtn, chatSettingsScreen, headerTitle, clockEl, homeClockEl, statusBar, photoInput, audioInput, videoInput, mediaPreviewBar, previewImage, previewFileIcon, adapterStatus, darkSearchScreen, darkSearchInput, diaryScreen, addContactModal;

// Functions
function openAddContactModal() {
    if(addContactModal) {
        addContactModal.classList.add('show');
        // Reset tabs
        switchContactTab('private');
        document.getElementById('new-contact-name').value = '';
        document.getElementById('group-count').value = '';
        document.getElementById('group-name-input').value = '';
        const gnc = document.getElementById('group-names-container');
        if (gnc) { gnc.innerHTML = ''; addGroupNameRow(gnc, false, '', false); }
        // Reset toggle: å¦‚æœå¤´åƒåˆ—è¡¨åŒ…å«å½“å‰ç”¨æˆ·ï¼Œåˆ™é»˜è®¤è¡¨ç¤ºä½ å·²åœ¨ç¾¤é‡Œ
        const toggle = document.getElementById('group-join-toggle');
        if (toggle) {
            try {
                const myName = window.userName || '{{user}}';
                let present = false;
                if (appSettings.memberAvatars) {
                    // memberAvatars keys are member names
                    present = Object.prototype.hasOwnProperty.call(appSettings.memberAvatars, myName) || Object.prototype.hasOwnProperty.call(appSettings.memberAvatars, '{{user}}');
                }
                toggle.checked = !!present;
            } catch (e) { toggle.checked = false; }
        }
    }
}

function closeAddContactModal() {
    if(addContactModal) addContactModal.classList.remove('show');
}

function switchContactTab(type) {
    const tabs = document.querySelectorAll('.contact-type-tabs .tab');
    const privateSection = document.getElementById('add-contact-private-section');
    const groupSection = document.getElementById('add-contact-group-section');
    
    tabs.forEach(t => t.classList.remove('active'));
    
    if(type === 'private') {
        tabs[0].classList.add('active');
        privateSection.style.display = 'block';
        groupSection.style.display = 'none';
    } else {
        tabs[1].classList.add('active');
        privateSection.style.display = 'none';
        groupSection.style.display = 'block';
        // Ensure at least one name input row is present
        try { renderGroupInputs(); } catch(e) {}
    }
}

function renderGroupInputs() {
    const container = document.getElementById('group-names-container');
    if (!container) return;
    // å¦‚æœä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸€è¡Œè¾“å…¥
    if (container.children.length === 0) {
        // é¦–è¡Œä¸å¯åˆ é™¤ï¼ˆæ²¡æœ‰å‡å·ï¼‰
        addGroupNameRow(container, true, '', false);
    }
}

function addGroupNameRow(container, focus=false, value='', removable=true) {
    const row = document.createElement('div');
    row.className = 'group-name-row';
    row.style.display = 'flex';
    // å‚ç›´å±…ä¸­å¯¹é½ï¼Œå‡å°é—´è·ï¼Œè®©æŒ‰é’®æ›´é è¿‘è¾“å…¥æ¡†
    row.style.alignItems = 'center';
    row.style.gap = '6px';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'modal-input group-input-item';
    input.placeholder = `æˆå‘˜ åå­—`;
    input.value = value || '';
    input.style.flex = '1';
    input.style.minWidth = '0';
    input.style.boxSizing = 'border-box';

    const btnAdd = document.createElement('button');
    btnAdd.type = 'button';
    btnAdd.className = 'modal-btn group-add-btn';
    btnAdd.textContent = '+';
    // æ›´å°ã€æ›´ç´§å‡‘çš„æ ·å¼
    btnAdd.style.width = '30px';
    btnAdd.style.height = '28px';
    btnAdd.style.padding = '2px';
    btnAdd.style.fontSize = '14px';
    btnAdd.style.background = 'transparent';
    btnAdd.style.border = 'none';
    btnAdd.style.cursor = 'pointer';
    btnAdd.style.display = 'inline-flex';
    btnAdd.style.alignItems = 'center';
    btnAdd.style.justifyContent = 'center';
    btnAdd.style.borderRadius = '6px';
    btnAdd.onclick = (e) => { e.preventDefault(); addGroupNameRow(container, true, '', true); };

    row.appendChild(input);
    row.appendChild(btnAdd);
    // å¦‚æœå¯ç§»é™¤ï¼Œåˆ™æ·»åŠ å‡å·æŒ‰é’®ï¼›é¦–è¡Œ removable=false æ—¶ä¸æ·»åŠ 
    // æŒ‰é’®å°ºå¯¸ç»Ÿä¸€ï¼Œé¦–è¡Œå¦‚æœä¸å¯åˆ é™¤åˆ™æ’å…¥å ä½å…ƒç´ ä¿è¯è¾“å…¥æ¡†å®½åº¦ä¸€è‡´
    if (removable) {
        const btnRemove = document.createElement('button');
        btnRemove.type = 'button';
        btnRemove.className = 'modal-btn group-remove-btn';
        btnRemove.textContent = 'âˆ’';
        btnRemove.style.width = '30px';
        btnRemove.style.height = '28px';
        btnRemove.style.padding = '2px';
        btnRemove.style.fontSize = '14px';
        btnRemove.style.background = 'transparent';
        btnRemove.style.border = 'none';
        btnRemove.style.cursor = 'pointer';
        btnRemove.style.display = 'inline-flex';
        btnRemove.style.alignItems = 'center';
        btnRemove.style.justifyContent = 'center';
        btnRemove.style.borderRadius = '6px';
        btnRemove.onclick = (e) => { e.preventDefault(); if (row.parentNode) row.parentNode.removeChild(row); };
        row.appendChild(btnRemove);
    } else {
        // æ’å…¥ä¸€ä¸ªå ä½å®½åº¦ï¼Œä¸åˆ é™¤æŒ‰é’®å®½åº¦ä¸€è‡´ï¼Œä¿è¯è¾“å…¥æ¡†é•¿åº¦ç›¸åŒ
        const spacer = document.createElement('div');
        spacer.style.width = '30px';
        spacer.style.height = '28px';
        spacer.style.display = 'inline-block';
        row.appendChild(spacer);
    }
    container.appendChild(row);

    if (focus) input.focus();
}

function confirmAddContact() {
    const isGroup = document.getElementById('add-contact-group-section').style.display === 'block';
    let targetName = '';
    let targetTag = '';
    
    if(isGroup) {
        // ç¾¤èŠé€»è¾‘
        const groupName = document.getElementById('group-name-input').value.trim();
        if (!groupName) {
            alert('è¯·è¾“å…¥ç¾¤èŠåç§°');
            return;
        }

        const joinToggle = document.getElementById('group-join-toggle');
        const joinGroup = joinToggle ? joinToggle.checked : false;

        const inputs = document.querySelectorAll('#group-names-container input');
        const names = [];
        
        // å¦‚æœå¼€å¯â€œæˆ‘åŠ å…¥ç¾¤èŠâ€ï¼Œå°†è‡ªå·±åŠ å…¥ç¬¬ä¸€ä½
        if (joinGroup) {
            const myName = window.userName || '{{user}}';
            names.push(myName);
        }

        inputs.forEach(inp => {
            if(inp.value.trim()) names.push(inp.value.trim());
        });

        // éªŒè¯äººæ•°ï¼šå¦‚æœä¸åŠ å…¥ç¾¤èŠï¼Œè‡³å°‘éœ€è¦è¾“å…¥2ä¸ªæˆå‘˜
        // å¦‚æœåŠ å…¥ç¾¤èŠï¼Œç®—ä¸Šè‡ªå·±è‡³å°‘2äººï¼Œå³è¾“å…¥è‡³å°‘1äºº
        const minInputs = joinGroup ? 1 : 2;
        if(names.length < 2) { // Total length check
            alert(joinGroup ? 'é™¤è‡ªå·±å¤–è‡³å°‘éœ€è¦1ä¸ªæˆå‘˜' : 'ç¾¤èŠè‡³å°‘éœ€è¦2ä¸ªæˆå‘˜');
            return;
        }
        
        // ä¿å­˜ç¾¤ç»„ä¿¡æ¯ (ç”¨äºå¤‡ä»½æˆå‘˜åˆ—è¡¨ï¼ŒåŒ¹é…ä»¥ç¾¤åä¸ºå‡†)
        if (!appSettings.groups) appSettings.groups = [];
        // Check if group name exists (optional, but good for UX)
        // But now we use IDs, so duplicate names are technically allowed but confusing.
        // Let's just create a new one.
        
        const chatId = generateUUID();
        appSettings.groups.push({ id: chatId, name: groupName, members: names });
        saveSettingsToStorage();

        targetName = groupName;
        // æ„é€ ç¾¤èŠæ ‡ç­¾: ä½¿ç”¨ ID
        targetTag = `group:${chatId}`;
        
    } else {
        // ç§èŠé€»è¾‘
        targetName = document.getElementById('new-contact-name').value.trim();
        if(!targetName) return;
        
        const chatId = generateUUID();
        targetTag = `chat:${chatId}`;

        // NEW: æŒä¹…åŒ–ä¿å­˜ç§èŠè”ç³»äºº
        if (!appSettings.privateChats) appSettings.privateChats = [];
        // Check if name exists? No, allow duplicates or just create new.
        // But usually we don't want duplicate chats with same person.
        // Let's check if we already have a chat with this name.
        const existing = appSettings.privateChats.find(c => (typeof c === 'string' ? c : c.name) === targetName);
        if (existing) {
            // Open existing
            const existingId = (typeof existing === 'string') ? null : existing.id; // If string, it should have been migrated, but handle just in case
            if (existingId) {
                targetTag = `chat:${existingId}`;
            } else {
                // Should not happen after migration, but fallback
                targetTag = `chat:${targetName}`;
            }
        } else {
            appSettings.privateChats.push({ id: chatId, name: targetName });
            saveSettingsToStorage();
        }
    }
    
    closeAddContactModal();
    // Extract ID from tag
    const id = targetTag.split(':')[1];
    openChat(targetTag, targetName, id);
}

function openDarkSearch() {
if(homeScreen) homeScreen.style.display = 'none';
if(darkSearchScreen) darkSearchScreen.style.display = 'flex';
updateStatusBar('dark-search');
}

function closeDarkSearch() {
if(darkSearchScreen) darkSearchScreen.style.display = 'none';
if(homeScreen) homeScreen.style.display = 'flex';
updateStatusBar('home');
}

// NEW: è¾…åŠ©å‡½æ•° - æ ¹æ®åå­—æŸ¥æ‰¾èŠå¤©ä¿¡æ¯ï¼ˆè®¾å®š+å†å²ï¼‰
function getChatInfoForSearch(targetName) {
    let info = {
        systemPrompt: '',
        userPersona: '',
        historySummary: ''
    };

    // 1. æŸ¥æ‰¾ç›®æ ‡ ID
    let targetId = null;
    let type = 'chat';
    
    // å°è¯•åœ¨ç§èŠåˆ—è¡¨ä¸­æŸ¥æ‰¾
    if (appSettings.privateChats) {
        const chat = appSettings.privateChats.find(c => (typeof c === 'object' ? c.name === targetName : c === targetName));
        if (chat) {
            targetId = (typeof chat === 'object') ? chat.id : null; // å¦‚æœæ˜¯æ—§æ•°æ®å¯èƒ½æ²¡æœ‰ ID
        }
    }
    // å°è¯•åœ¨ç¾¤èŠåˆ—è¡¨ä¸­æŸ¥æ‰¾
    if (!targetId && appSettings.groups) {
        const group = appSettings.groups.find(g => g.name === targetName);
        if (group) {
            targetId = group.id;
            type = 'group';
        }
    }

    // å¦‚æœæ²¡æ‰¾åˆ° IDï¼Œä½†åå­—å°±æ˜¯å½“å‰èŠå¤©å¯¹è±¡ï¼Œå°è¯•ä½¿ç”¨å½“å‰ ID
    if (!targetId && currentChatTarget === targetName && currentChatId) {
        targetId = currentChatId;
        type = currentChatTag.startsWith('group') ? 'group' : 'chat';
    }

    // 2. è·å–è®¾å®š (System Prompt)
    // ä¼˜å…ˆä»ç‹¬ç«‹å­˜å‚¨ä¸­è¯»å–
    if (targetId) {
        const setKey = `st-phone-settings-${targetId}`;
        const savedSet = localStorage.getItem(setKey);
        if (savedSet) {
            try {
                const parsed = JSON.parse(savedSet);
                if (parsed.systemPrompt) info.systemPrompt = parsed.systemPrompt;
                if (parsed.userPersona) info.userPersona = parsed.userPersona;
            } catch(e) {}
        }
    }
    
    // å¦‚æœæ²¡æ‰¾åˆ°ç‹¬ç«‹è®¾å®šï¼Œä½†åå­—åŒ¹é…å½“å‰åŠ è½½çš„è§’è‰²ï¼Œä½¿ç”¨å½“å‰å†…å­˜ä¸­çš„è®¾å®š
    if (!info.systemPrompt && appSettings.charName && (targetName === appSettings.charName)) {
        info.systemPrompt = appSettings.systemPrompt;
        info.userPersona = appSettings.userPersona;
    }

    // 3. è·å–èŠå¤©è®°å½• (History)
    let rawHistory = '';
    if (targetId) {
        // å°è¯•ä» localStorage è¯»å– (ç‹¬ç«‹ç‰ˆ)
        const histKey = `faye-phone-history-${type}:${targetId}`;
        rawHistory = localStorage.getItem(histKey);
    }
    
    // å¦‚æœ localStorage æ²¡æ‰¾åˆ°ï¼Œä¸”æ˜¯å½“å‰æ­£åœ¨èŠçš„è§’è‰²ï¼Œå°è¯•ä»å†…å­˜ç¼“å­˜æˆ– DOM è·å–
    if (!rawHistory && targetName === currentChatTarget) {
        // å°è¯•ä» chatMessages DOM è·å–æœ€æ–°å†…å®¹
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥è·³è¿‡ï¼Œå› ä¸º parseMessages éœ€è¦æ ‡å‡†æ ¼å¼
    }

    if (rawHistory) {
        const msgs = parseMessages(rawHistory);
        // æˆªå–æœ€è¿‘ 20 æ¡
        const recent = msgs.slice(-20);
        const summary = recent.map(m => {
            let sender = m.isUser ? (window.userName || 'ç”¨æˆ·') : targetName;
            // å¦‚æœæ˜¯ç¾¤èŠï¼Œå°è¯•ä» header è·å–å‘é€è€…
            if (m.header) {
                const parts = m.header.replace(/^\[|\]$|^ã€|ã€‘$/g, '').split('|');
                if (parts.length > 0) sender = parts[0];
            }
            let content = m.body;
            if (m.type === 'photo') content = '[å‘é€äº†ä¸€å¼ å›¾ç‰‡]';
            else if (m.type === 'voice') content = '[å‘é€äº†ä¸€æ¡è¯­éŸ³]';
            return `${sender}: ${content}`;
        }).join('\n');
        info.historySummary = summary;
    }

    return info;
}

async function searchDarkWeb() {
const targetName = darkSearchInput && darkSearchInput.value.trim() ? darkSearchInput.value.trim() : (window.charName || '{{char}}');
// const charName = window.charName || '{{char}}';

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
const resultsContainer = document.getElementById('dark-search-results');
if(resultsContainer) resultsContainer.innerHTML = '<div style="color:#ff69b4;text-align:center;margin-top:50px;font-family:monospace;">æ­£åœ¨æ½œå…¥æ•°æ®èŠ‚ç‚¹...<br>Decrypting...</div>';

isWaitingForDarkSearch = true;

// è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯
const contextInfo = getChatInfoForSearch(targetName);

let prompt = `[ç³»ç»ŸæŒ‡ä»¤] ç”¨æˆ·åœ¨æš—ç½‘æœç´¢APPä¸­è¯•å›¾å·çœ‹ "${targetName}" çš„æœç´¢å†å²ã€‚
è¯·åˆ—å‡º ${targetName} åœ¨æš—ç½‘çš„æœ€è¿‘5æ¡æœç´¢è®°å½•ã€‚
æ ¼å¼è¦æ±‚ï¼š
1. è¯·åŠ¡å¿…å°†æ‰€æœ‰è¾“å‡ºå†…å®¹åŒ…è£¹åœ¨ <jilu:${targetName}> å’Œ </jilu:${targetName}> æ ‡ç­¾ä¸­ã€‚
2. æ¯æ¡è®°å½•ä¸€è¡Œï¼Œå¿…é¡»ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š
ã€æœç´¢è®°å½•ã€‘æœç´¢å…³é”®è¯æˆ–å†…å®¹
å†…å®¹éœ€ç¬¦åˆ ${targetName} çš„è§’è‰²è®¾å®šï¼ˆé»‘æš—ã€ç¥ç§˜ã€çŒå¥‡ã€ä¸å¯å‘Šäººï¼‰ä»¥åŠå¯¹ç”¨æˆ·éšç§˜çš„æ¬²æœ›ã€‚
è¯·ç›´æ¥è¾“å‡º5æ¡è®°å½•ï¼Œä¸è¦åŒ…å«å…¶ä»–å¯¹è¯å†…å®¹ã€‚`;

if (contextInfo.systemPrompt) {
    prompt += `\n\n[è§’è‰²è®¾å®š]\n${contextInfo.systemPrompt}`;
}

if (contextInfo.historySummary) {
    prompt += `\n\n[å‚è€ƒè¿‘æœŸèŠå¤©è®°å½•]\n${contextInfo.historySummary}\n(è¯·æ ¹æ®èŠå¤©è®°å½•ä¸­çš„è¯­å¢ƒå’Œè¿‘æœŸå‘ç”Ÿçš„äº‹ä»¶ï¼Œç”Ÿæˆç›¸å…³çš„æœç´¢è®°å½•)`;
}

    const injects = [
        { role: 'system', content: prompt, position: 'at_depth', depth: 0 }
    ];

    // Standalone API Call Logic
    if (!appSettings.apiUrl || !appSettings.apiKey) {
        // Fallback for testing without backend or key
        setTimeout(() => {
            const mockResp = `<jilu:${targetName}>ã€æœç´¢è®°å½•ã€‘å¦‚ä½•é”€æ¯ç”µå­è¯æ®\nã€æœç´¢è®°å½•ã€‘è´­ä¹°æœªæ³¨å†Œçš„SIMå¡\nã€æœç´¢è®°å½•ã€‘æœ€æ–°çš„åŠ å¯†é€šè®¯è½¯ä»¶\nã€æœç´¢è®°å½•ã€‘æš—ç½‘äº¤æ˜“å¸‚åœºå…¥å£\nã€æœç´¢è®°å½•ã€‘è¿½è¸ªå™¨æ£€æµ‹æ–¹æ³•</jilu:${targetName}>`;
            renderDarkSearchResults(mockResp);
            isWaitingForDarkSearch = false;
        }, 1500);
        return;
    }

    try {
        let url = appSettings.apiUrl;
        if (url.endsWith('/')) url = url.slice(0, -1);
        if (!url.endsWith('/chat/completions')) url += '/chat/completions';

        const messages = injects.map(inj => ({ role: inj.role, content: inj.content }));

        const res = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${appSettings.apiKey}`
            },
            body: JSON.stringify({
                model: appSettings.modelName || 'gpt-3.5-turbo',
                messages: messages,
                temperature: 0.7
            })
        });
        
        if (!res.ok) {
            const errText = await res.text();
            throw new Error(`API Error ${res.status}: ${errText}`);
        }
        const data = await res.json();
        const reply = data.choices[0].message.content;
        renderDarkSearchResults(reply);
        isWaitingForDarkSearch = false;

    } catch (e) {
        console.error(e);
        alert('æš—ç½‘æœç´¢å¤±è´¥: ' + e.message);
        isWaitingForDarkSearch = false;
        const resultsContainer = document.getElementById('dark-search-results');
        if(resultsContainer) resultsContainer.innerHTML = '<div style="color:red;text-align:center;margin-top:50px;">è¿æ¥ä¸­æ–­</div>';
    }
}function renderDarkSearchResults(text) {
const container = document.getElementById('dark-search-results');
if (!container) return;
container.innerHTML = '';

// Extract content from <jilu:Name> tags
let contentToParse = text;
const tagMatch = text.match(/<jilu:(.*?)>([\s\S]*?)<\/jilu:\1>/i);
if (tagMatch) {
    contentToParse = tagMatch[2].trim();
} else {
    // Fallback: try to find just the content if tag is missing or malformed
    // But strictly we should look for the tag as requested. 
    // Let's be lenient for now.
}

// ç®€å•çš„è§£æé€»è¾‘ï¼Œæå–æ‰€æœ‰ç¬¦åˆæ ¼å¼çš„è¡Œ
// æ ¼å¼ï¼šã€æœç´¢è®°å½•ã€‘å†…å®¹
const lines = contentToParse.split('\n');
let count = 0;
lines.forEach(line => {
    const match = line.match(/^[\[ã€]æœç´¢è®°å½•[\]ã€‘](.*)$/);
    if (match) {
        const content = match[1].trim();
        
        const item = document.createElement('div');
        item.className = 'dark-result-item';
        item.innerHTML = `
            <div class="dark-result-content">${content}</div>
        `;
        container.appendChild(item);
        count++;
    }
});

if (count === 0) {
     container.innerHTML = '<div style="color:#666;text-align:center;margin-top:50px;">æ— ç›¸å…³æ•°æ®</div>';
}
}

function openDiary() {
    if(homeScreen) homeScreen.style.display = 'none';
    if(diaryScreen) diaryScreen.style.display = 'flex';
    updateStatusBar('diary');
}

function closeDiary() {
    if(diaryScreen) diaryScreen.style.display = 'none';
    if(homeScreen) homeScreen.style.display = 'flex';
    updateStatusBar('home');
}

async function generateDiary() {
    const nameInput = document.getElementById('diary-target-name');
    const targetName = nameInput && nameInput.value.trim() ? nameInput.value.trim() : (window.charName || '{{char}}');
    
    // Show loading state
    const lockContainer = document.getElementById('diary-lock-container');
    const contentContainer = document.getElementById('diary-content');
    
    if(lockContainer) lockContainer.style.display = 'none';
    if(contentContainer) {
        contentContainer.style.display = 'flex';
        contentContainer.innerHTML = '<div style="text-align:center;margin-top:50px;color:#999;">æ­£åœ¨ç”Ÿæˆæ—¥è®°...</div>';
    }

    isWaitingForDiary = true;

    // è·å–ä¸Šä¸‹æ–‡ä¿¡æ¯
    const contextInfo = getChatInfoForSearch(targetName);

    let prompt = `[ç³»ç»ŸæŒ‡ä»¤] ç”¨æˆ·åœ¨æ—¥è®°APPä¸­ç‚¹å‡»äº†è§£é”ã€‚
è¯·ç”Ÿæˆ ${targetName} çš„3ç¯‡ç§å¯†æ—¥è®°ã€‚
æ ¼å¼è¦æ±‚ï¼š
1. è¯·åŠ¡å¿…å°†æ‰€æœ‰è¾“å‡ºå†…å®¹åŒ…è£¹åœ¨ <riji:${targetName}> å’Œ </riji:${targetName}> æ ‡ç­¾ä¸­ã€‚
2. æ¯ç¯‡æ—¥è®°ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š
ã€æ—¥è®°|æ—¥æœŸ|å¤©æ°”ã€‘æ—¥è®°å†…å®¹
æ—¥æœŸè¯·æ ¹æ®å½“å‰å‰§æƒ…æˆ–éšæœºç”Ÿæˆï¼ˆå¦‚"11æœˆ24æ—¥"ï¼‰ï¼Œä¸è¦å…¨éƒ¨ä½¿ç”¨ä»Šå¤©ã€‚
å†…å®¹éœ€ç¬¦åˆ ${targetName} çš„è§’è‰²è®¾å®šï¼Œå¯ä»¥æ˜¯æ—¥å¸¸çäº‹ã€å†…å¿ƒç‹¬ç™½æˆ–ç§˜å¯†ã€‚
æ”¯æŒMarkdownæ ¼å¼ï¼ˆå¦‚**åŠ ç²—**ï¼Œ~~åˆ é™¤çº¿~~ï¼Œ# æ ‡é¢˜ï¼‰ã€‚
è¯·ç›´æ¥è¾“å‡º3ç¯‡æ—¥è®°ï¼Œä¸è¦åŒ…å«å…¶ä»–å¯¹è¯å†…å®¹ã€‚`;

    if (contextInfo.systemPrompt) {
        prompt += `\n\n[è§’è‰²è®¾å®š]\n${contextInfo.systemPrompt}`;
    }

    if (contextInfo.historySummary) {
        prompt += `\n\n[å‚è€ƒè¿‘æœŸèŠå¤©è®°å½•]\n${contextInfo.historySummary}\n(è¯·æ ¹æ®èŠå¤©è®°å½•ä¸­çš„è¯­å¢ƒå’Œè¿‘æœŸå‘ç”Ÿçš„äº‹ä»¶ï¼Œç”Ÿæˆç›¸å…³çš„æ—¥è®°å†…å®¹)`;
    }

    const injects = [
        { role: 'system', content: prompt, position: 'at_depth', depth: 0 }
    ];

    // Standalone API Call Logic
    if (!appSettings.apiUrl || !appSettings.apiKey) {
        // Fallback
        setTimeout(() => {
            const mockResp = `<riji:${targetName}>ã€æ—¥è®°|11æœˆ20æ—¥|é˜´ã€‘ä»Šå¤©å¿ƒæƒ…å¾ˆå·®ï¼Œ**ä¸æƒ³è¯´è¯**ã€‚\nã€æ—¥è®°|11æœˆ22æ—¥|é›¨ã€‘~~é‚£ä¸ªç¬¨è›‹~~åˆæ¥çƒ¦æˆ‘äº†ã€‚\nã€æ—¥è®°|11æœˆ25æ—¥|æ™´ã€‘# è®¡åˆ’\n1. ä¹°ä¸œè¥¿\n2. ç¡è§‰</riji:${targetName}>`;
            renderDiaryEntries(mockResp);
            isWaitingForDiary = false;
        }, 1500);
        return;
    }

    try {
        let url = appSettings.apiUrl;
        if (url.endsWith('/')) url = url.slice(0, -1);
        if (!url.endsWith('/chat/completions')) url += '/chat/completions';

        const messages = injects.map(inj => ({ role: inj.role, content: inj.content }));

        const res = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${appSettings.apiKey}`
            },
            body: JSON.stringify({
                model: appSettings.modelName || 'gpt-3.5-turbo',
                messages: messages,
                temperature: 0.7
            })
        });
        
        if (!res.ok) {
            const errText = await res.text();
            throw new Error(`API Error ${res.status}: ${errText}`);
        }
        const data = await res.json();
        const reply = data.choices[0].message.content;
        renderDiaryEntries(reply);
        isWaitingForDiary = false;

    } catch (e) {
        console.error(e);
        alert('æ—¥è®°ç”Ÿæˆå¤±è´¥: ' + e.message);
        isWaitingForDiary = false;
        const contentContainer = document.getElementById('diary-content');
        if(contentContainer) contentContainer.innerHTML = '<div style="text-align:center;margin-top:50px;color:red;">ç”Ÿæˆå¤±è´¥</div>';
    }
}

function renderDiaryEntries(text) {
    const container = document.getElementById('diary-content');
    if (!container) return;
    container.innerHTML = '';
    
    // Extract content from <riji:Name> tags if present
    let contentToParse = text;
    const tagMatch = text.match(/<riji:(.*?)>([\s\S]*?)<\/riji:\1>/i);
    if (tagMatch) {
        contentToParse = tagMatch[2].trim();
    }
    
    // Simple markdown parser
    const parseMarkdown = (str) => {
        let html = str
            .replace(/^# (.*$)/gim, '<h3>$1</h3>')
            .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
            .replace(/~~(.*)~~/gim, '<del>$1</del>')
            .replace(/\n/gim, '<br>');
        return html;
    };

    let entries = [];
    
    // Split by the header pattern
    const parts = contentToParse.split(/([\[ã€]æ—¥è®°\|.*?\|.*?[\]ã€‘])/);
    
    for (let i = 1; i < parts.length; i += 2) {
        const headerStr = parts[i];
        const contentStr = parts[i+1];
        
        const headerMatch = headerStr.match(/[\[ã€]æ—¥è®°\|(.*?)\|(.*?)[\]ã€‘]/);
        if (headerMatch) {
            entries.push({
                date: headerMatch[1],
                weather: headerMatch[2],
                content: contentStr.trim()
            });
        }
    }
    
    // Fallback for simple line parsing if split failed (e.g. single line response)
    if (entries.length === 0) {
         const lines = text.split('\n');
         lines.forEach(line => {
             const match = line.match(/^[\[ã€]æ—¥è®°\|(.*?)\|(.*?)[\]ã€‘](.*)$/);
             if (match) {
                 entries.push({
                     date: match[1],
                     weather: match[2],
                     content: match[3].trim()
                 });
             }
         });
    }

    entries.forEach(entry => {
        const card = document.createElement('div');
        card.className = 'diary-card';
        
        card.innerHTML = `
            <div class="diary-header">
                <span class="diary-date">${entry.date}</span>
                <span class="diary-weather">${entry.weather}</span>
            </div>
            <div class="diary-body">
                ${parseMarkdown(entry.content)}
            </div>
        `;
        container.appendChild(card);
    });
    
    if (entries.length === 0) {
        container.innerHTML = '<div style="text-align:center;margin-top:50px;color:#d4a5a5;font-family:\'Ma Shan Zheng\';">æ—¥è®°æœ¬æ˜¯ç©ºçš„...<br>(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)</div>';
    }
}

function openMessageList() {
if(homeScreen) homeScreen.style.display = 'none';
if(messageListScreen) messageListScreen.style.display = 'flex';
updateStatusBar('message-list');
renderMessageList();
}

function openChat(targetTag, targetName, targetId) {
    // è®¾ç½®å½“å‰èŠå¤©å¯¹è±¡
    const mainCharName = window.charName || '{{char}}';
    
    // é»˜è®¤æƒ…å†µï¼ˆæ²¡æœ‰ä¼ å‚æ•°ï¼‰æ‰“å¼€ä¸»è§’è‰²èŠå¤©
    if (!targetTag) {
        // Check if main char has an ID in privateChats?
        // Usually main char is special. Let's try to find it or create it.
        let mainChat = appSettings.privateChats ? appSettings.privateChats.find(c => (typeof c === 'object' ? c.name : c) === mainCharName) : null;
        if (!mainChat) {
             // Create if not exists
             const newId = generateUUID();
             if (!appSettings.privateChats) appSettings.privateChats = [];
             appSettings.privateChats.push({ id: newId, name: mainCharName });
             saveSettingsToStorage();
             mainChat = { id: newId, name: mainCharName };
        }
        
        const id = (typeof mainChat === 'object') ? mainChat.id : null; // Should be object after migration
        if (id) {
            currentChatTag = `chat:${id}`;
            currentChatId = id;
        } else {
            // Fallback
            currentChatTag = `chat:${mainCharName}`;
            currentChatId = null;
        }
        currentChatTarget = mainCharName;
    } else {
        currentChatTag = targetTag;
        currentChatTarget = targetName;
        currentChatId = targetId || (targetTag.includes(':') ? targetTag.split(':')[1] : null);
    }

    // NEW: å°è¯•åŠ è½½è¯¥è§’è‰²çš„ç‹¬ç«‹è®¾ç½® (å¦‚æœæ˜¯ç§èŠ)
    if (currentChatTag.startsWith('chat:')) {
        loadSettings(currentChatTarget);
        // ç¡®ä¿ window.charName åŒæ­¥
        window.charName = appSettings.charName;
    }

    // æ›´æ–°æ ‡é¢˜
    const headerTitleEl = document.getElementById('header-title');
    if(headerTitleEl) headerTitleEl.textContent = currentChatTarget;

    // åˆ·æ–°èŠå¤©å†…å®¹
    if (typeof loadInitialChat === 'function') loadInitialChat();

    // ä»æ¶ˆæ¯åˆ—è¡¨è¿›å…¥èŠå¤©
    if(messageListScreen) messageListScreen.style.display = 'none';
    if(chatScreen) chatScreen.style.display = 'flex';
    updateStatusBar('chat');
    setTimeout(() => { if(chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight; }, 300);
}

function goBack() {
closeMenus();

if (chatSettingsScreen && chatSettingsScreen.style.display === 'flex') {
    closeChatSettings();
    return;
}

if(chatScreen && chatScreen.style.display === 'flex') {
    // ä»èŠå¤©è¿”å›æ¶ˆæ¯åˆ—è¡¨
    chatScreen.style.display = 'none';
    if(messageListScreen) messageListScreen.style.display = 'flex';
    updateStatusBar('message-list');
    renderMessageList(); // åˆ·æ–°é¢„è§ˆ
    return;
}

if(messageListScreen && messageListScreen.style.display === 'flex') {
    // ä»æ¶ˆæ¯åˆ—è¡¨è¿”å›ä¸»å±å¹•
    messageListScreen.style.display = 'none';
    if(homeScreen) homeScreen.style.display = 'flex';
    updateStatusBar('home');
    return;
}

if(settingsScreen && settingsScreen.style.display === 'flex') {
    settingsScreen.style.display = 'none';
    if(homeScreen) homeScreen.style.display = 'flex';
    updateStatusBar('home');
    return;
}

// Fallback
if(homeScreen) homeScreen.style.display = 'flex';
updateStatusBar('home');
}

// è¾…åŠ©å‡½æ•°ï¼šä»å†å²è®°å½•å­—ç¬¦ä¸²ä¸­æå–æ‰€æœ‰èŠå¤©å—
function getAllChatsFromHistory(rawText) {
    const chats = new Map();
    // åŒ¹é… <chat:Name>...</chat:Name> æˆ– <group:NameCount>...</group:NameCount>
    // ä»¥åŠå…¼å®¹æ—§ç‰ˆæˆ–æ— å‚æ•°çš„ç»“æŸæ ‡ç­¾ </chat>, </group>
    // æ­£åˆ™ç­–ç•¥ï¼š<(type):(name)> (content) <\/type> 
    // æ³¨æ„ï¼šç»“æŸæ ‡ç­¾å¯èƒ½æ˜¯ç®€åŒ–çš„ </chat> è€Œä¸æ˜¯ </chat:name>ã€‚
    // æˆ‘ä»¬å‡è®¾ç»“æ„æ€»æ˜¯ <tag:id>...</tag>
    
    const regex = /<(chat|group):(.*?)>([\s\S]*?)<\/\1>/gi;
    let match;
    while ((match = regex.exec(rawText)) !== null) {
        const type = match[1];
        const name = match[2];
        const content = match[3];
        const key = `${type}:${name}`;
        chats.set(key, content.trim());
    }
    
    // å…¼å®¹ï¼šå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•å¸¦ ID çš„æ ‡ç­¾ï¼Œä½†æœ‰å†…å®¹ï¼Œå¯èƒ½å±äºé»˜è®¤è§’è‰²
    if (chats.size === 0 && rawText.trim().length > 0) {
         // æ£€æŸ¥æ˜¯å¦æœ‰è£¸éœ²çš„å†…å®¹æˆ–æ—§ç‰ˆæ ¼å¼
         // è¿™é‡Œæš‚å®šï¼šå¦‚æœå®Œå…¨åŒ¹é…ä¸åˆ°ï¼Œå°±ä¸å¤„ç†ï¼Œæˆ–è€…è§†ä¸ºé»˜è®¤è§’è‰²
    }
    
    return chats;
}

function renderMessageList() {
if(!messageListBody) return;
messageListBody.innerHTML = '';

const mainCharName = window.charName || '{{char}}';
const defaultAvatar = appSettings.charAvatar;

// 1. è·å–æ‰€æœ‰èŠå¤©è®°å½•å¹¶è§£æ
let chatsMap = new Map();
try {
    if (typeof getCurrentMessageId !== 'undefined') {
         const h = getChatMessages(getCurrentMessageId());
         if (h && h[0] && h[0].message) {
             const m = h[0].message.match(/<fphone>([\s\S]*?)<\/fphone>/i);
             if (m) {
                 // æå– fphone å†…éƒ¨æ‰€æœ‰å†…å®¹
                 const rawContent = m[1];
                 chatsMap = getAllChatsFromHistory(rawContent);
             }
         }
    } else {
        // Standalone Logic: Scan localStorage
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('faye-phone-history-')) {
                const tag = key.replace('faye-phone-history-', '');
                const content = localStorage.getItem(key);
                chatsMap.set(tag, content);
            }
        }
    }
} catch(e) {}

// 2. å‡†å¤‡ä¼šè¯åˆ—è¡¨æ•°æ®
const conversations = {};

// 2.1 ä» appSettings åŠ è½½é¢„è®¾ç¾¤ç»„ (ç¡®ä¿å³æ—¶æ²¡æœ‰æ¶ˆæ¯ä¹Ÿæ˜¾ç¤º)
if (appSettings.groups && Array.isArray(appSettings.groups)) {
    appSettings.groups.forEach(group => {
        // group could be {id, name, members} or legacy {name, members}
        const id = group.id || group.name; // Fallback if not migrated
        const key = `group:${id}`;
        // ä¼˜å…ˆæ˜¾ç¤ºè‡ªå®šä¹‰ç¾¤èŠå¤´åƒ
        let groupAvatar = (appSettings.groupAvatars && appSettings.groupAvatars[key])
            ? appSettings.groupAvatars[key]
            : defaultAvatar;
        conversations[key] = {
            tag: key,
            name: group.name,
            id: group.id,
            avatar: groupAvatar,
            lastMsg: 'ç‚¹å‡»è¿›å…¥ç¾¤èŠ',
            lastTime: '',
            timestamp: 0,
            isGroup: true,
            memberCount: group.members.length
        };
    });
}

// 2.2 ä» appSettings åŠ è½½é¢„è®¾ç§èŠ
if (appSettings.privateChats && Array.isArray(appSettings.privateChats)) {
    appSettings.privateChats.forEach(item => {
        let key, name, id;
        if (typeof item === 'string') {
             name = item;
             id = null;
             key = `chat:${name}`;
        } else {
             name = item.name;
             id = item.id;
             key = `chat:${id}`;
        }
        
        if (!conversations[key]) {
             conversations[key] = {
                tag: key,
                name: name,
                id: id,
                avatar: defaultAvatar, 
                lastMsg: 'ç‚¹å‡»å¼€å§‹èŠå¤©',
                lastTime: '',
                timestamp: 0,
                isGroup: false
             };
        }
    });
}

// 2.3 ç¡®ä¿é»˜è®¤è§’è‰²å­˜åœ¨
// Check if default char is already in conversations (by ID or Name)
let defaultCharExists = false;
Object.values(conversations).forEach(c => {
    if (c.name === mainCharName) defaultCharExists = true;
});

if (!defaultCharExists) {
    const defaultCharKey = `chat:${mainCharName}`;
    conversations[defaultCharKey] = {
        tag: defaultCharKey,
        name: mainCharName,
        avatar: defaultAvatar,
        lastMsg: 'ç‚¹å‡»å¼€å§‹èŠå¤©',
        lastTime: getTime(),
        timestamp: 0,
        isGroup: false
    };
}

// 2.4 éå†å†å²è®°å½•ä¸­çš„æ‰€æœ‰ä¼šè¯ï¼Œåˆå¹¶/æ›´æ–°ä¿¡æ¯
chatsMap.forEach((content, key) => {
    // key æ ¼å¼: "chat:ID" æˆ– "chat:Name" (legacy)
    const [type, ...idParts] = key.split(':');
    const idOrName = idParts.join(':'); 
    
    let displayName = idOrName;
    let isGroup = type === 'group';
    
    // Try to resolve ID to Name
    if (conversations[key]) {
        displayName = conversations[key].name;
    } else {
        // If not in conversations list, try to find by ID in appSettings
        if (isGroup && appSettings.groups) {
            const g = appSettings.groups.find(g => g.id === idOrName || g.name === idOrName);
            if (g) displayName = g.name;
        } else if (!isGroup && appSettings.privateChats) {
            const c = appSettings.privateChats.find(c => (typeof c === 'object' ? c.id === idOrName : c === idOrName));
            if (c) displayName = (typeof c === 'object' ? c.name : c);
        }
    }
    
    if (!conversations[key]) {
        // ä¼˜å…ˆæ˜¾ç¤ºè‡ªå®šä¹‰ç¾¤èŠå¤´åƒ
        let groupAvatar = (isGroup && appSettings.groupAvatars && appSettings.groupAvatars[key])
            ? appSettings.groupAvatars[key]
            : defaultAvatar;
        conversations[key] = {
            tag: key,
            name: displayName,
            id: idOrName, // Treat as ID
            avatar: isGroup ? groupAvatar : defaultAvatar,
            lastMsg: '',
            lastTime: '',
            timestamp: 0,
            isGroup: isGroup
        };
    }
    
    // è§£ææœ€åä¸€æ¡æ¶ˆæ¯
    const msgs = parseMessages(content);
    // è¿‡æ»¤æ‰éšè—æ¶ˆæ¯
    const validMsgs = msgs.filter(m => {
        if (m.header && (m.header.includes('ã€æœç´¢è®°å½•') || m.header.includes('ã€æ—¥è®°') || m.type === 'search-history')) return false;
        if (m.body && (m.body.startsWith('ã€æ—¥è®°') || m.body.startsWith('ã€æœç´¢è®°å½•'))) return false;
        return true;
    });

    if (validMsgs.length > 0) {
        const last = validMsgs[validMsgs.length - 1];
        let displayMsg = '[æ¶ˆæ¯]';
        if (last.type === 'text') displayMsg = last.body;
        else if (last.type === 'photo') displayMsg = '[å›¾ç‰‡]';
        else if (last.type === 'sticker') displayMsg = '[è¡¨æƒ…åŒ…]';
        else if (last.type === 'voice') displayMsg = '[è¯­éŸ³]';
        else if (last.type === 'file') displayMsg = '[æ–‡ä»¶]';
        else if (last.type === 'location') displayMsg = '[ä½ç½®]';
        else if (last.type === 'transfer') displayMsg = '[è½¬è´¦]';
        
        conversations[key].lastMsg = displayMsg;
        
        if (last.header) {
            const parts = last.header.replace(/^\[|\]$|^ã€|ã€‘$/g, '').split('|');
            if (parts.length > 1) conversations[key].lastTime = parts[parts.length - 1];
        }
        conversations[key].timestamp = Date.now(); // ç®€å•å¤„ç†ï¼Œå®é™…åº”è¯¥è§£ææ—¶é—´
    }
});


// 3. æ¸²æŸ“åˆ—è¡¨
Object.values(conversations).forEach(chat => {
    const item = document.createElement('div');
    item.className = 'message-list-item';
    item.onclick = () => openChat(chat.tag, chat.name, chat.id);

    // å¤„ç†ç¾¤åæ˜¾ç¤º
    let displayName = chat.name;
    
    // NEW: è·å–ç‰¹å®šå¤´åƒ (å¦‚æœå·²è®¾ç½®)
    let displayAvatar;
    if (chat.isGroup) {
        // ç¾¤èŠå¤´åƒç›´æ¥ç”¨ chat.avatarï¼ˆå·²åœ¨ conversations æ„å»ºæ—¶å¤„ç†è‡ªå®šä¹‰å¤´åƒï¼‰
        displayAvatar = chat.avatar;
    } else {
        // ç§èŠï¼šä¼˜å…ˆæ˜¾ç¤º memberAvatars é‡Œçš„å¤´åƒ
        if (appSettings.memberAvatars && appSettings.memberAvatars[displayName]) {
            displayAvatar = appSettings.memberAvatars[displayName];
        } else {
            displayAvatar = chat.avatar;
        }
    }
    item.innerHTML = `
        <img class="message-list-avatar" src="${displayAvatar}">
        <div class="message-list-info">
            <div class="message-list-top">
                <span class="message-list-name">${displayName} ${chat.isGroup ? '<span class="group-badge">ç¾¤</span>' : ''}</span>
                <span class="message-list-time">${chat.lastTime || getTime()}</span>
            </div>
            <div class="message-list-preview">${chat.lastMsg}</div>
        </div>
    `;
    messageListBody.appendChild(item);
});
}

function openSettings() {
document.getElementById('set-phone-w').value = appSettings.phoneWidth;
document.getElementById('set-phone-h').value = appSettings.phoneHeight;
document.getElementById('set-case-color').value = appSettings.caseColor;
document.getElementById('set-icon-bg').value = appSettings.iconBg;
document.getElementById('set-icon-color').value = appSettings.iconColor;
document.getElementById('set-home-text-color').value = appSettings.homeTextColor;

// AI Settings
document.getElementById('set-api-url').value = appSettings.apiUrl || '';
document.getElementById('set-api-key').value = appSettings.apiKey || '';
document.getElementById('set-model-name').value = appSettings.modelName || '';
document.getElementById('set-user-name').value = appSettings.userName || '';
document.getElementById('set-char-name').value = appSettings.charName || '';
document.getElementById('set-system-prompt').value = appSettings.systemPrompt || '';

// Calculate current custom time for display
let displayTime = '';
if (appSettings.timeOffset) {
    const now = new Date();
    const target = new Date(now.getTime() + appSettings.timeOffset);
    displayTime = `${target.getHours().toString().padStart(2,'0')}:${target.getMinutes().toString().padStart(2,'0')}`;
} else {
    displayTime = appSettings.customTime || '';
}
document.getElementById('set-custom-time').value = displayTime;

document.getElementById('preview-home-bg').src = appSettings.homeBg || '';

// æ£€æŸ¥é€‚é…å™¨æ’ä»¶è¿æ¥çŠ¶æ€
const statusEl = document.getElementById('adapter-status');
if (statusEl) {
    if (window.parent && window.parent.__fayePhoneSupport_upload) {
        statusEl.textContent = "â— å·²è¿æ¥";
        statusEl.style.color = "green";
    } else {
        statusEl.textContent = "â—‹ æœªæ£€æµ‹åˆ°æ’ä»¶";
        statusEl.style.color = "#999";
    }
}

if(homeScreen) homeScreen.style.display = 'none';
if(settingsScreen) settingsScreen.style.display = 'flex';
updateStatusBar('settings');
}

function closeSettings() {
if(settingsScreen) settingsScreen.style.display = 'none';
if(homeScreen) homeScreen.style.display = 'flex';
updateStatusBar('home');
}

function updateClock() {
let timeStr;
// åªè¦ customTime æœ‰å€¼ï¼Œå°±è¯´æ˜ç”¨æˆ·å¯ç”¨äº†è‡ªå®šä¹‰æ—¶é—´ï¼Œæ­¤æ—¶åº”è¯¥ä½¿ç”¨ timeOffset (å³ä½¿æ˜¯ 0)
if (appSettings.customTime && /^\d{1,2}:\d{2}$/.test(appSettings.customTime) && typeof appSettings.timeOffset === 'number') {
    const now = new Date();
    const target = new Date(now.getTime() + appSettings.timeOffset);
    timeStr = `${target.getHours().toString().padStart(2,'0')}:${target.getMinutes().toString().padStart(2,'0')}`;
} else {
    const now = new Date();
    timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
}
if(clockEl) clockEl.textContent = timeStr;
if(homeClockEl) homeClockEl.textContent = timeStr;
}

function updateStatusBar(screen) {
let isDark = false;
if (screen === 'home') isDark = appSettings.homeBgIsDark;
else if (screen === 'chat') isDark = appSettings.chatBgIsDark;
else if (screen === 'settings') isDark = false;
else if (screen === 'message-list') isDark = false;
else if (screen === 'dark-search') isDark = false;

if (screen === 'home' && !appSettings.homeBg) isDark = false;
if (screen === 'chat' && !appSettings.chatBg) isDark = false;

if(statusBar) statusBar.className = isDark ? 'status-bar text-light' : 'status-bar text-dark';
}

function analyzeImageBrightness(base64) {
return new Promise((resolve) => {
if (!base64) { resolve(false); return; }
const img = new Image();
img.crossOrigin = 'Anonymous';
img.src = base64;
img.onload = () => {
const canvas = document.createElement('canvas'); canvas.width = 50; canvas.height = 50;
const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 50, 50);
try {
const data = ctx.getImageData(0,0,50,50).data; let r=0,g=0,b=0;
for(let i=0; i<data.length; i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; }
resolve(((r+g+b)/(3*(data.length/4))) < 128);
} catch (e) { resolve(false); }
};
img.onerror = () => resolve(false);
});
}

let lastStorageKey = null;

function getStorageKey() {
    try {
        // 1. ä¼˜å…ˆä½¿ç”¨æ’ä»¶æä¾›çš„ç¨³å®š ID
        if (window.parent && window.parent.__fayePhoneSupport_getCharInfo) {
            const info = window.parent.__fayePhoneSupport_getCharInfo();
            if (info && info.storageKey) {
                // é¡ºä¾¿æ›´æ–°å…¨å±€è§’è‰²åï¼Œç”¨äºæ˜¾ç¤º
                if (info.name) window.charName = info.name;
                return `st-phone-settings-${info.storageKey}`;
            }
        }
    } catch(e) {}
    
    // 2. NEW: ä¼˜å…ˆä½¿ç”¨ Chat ID
    if (currentChatId) {
        return `st-phone-settings-${currentChatId}`;
    }

    // 3. å›é€€åˆ°åŸºäºåå­—çš„ Key
    // ä¼˜å…ˆä½¿ç”¨ appSettings ä¸­çš„ charNameï¼Œå› ä¸ºå®ƒæ˜¯æˆ‘ä»¬æ‰‹åŠ¨è®¾ç½®çš„
    if (appSettings.charName && appSettings.charName !== 'è§’è‰²') {
        return `st-phone-settings-${appSettings.charName}`;
    }

    const name = getCurrentCharacterName();
    if (name && name !== '{{char}}') {
        window.charName = name;
        return `st-phone-settings-${name}`;
    }
    
    return 'st-phone-settings-global';
}

function loadSettings(targetCharName) {
    // 1. å…ˆåŠ è½½å…¨å±€è®¾ç½®
    let globalSettings = { ...defaultAppSettings };
    const globalSaved = localStorage.getItem('st-phone-settings-global');
    if (globalSaved) {
        try {
            const parsed = JSON.parse(globalSaved);
            globalSettings = { ...globalSettings, ...parsed };
        } catch(e) {}
    }
    
    // ä¸´æ—¶æ›´æ–° appSettings ä»¥ä¾¿ getStorageKey èƒ½è·å–åˆ°æ­£ç¡®çš„ Key
    if (targetCharName) {
        appSettings.charName = targetCharName;
    } else if (globalSettings.charName) {
        // åªæœ‰åœ¨æ²¡æœ‰æŒ‡å®šç›®æ ‡ï¼Œä¸”æ²¡æœ‰å½“å‰ ID æ—¶ï¼Œæ‰å›é€€åˆ°å…¨å±€è®°å½•çš„åå­—
        if (!currentChatId) {
            appSettings.charName = globalSettings.charName;
        }
    }

    const key = getStorageKey();
    const isSpecificChat = (key !== 'st-phone-settings-global');

    // 2. åŠ è½½ç‰¹å®šè®¾ç½®
    let currentSettings = {};
    if (isSpecificChat) {
        const saved = localStorage.getItem(key);
        if (saved) {
            try {
                currentSettings = JSON.parse(saved);
            } catch(e) {}
        }
    }

    // 3. åˆå¹¶ç­–ç•¥ (ä¸¥æ ¼éš”ç¦»ï¼Œé˜²æ­¢ä¸²å°)
    if (isSpecificChat) {
        // å®šä¹‰å­—æ®µåˆ†ç±»
        const globalFields = [
            'phoneWidth', 'phoneHeight', 'caseColor', 'iconBg', 'iconColor', 
            'homeTextColor', 'homeBg', 'homeBgIsDark', 'customTime', 'timeOffset',
            'apiUrl', 'apiKey', 'modelName', 'groups', 'privateChats', 'memberAvatars'
        ];
        
        const roleFields = [
            'charName', 'userName', 'systemPrompt', 'userPersona', 
            'charAvatar', 'userAvatar', 'charBubble', 'charText', 
            'userBubble', 'userText', 'blockChar', 'blockUser', 
            'chatBg', 'chatBgIsDark'
        ];

        // é‡ç½® appSettings ä¸ºé»˜è®¤å€¼ï¼Œä½œä¸ºåº•æ¿
        appSettings = { ...defaultAppSettings };

        // A. åº”ç”¨å…¨å±€å­—æ®µ (ä» globalSettings)
        globalFields.forEach(f => {
            if (globalSettings[f] !== undefined) appSettings[f] = globalSettings[f];
        });

        // B. åº”ç”¨è§’è‰²å­—æ®µ (åªä» currentSettings åŠ è½½ï¼Œç»å¯¹ä¸ä» globalSettings åŠ è½½)
        roleFields.forEach(f => {
            if (currentSettings[f] !== undefined) {
                appSettings[f] = currentSettings[f];
            } else {
                // å¦‚æœç‹¬ç«‹è®¾ç½®é‡Œæ²¡æœ‰ï¼Œä¿æŒ defaultAppSettings çš„é»˜è®¤å€¼
                // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯åˆ‡æ¢èŠå¤©ï¼Œç¡®ä¿ charName æ˜¯ç›®æ ‡åå­—
                if (f === 'charName' && targetCharName) {
                    appSettings.charName = targetCharName;
                }
            }
        });
        
        // C. å…¶å®ƒæœªåˆ†ç±»å­—æ®µ (å¦‚ groupAvatars ç­‰)ï¼Œå¯ä»¥ä» currentSettings ç»§æ‰¿
        Object.keys(currentSettings).forEach(k => {
            if (!globalFields.includes(k) && !roleFields.includes(k)) {
                appSettings[k] = currentSettings[k];
            }
        });

    } else {
        // å…¨å±€æ¨¡å¼ï¼ˆæ— ç‰¹å®šè§’è‰²ï¼‰ï¼Œç›´æ¥åˆå¹¶
        appSettings = { ...globalSettings, ...currentSettings };
    }
    
    // 4. ç¡®ä¿ API è®¾ç½®æœ‰å›é€€ (æ–¹ä¾¿ç”¨æˆ·åªåœ¨å…¨å±€è®¾ç½®ä¸€æ¬¡)
    if (!appSettings.apiUrl && globalSettings.apiUrl) appSettings.apiUrl = globalSettings.apiUrl;
    if (!appSettings.apiKey && globalSettings.apiKey) appSettings.apiKey = globalSettings.apiKey;
    if (!appSettings.modelName && globalSettings.modelName) appSettings.modelName = globalSettings.modelName;

    // 5. å¼ºåˆ¶ä¸»å±ç›¸å…³å­—æ®µåªç”¨å…¨å±€ (é˜²æ­¢è§’è‰²è®¾ç½®æ„å¤–è¦†ç›–äº†æ‰‹æœºå¤–è§‚)
    appSettings.phoneWidth = globalSettings.phoneWidth;
    appSettings.phoneHeight = globalSettings.phoneHeight;
    appSettings.caseColor = globalSettings.caseColor;
    appSettings.iconBg = globalSettings.iconBg;
    appSettings.iconColor = globalSettings.iconColor;
    appSettings.homeTextColor = globalSettings.homeTextColor;
    appSettings.homeBg = globalSettings.homeBg;
    appSettings.homeBgIsDark = globalSettings.homeBgIsDark;
    appSettings.customTime = globalSettings.customTime;
    appSettings.timeOffset = Number(globalSettings.timeOffset);
    if (isNaN(appSettings.timeOffset)) appSettings.timeOffset = 0;

    // 6. Update globals
    if (appSettings.userName) window.userName = appSettings.userName;
    if (appSettings.charName) window.charName = appSettings.charName;

    // 7. Validate Paths
    const charName = window.charName;
    if (charName) {
        const validatePath = (path, defaultVal) => {
            if (!path || typeof path !== 'string' || !path.includes('/user/images/')) return path;
            try {
                const decoded = decodeURI(path);
                const match = decoded.match(/\/user\/images\/([^/]+)\//);
                if (match && match[1] && match[1] !== charName) {
                    return defaultVal;
                }
            } catch(e) {}
            return path;
        };
        appSettings.chatBg = validatePath(appSettings.chatBg, defaultAppSettings.chatBg);
        appSettings.homeBg = validatePath(appSettings.homeBg, defaultAppSettings.homeBg);
        appSettings.charAvatar = validatePath(appSettings.charAvatar, defaultAppSettings.charAvatar);
        appSettings.userAvatar = validatePath(appSettings.userAvatar, defaultAppSettings.userAvatar);
    }
}

// Helper to get robust character name
function getCurrentCharacterName() {
    try {
        if (window.parent && window.parent.TavernHelper) {
            // 1. Try RawCharacter (Most reliable if available)
            if (window.parent.TavernHelper.RawCharacter && window.parent.TavernHelper.RawCharacter.find) {
                const char = window.parent.TavernHelper.RawCharacter.find({name: 'current'});
                if (char && char.name) return char.name;
            }
            // 2. Fallback to getCharData
            const charData = window.parent.TavernHelper.getCharData('current');
            if (charData && charData.name) return charData.name;
        }
    } catch (e) { console.error("Error getting char name:", e); }
    
    // 3. Fallback to window.charName
    if (window.charName && window.charName !== '{{char}}') return window.charName;
    
    // 4. Fallback to cached initial name
    if (initialCharName && initialCharName !== '{{char}}') return initialCharName;
    
    // 5. Fallback to DOM title (last resort)
    const titleEl = document.getElementById('header-title');
    if (titleEl && titleEl.textContent && titleEl.textContent !== '{{char}}') return titleEl.textContent;
    
    return null;
}

function saveSettingsToStorage() { 
    const key = getStorageKey();
    localStorage.setItem(key, JSON.stringify(appSettings));
}

async function checkCharacterChange() {
    const currentKey = getStorageKey();
    if (!currentKey) return;
    
    if (lastStorageKey !== currentKey) {
        lastStorageKey = currentKey;
        
        // Update UI Title
        if (window.charName && headerTitle) headerTitle.textContent = window.charName;
        
        // Reload settings for new character
        loadSettings();
        
        // Update Avatar from Tavern
        if (window.parent && window.parent.TavernHelper) {
            const avatarUrl = window.parent.TavernHelper.getCharAvatarPath('current');
            if (avatarUrl && !appSettings.charAvatar) {
                appSettings.charAvatar = `${avatarUrl}?t=${Date.now()}`;
            }
        }
        
        applySettings();
        updateClock(); // ç¡®ä¿æ—¶é—´ç«‹å³æ›´æ–°
        
        // Reload chat history for new character
        try { loadInitialChat(); } catch(e){}
    }
}


function hexToRgba(hex, alpha) {
let r = 0, g = 0, b = 0;
if (hex.length === 4) {
r = parseInt("0x" + hex[1] + hex[1]);
g = parseInt("0x" + hex[2] + hex[2]);
b = parseInt("0x" + hex[3] + hex[3]);
} else if (hex.length === 7) {
r = parseInt("0x" + hex[1] + hex[2]);
g = parseInt("0x" + hex[3] + hex[4]);
b = parseInt("0x" + hex[5] + hex[6]);
}
return `rgba(${r},${g},${b},${alpha})`;
}

function applySettings() {
if(phoneContainer) {
    phoneContainer.style.width = (appSettings.phoneWidth || 350) + 'px';
    phoneContainer.style.height = (appSettings.phoneHeight || 650) + 'px';
    phoneContainer.style.borderColor = appSettings.caseColor;
    phoneContainer.style.backgroundColor = appSettings.caseColor; // ä¿®å¤åœ†è§’ç¼éš™ï¼šèƒŒæ™¯è‰²è·Ÿéšæ‰‹æœºå£³é¢œè‰²
}
if(homeScreen) {
    if (appSettings.homeBg) homeScreen.style.backgroundImage = `url(${appSettings.homeBg})`;
    else { homeScreen.style.backgroundImage = 'none'; homeScreen.style.backgroundColor = '#f3e5f5'; }
}
if(chatScreen) {
    if (appSettings.chatBg) { chatScreen.style.backgroundImage = `url(${appSettings.chatBg})`; chatScreen.style.backgroundColor = '#f9f9f9'; }
    else { chatScreen.style.backgroundImage = 'none'; chatScreen.style.backgroundColor = '#fff'; }
}

document.querySelectorAll('.app-icon-style').forEach(el => {
    el.style.background = appSettings.iconBg;
    const svg = el.querySelector('svg');
    if (svg) svg.style.fill = appSettings.iconColor;
    const mask = el.querySelector('.app-icon-image');
    if (mask) mask.style.backgroundColor = appSettings.iconColor;
});

if (appSettings.homeTextColor) {
    if(homeClockEl) homeClockEl.style.color = appSettings.homeTextColor;
    document.querySelectorAll('.app-name').forEach(el => el.style.color = appSettings.homeTextColor);
}

// åªåœ¨èŠå¤©ç›¸å…³é¡µé¢è®¾ç½® --interface-bg
const rgba = hexToRgba(appSettings.interfaceColor || '#f7f7f7', 0.6);
if (chatScreen) chatScreen.style.setProperty('--interface-bg', rgba);
if (document.getElementById('chat-settings-screen')) document.getElementById('chat-settings-screen').style.setProperty('--interface-bg', rgba);
// ä¸»å±å’Œæ¶ˆæ¯åˆ—è¡¨ä¸è®¾ç½® --interface-bgï¼Œä¿æŒåŸæœ‰è‰²å½©

const rootStyle = document.documentElement.style;
rootStyle.setProperty('--msg-name-color', appSettings.msgNameColor || '#999999');
rootStyle.setProperty('--msg-time-color', appSettings.msgTimeColor || '#b0b0b0');
rootStyle.setProperty('--msg-font-size', (appSettings.fontSize || 14) + 'px');
const btnRgba = hexToRgba(appSettings.chatBtnColor || '#f2b5b6', 0.6);
rootStyle.setProperty('--chat-btn-color', btnRgba);
rootStyle.setProperty('--chat-btn-text', appSettings.chatBtnText || '#2ea0a0');
// æ‰‹æœºå®½åº¦å˜é‡ï¼ˆç”¨äºè®¡ç®—æ°”æ³¡æœ€å¤§å®½åº¦ï¼‰ï¼Œé»˜è®¤330px
rootStyle.setProperty('--phone-width-px', ((appSettings.phoneWidth && !isNaN(appSettings.phoneWidth)) ? appSettings.phoneWidth : 330) + 'px');

updateStatusBar('home'); loadInitialChat();
}

function handleUploadUrl(targetId) {
openModal('è¾“å…¥å›¾ç‰‡é“¾æ¥', [{ placeholder: 'https://...' }], (values) => {
const url = values[0];
if (url) {
const el = document.getElementById('preview-' + targetId);
if (el) el.src = url;
}
});
}

async function testApiConnection() {
    const url = document.getElementById('set-api-url').value.replace(/\/$/, '');
    const key = document.getElementById('set-api-key').value;
    const light = document.getElementById('api-status-light');
    const select = document.getElementById('set-model-name');
    
    if (!url || !key) { alert('è¯·å¡«å†™ API åœ°å€å’Œ Key'); return; }
    
    light.style.background = '#ffeb3b'; // Yellow (Testing)
    
    try {
        // Try fetching models
        let fetchUrl = url;
        if (!fetchUrl.endsWith('/models')) fetchUrl += '/models';

        const res = await fetch(fetchUrl, {
            headers: { 'Authorization': `Bearer ${key}` }
        });
        
        if (res.ok) {
            const data = await res.json();
            light.style.background = '#4caf50'; // Green (Success)
            
            // Populate select
            select.innerHTML = '';
            let models = [];
            if (Array.isArray(data.data)) models = data.data;
            else if (Array.isArray(data)) models = data;
            
            if (models.length > 0) {
                models.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.id;
                    select.appendChild(opt);
                });
                // Restore previous selection if exists
                if (appSettings.modelName) {
                    select.value = appSettings.modelName;
                }
            } else {
                const opt = document.createElement('option');
                opt.value = appSettings.modelName || 'gpt-3.5-turbo';
                opt.textContent = appSettings.modelName || 'gpt-3.5-turbo';
                select.appendChild(opt);
            }
        } else {
            throw new Error('Status ' + res.status);
        }
    } catch (e) {
        console.error(e);
        light.style.background = '#f44336'; // Red (Fail)
        alert('è¿æ¥å¤±è´¥: ' + e.message);
    }
}

async function saveHomeSettings() {
appSettings.phoneWidth = document.getElementById('set-phone-w').value || 350;
appSettings.phoneHeight = document.getElementById('set-phone-h').value || 650;
appSettings.caseColor = document.getElementById('set-case-color').value;
appSettings.iconBg = document.getElementById('set-icon-bg').value;
appSettings.iconColor = document.getElementById('set-icon-color').value;
appSettings.homeTextColor = document.getElementById('set-home-text-color').value;

// AI Settings
appSettings.apiUrl = document.getElementById('set-api-url').value;
appSettings.apiKey = document.getElementById('set-api-key').value;
appSettings.modelName = document.getElementById('set-model-name').value;

const timeInput = document.getElementById('set-custom-time').value;
if (timeInput && /^\d{1,2}:\d{2}$/.test(timeInput)) {
    const now = new Date();
    const [h, m] = timeInput.split(':');
    const target = new Date(now);
    target.setHours(parseInt(h));
    target.setMinutes(parseInt(m));
    target.setSeconds(0);
    // Calculate offset: Target Time - Real Time
    appSettings.timeOffset = target.getTime() - now.getTime();
    appSettings.customTime = timeInput; 
} else {
    appSettings.timeOffset = 0;
    appSettings.customTime = '';
}

const homeBgUrl = document.getElementById('preview-home-bg').src;
if (homeBgUrl && homeBgUrl !== window.location.href) {
appSettings.homeBg = homeBgUrl;
appSettings.homeBgIsDark = await analyzeImageBrightness(appSettings.homeBg);
}

// Save to current key
saveSettingsToStorage(); 

// Sync global fields to global storage (Ensure time/appearance settings persist across reloads)
try {
    let globalData = {};
    try {
        const raw = localStorage.getItem('st-phone-settings-global');
        if (raw) globalData = JSON.parse(raw);
    } catch(e) { console.error('Parse global settings error', e); }
    
    globalData.phoneWidth = appSettings.phoneWidth;
    globalData.phoneHeight = appSettings.phoneHeight;
    globalData.caseColor = appSettings.caseColor;
    globalData.iconBg = appSettings.iconBg;
    globalData.iconColor = appSettings.iconColor;
    globalData.homeTextColor = appSettings.homeTextColor;
    globalData.homeBg = appSettings.homeBg;
    globalData.homeBgIsDark = appSettings.homeBgIsDark;
    globalData.customTime = appSettings.customTime;
    globalData.timeOffset = appSettings.timeOffset;
    
    localStorage.setItem('st-phone-settings-global', JSON.stringify(globalData));
} catch(e) { console.error('Failed to sync global settings', e); }

applySettings(); closeSettings();
}

function renderAvatarSettings() {
    const container = document.getElementById('avatar-settings-container');
    if (!container) return;
    container.innerHTML = '';
    
    const isGroup = currentChatTag && currentChatTag.startsWith('group:');
    let members = [];
    const myName = window.userName || '{{user}}';

    // ç¾¤èŠå¤´åƒï¼ˆé»˜è®¤å¤´åƒï¼‰
    if (isGroup) {
        // é¡¶éƒ¨æ’å…¥ç¾¤èŠå¤´åƒ
        const groupAvatarDiv = document.createElement('div');
        groupAvatarDiv.className = 'avatar-grid-item';
        const groupImg = document.createElement('img');
        groupImg.className = 'avatar-sq';
        // æ”¯æŒè‡ªå®šä¹‰ç¾¤èŠå¤´åƒ
        let groupAvatar = appSettings.groupAvatars && appSettings.groupAvatars[currentChatTag]
            ? appSettings.groupAvatars[currentChatTag]
            : 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2IwYjBiMCI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZjJmMmYyIi8+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OS00IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==';
        groupImg.src = groupAvatar;
        groupImg.style.border = '2px solid #ffb6b6';
        groupImg.style.background = '#fff';
        groupImg.title = 'ç¾¤èŠå¤´åƒ';
        groupImg.onclick = () => triggerSettingsUpload('group-avatar');
        const groupLabel = document.createElement('span');
        groupLabel.className = 'avatar-name';
        groupLabel.textContent = 'ç¾¤èŠå¤´åƒ';
        groupAvatarDiv.appendChild(groupImg);
        groupAvatarDiv.appendChild(groupLabel);
        container.appendChild(groupAvatarDiv);
    }

    if (isGroup) {
        // Group Logic
        const tag = currentChatTag;
        const groupInfo = appSettings.groups ? appSettings.groups.find(g => `group:${g.name}` === tag) : null;
        if (groupInfo) {
            groupInfo.members.forEach(m => {
                const isMe = (m === myName || m === '{{user}}' || m === 'User' || m === 'æˆ‘');
                // ä¼˜å…ˆæ˜¾ç¤ºè‡ªå®šä¹‰å¤´åƒ
                let av = (appSettings.memberAvatars && appSettings.memberAvatars[m])
                    ? appSettings.memberAvatars[m]
                    : 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2IwYjBiMCI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZjJmMmYyIi8+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OS00IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==';
                let uploadKey = `member:${m}`;
                if (isMe) uploadKey = 'user-avatar';
                members.push({ name: m, isMe: isMe, avatar: av, uploadKey: uploadKey });
            });
        } else {
            members.push({ name: 'ç¾¤æˆå‘˜', isMe: false, avatar: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2IwYjBiMCI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZjJmMmYyIi8+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OS00IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==', uploadKey: 'char-avatar' });
        }
    } else {
        // ç§èŠï¼šæˆ‘å’Œå¯¹æ–¹
        members.push({ name: myName, isMe: true, avatar: appSettings.userAvatar, uploadKey: 'user-avatar' });
        const targetName = currentChatTarget || (window.charName || '{{char}}');
        const av = (appSettings.memberAvatars && appSettings.memberAvatars[targetName]) ? appSettings.memberAvatars[targetName] : appSettings.charAvatar;
        members.push({ name: targetName, isMe: false, avatar: av, uploadKey: `member:${targetName}` });
    }

    // Render Grid
    members.forEach(m => {
        const item = document.createElement('div');
        item.className = 'avatar-grid-item';
        const img = document.createElement('img');
        img.className = 'avatar-sq';
        img.src = m.avatar;
        img.onclick = () => triggerSettingsUpload(m.uploadKey);
        const safeId = 'preview-av-' + m.uploadKey.replace(/[^a-zA-Z0-9]/g, '');
        img.id = safeId;
        const label = document.createElement('span');
        label.className = 'avatar-name';
        label.textContent = m.isMe ? '{{user}}' : m.name;
        item.appendChild(img);
        item.appendChild(label);
        container.appendChild(item);
    });
}

function openChatSettings() {
document.getElementById('set-char-bubble').value = appSettings.charBubble;
document.getElementById('set-char-text').value = appSettings.charText;
document.getElementById('set-user-bubble').value = appSettings.userBubble;
document.getElementById('set-user-text').value = appSettings.userText;
// Avatars are now handled by renderAvatarSettings
// document.getElementById('preview-char-avatar').src = appSettings.charAvatar;
// document.getElementById('preview-user-avatar').src = appSettings.userAvatar;
document.getElementById('preview-chat-bg').src = appSettings.chatBg || '';
document.getElementById('set-interface-color').value = appSettings.interfaceColor || '#f7f7f7';
document.getElementById('set-msg-name-color').value = appSettings.msgNameColor || '#999999';
document.getElementById('set-msg-time-color').value = appSettings.msgTimeColor || '#b0b0b0';
document.getElementById('set-font-size').value = appSettings.fontSize || 14;
document.getElementById('set-chat-btn-text').value = appSettings.chatBtnText || '#2ea0a0';
document.getElementById('set-block-char').checked = appSettings.blockChar || false;
document.getElementById('set-block-user').checked = appSettings.blockUser || false;

// Role Settings
document.getElementById('set-user-name').value = appSettings.userName || 'ç”¨æˆ·';
document.getElementById('set-char-name').value = appSettings.charName || 'è§’è‰²';
document.getElementById('set-system-prompt').value = appSettings.systemPrompt || '';
document.getElementById('set-user-persona').value = appSettings.userPersona || '';

// Render the dynamic avatar grid
renderAvatarSettings();

    // ä¸å†åœ¨èŠå¤©è®¾ç½®ä¸­æ˜¾ç¤ºâ€œä¿®æ”¹ç¾¤åâ€æŒ‰é’®ï¼ˆåŠŸèƒ½å·²ç§»é™¤ï¼‰

// åˆ‡æ¢åˆ°è®¾ç½®é¡µé¢
if(chatSettingsScreen) chatSettingsScreen.style.display = 'flex';
updateStatusBar('settings');
}

function closeChatSettings() {
    if(chatSettingsScreen) chatSettingsScreen.style.display = 'none';
    updateStatusBar('chat');
}

async function saveChatSettings() {
appSettings.charBubble = document.getElementById('set-char-bubble').value;
appSettings.charText = document.getElementById('set-char-text').value;
appSettings.userBubble = document.getElementById('set-user-bubble').value;
appSettings.userText = document.getElementById('set-user-text').value;
appSettings.interfaceColor = document.getElementById('set-interface-color').value;
appSettings.msgNameColor = document.getElementById('set-msg-name-color').value;
appSettings.msgTimeColor = document.getElementById('set-msg-time-color').value;
appSettings.fontSize = parseInt(document.getElementById('set-font-size').value) || 14;
appSettings.chatBtnText = document.getElementById('set-chat-btn-text').value;
appSettings.blockChar = document.getElementById('set-block-char').checked;
appSettings.blockUser = document.getElementById('set-block-user').checked;

// Role Settings
appSettings.userName = document.getElementById('set-user-name').value;
appSettings.charName = document.getElementById('set-char-name').value;
appSettings.systemPrompt = document.getElementById('set-system-prompt').value;
appSettings.userPersona = document.getElementById('set-user-persona').value;

// Update globals
window.userName = appSettings.userName;
window.charName = appSettings.charName;

// Sync critical role info to global settings for bootstrap - REMOVED to prevent persona leaking
// We only want global settings (appearance etc) in global storage.
// Role specific settings should stay in role-specific storage.

// Avatars are updated immediately via upload callback, no need to save from specific elements here
// But we need to ensure appSettings is persisted
const chatBgUrl = document.getElementById('preview-chat-bg').src;
if (chatBgUrl && chatBgUrl !== window.location.href) {
appSettings.chatBg = chatBgUrl;
appSettings.chatBgIsDark = await analyzeImageBrightness(appSettings.chatBg);
}
saveSettingsToStorage(); applySettings(); closeChatSettings(); closeMenus();
}

async function deleteCurrentChat() {
    if (!currentChatTag) return;
    if (!confirm('ç¡®å®šè¦åˆ é™¤ä¸ ' + currentChatTarget + ' çš„èŠå¤©å—ï¼Ÿ\nåˆ é™¤åæ— æ³•æ¢å¤èŠå¤©è®°å½•ã€‚')) return;

    // 1. ä» appSettings ä¸­ç§»é™¤åˆ—è¡¨é¡¹
    if (currentChatTag.startsWith('chat:')) {
        // ç§èŠ: tag is "chat:ID" or "chat:Name"
        const idOrName = currentChatTag.replace('chat:', '');
        if (appSettings.privateChats) {
            appSettings.privateChats = appSettings.privateChats.filter(c => {
                if (typeof c === 'string') return c !== idOrName;
                return c.id !== idOrName && c.name !== idOrName;
            });
        }
    } else if (currentChatTag.startsWith('group:')) {
        // ç¾¤èŠ: tag is "group:ID" or "group:Name"
        const idOrName = currentChatTag.replace(/^group:/, '');
        if (appSettings.groups) {
             appSettings.groups = appSettings.groups.filter(g => g.id !== idOrName && g.name !== idOrName);
        }
    }
    saveSettingsToStorage();

    // 2. ä» XML å†å²è®°å½•ä¸­ç‰©ç†åˆ é™¤å†…å®¹
    try {
        if (typeof getCurrentMessageId !== 'undefined') {
            const history = getChatMessages(getCurrentMessageId());
            if (history && history[0]) {
                const m = history[0].message.match(/<fphone>([\s\S]*?)<\/fphone>/i);
                if (m) {
                    let rawContent = m[1];
                    const [type, ...idParts] = currentChatTag.split(':');
                    const idOrName = idParts.join(':');

                    // Regex to match <type:idOrName>content</type>
                    const safeId = idOrName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`<${type}:${safeId}>[\\s\\S]*?<\\/${type}>`, 'gi');

                    let newContent = rawContent.replace(regex, '').trim();

                    // Update SillyTavern history
                    const finalMsg = `<fphone>\n${newContent}\n</fphone>`;
                    await setChatMessages([{ message_id: getCurrentMessageId(), message: finalMsg }], { refresh: 'none' });
                }
            }
        } else {
            // Standalone Logic: Remove from localStorage
            localStorage.removeItem(`faye-phone-history-${currentChatTag}`);
            // Also remove settings if any
            if (currentChatId) {
                localStorage.removeItem(`st-phone-settings-${currentChatId}`);
            }
        }
    } catch (e) {
        console.error("Failed to delete chat history", e);
    }

    // 3. UI è·³è½¬
    closeChatSettings();
    goBack(); // å›åˆ°æ¶ˆæ¯åˆ—è¡¨
}

function closeModal() {
// If input modal is visible, close ONLY the input modal
if(modal && modal.classList.contains('show')) {
modal.classList.remove('show');
currentConfirmAction = null; // Cleanup current action
return;
}
// Chat settings modal logic removed since it's now a screen
currentConfirmAction = null;
}
function toBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = () => reject(new Error('Failed to read file')); }); }

function closeMenus() {
if(actionMenu) actionMenu.classList.remove('open');
if(plusButton) plusButton.classList.remove('active');
if(emojiMenu) emojiMenu.classList.remove('open');
}

function initStickers() {
if(!emojiMenu) return;
emojiMenu.innerHTML = '';
const addBtn = document.createElement('div');
addBtn.className = 'sticker-item';
addBtn.onclick = handleAddSticker;
addBtn.innerHTML = `<div class="sticker-add-btn"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg></div><span class="sticker-name">æ·»åŠ </span>`;
emojiMenu.appendChild(addBtn);

myStickerList.forEach((s, index) => {
const div = document.createElement('div');
div.className = 'sticker-item';
div.onclick = () => { if(!div.classList.contains('delete-mode')) sendSticker(s.name, s.url); };
div.innerHTML = `<img src="${s.url}" class="sticker-img"><span class="sticker-name">${s.name}</span>`;
addStickerLongPressHandler(div, index);
emojiMenu.appendChild(div);
});
}

function handleAddSticker() {
openModal('æ‰¹é‡æ·»åŠ è¡¨æƒ…åŒ…', [{ placeholder: 'æ ¼å¼: åå­—1é“¾æ¥1,åå­—2é“¾æ¥2' }], (values) => {
const input = values[0];
if(!input) return;
const items = input.split(/,|ï¼Œ/);
let addedCount = 0;
items.forEach(item => {
item = item.trim();
if(!item) return;
const match = item.match(/^(.*?)(https?:\/\/.*)$/);
if(match) {
const name = match[1].trim() || 'è¡¨æƒ…';
const url = match[2].trim();
myStickerList.unshift({ name, url });
addedCount++;
}
});
if(addedCount > 0) { saveStickers(); initStickers(); }
});
}

function saveStickers() { localStorage.setItem('st-phone-stickers', JSON.stringify(myStickerList)); }

function addStickerLongPressHandler(el, index) {
let timer;
const start = (e) => {
if(e.target.closest('.delete-btn')) return;
el.classList.add('pressing');
timer = setTimeout(() => { el.classList.remove('pressing'); showStickerDeleteButton(el, index); }, 500);
};
const cancel = () => { clearTimeout(timer); el.classList.remove('pressing'); };
el.addEventListener('mousedown', start);
el.addEventListener('touchstart', start, {passive:true});
['mouseup','mouseleave','touchend','touchmove'].forEach(ev => el.addEventListener(ev, cancel));
}

function showStickerDeleteButton(el, index) {
document.querySelectorAll('.sticker-item .delete-btn').forEach(b => b.remove());
document.querySelectorAll('.sticker-item.delete-mode').forEach(i => i.classList.remove('delete-mode'));
el.classList.add('delete-mode');
const btn = document.createElement('div');
btn.className = 'delete-btn';
btn.innerHTML = `<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
btn.onclick = (e) => { e.stopPropagation(); myStickerList.splice(index, 1); saveStickers(); initStickers(); };
el.appendChild(btn);
}

function handleAction(type) {
if (type === 'location') openModal('å‘é€ä½ç½®', [{ placeholder: 'åœ°ç‚¹åç§°' }], (v) => sendLocation(v[0]));
else if (type === 'transfer') openModal('è½¬è´¦ç»™å¯¹æ–¹', [{ placeholder: 'é‡‘é¢ (å¦‚ï¼šÂ¥ 520.00)' }, { placeholder: 'å¤‡æ³¨ (å¯é€‰)' }], (v) => sendTransfer(v[0], v[1]));
else if (type === 'file') openModal('å‘é€æ–‡ä»¶', [{ placeholder: 'æ–‡ä»¶åç§° (å¦‚ï¼šæŠ¥å‘Š.pdf)' }], (v) => sendFile(v[0]));
else if (type === 'voice') {
    openModal('å‘é€è¯­éŸ³', [{ placeholder: 'æ—¶é•¿ (ç§’)' }, { placeholder: 'è½¬æ–‡å­—å†…å®¹' }], (v) => sendVoice(v[0], v[1]));
}
else if (type === 'settings') openChatSettings();
else if (type === 'photo') { if(photoInput) photoInput.click(); }
else if (type === 'call') { startVoiceCall(); }
else if (type === 'camera') { if(videoInput) videoInput.click(); }
}

function openModal(title, fields, confirmCallback) {
modalTitle.textContent = title; modalInputsContainer.innerHTML = '';
fields.forEach(field => { const input = document.createElement('input'); input.type = 'text'; input.className = 'modal-input'; input.placeholder = field.placeholder; modalInputsContainer.appendChild(input); });
currentConfirmAction = confirmCallback; modal.classList.add('show');
}

async function sendLocation(addr) { try { const t = getTime(); const u = window.userName || '{{user}}'; const h = appSettings.blockUser ? `[${u}|ä½ç½®|${t}|!]` : `[${u}|ä½ç½®|${t}]`; renderMessageToUI({ header: h, body: addr, isUser: true, type: 'location' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendTransfer(amt, note) { try { const t = getTime(); const u = window.userName || '{{user}}'; const h = appSettings.blockUser ? `[${u}|è½¬è´¦|${t}|!]` : `[${u}|è½¬è´¦|${t}]`; renderMessageToUI({ header: h, body: `${amt}|${note||''}`, isUser: true, type: 'transfer' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendFile(fn) { try { const t = getTime(); const u = window.userName || '{{user}}'; const h = appSettings.blockUser ? `[${u}|æ–‡ä»¶|${t}|!]` : `[${u}|æ–‡ä»¶|${t}]`; renderMessageToUI({ header: h, body: fn, isUser: true, type: 'file' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendVoice(dur, txt) { try { const t = getTime(); const u = window.userName || '{{user}}'; const h = appSettings.blockUser ? `[${u}|è¯­éŸ³|${t}|!]` : `[${u}|è¯­éŸ³|${t}]`; renderMessageToUI({ header: h, body: `${dur}|${txt||''}`, isUser: true, type: 'voice' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendPhoto(base64) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|å›¾ç‰‡|${t}]`, body: base64, isUser: true, type: 'photo' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendRealAudio(url) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|è¯­éŸ³|${t}]`, body: url, isUser: true, type: 'voice' }); await rebuildAndSaveHistory(); } catch (e) {} }
async function sendVideo(url) { try { const t = getTime(); const u = window.userName || '{{user}}'; renderMessageToUI({ header: `[${u}|è§†é¢‘|${t}]`, body: url, isUser: true, type: 'video' }); await rebuildAndSaveHistory(); } catch (e) {} }


async function sendSticker(name, url) {
const filename = url.split('/').pop();
const bodyText = name + filename;
const t = getTime();
const u = window.userName || '{{user}}';
renderMessageToUI({ header: `[${u}|è¡¨æƒ…åŒ…|${t}]`, body: bodyText, isUser: true, type: 'sticker' });
await rebuildAndSaveHistory();
}

// é¢„è§ˆå’Œå‘é€æ–‡ä»¶ç›¸å…³
function handleFileSelect(file) {
    if (!file) return;
    pendingFile = file;
    
    // æ˜¾ç¤ºé¢„è§ˆæ¡
    if (mediaPreviewBar) mediaPreviewBar.classList.add('visible');
    
    // å¦‚æœæ˜¯å›¾ç‰‡ï¼Œè¯»å–å¹¶æ˜¾ç¤ºç¼©ç•¥å›¾
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
            if (previewImage) {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
            }
            if (previewFileIcon) previewFileIcon.style.display = 'none';
        };
        reader.readAsDataURL(file);
    } 
    // å¦‚æœæ˜¯éŸ³é¢‘ï¼Œæ˜¾ç¤ºéŸ³ç¬¦å›¾æ ‡
    else if (file.type.startsWith('audio/')) {
        if (previewImage) previewImage.style.display = 'none';
        if (previewFileIcon) {
            previewFileIcon.textContent = 'ğŸµ';
            previewFileIcon.style.display = 'block';
        }
    }
    // å¦‚æœæ˜¯è§†é¢‘ï¼Œæ˜¾ç¤ºè§†é¢‘å›¾æ ‡
    else if (file.type.startsWith('video/')) {
        if (previewImage) previewImage.style.display = 'none';
        if (previewFileIcon) {
            previewFileIcon.textContent = 'ğŸ¬';
            previewFileIcon.style.display = 'block';
        }
    }
}

// å…¨å±€æš´éœ²æ¸…ç†å‡½æ•°
window.clearPreview = function() {
    pendingFile = null;
    if (mediaPreviewBar) mediaPreviewBar.classList.remove('visible');
    if (photoInput) photoInput.value = '';
    if (audioInput) audioInput.value = '';
}


async function sendMessage() {
closeMenus(); 
const text = messageInput.value.trim();

// è®°å½•æ˜¯å¦åˆšå‘é€äº†æ–‡ä»¶
let fileSent = false;

// 1. å¤„ç†æ–‡ä»¶ä¸Šä¼  (å¦‚æœæœ‰)
    if (pendingFile) {
        fileSent = true;
        // æ£€æŸ¥æ˜¯å¦æœ‰é€‚é…å™¨æ’ä»¶
        if (window.parent && window.parent.__fayePhoneSupport_upload) {
            try {
                // è·å–è§’è‰²å
                let cName = 'default';
                // å°è¯•ä»çˆ¶çª—å£è·å–å‡†ç¡®çš„è§’è‰²å
                if (window.parent && window.parent.SillyTavern) {
                    try {
                        const ctx = window.parent.SillyTavern.getContext();
                        if (ctx) {
                            let chars = ctx.characters;
                            if (chars && typeof chars.then === 'function') {
                                chars = await chars;
                            }
                            if (chars && ctx.characterId && chars[ctx.characterId]) {
                                cName = chars[ctx.characterId].name;
                            }
                        }
                    } catch(e) { console.log('Parent context unavailable in sendMessage'); }
                }
                if (!cName || cName === 'default' || cName === '{{char}}') {
                    const titleEl = document.getElementById('header-title');
                    if (titleEl) cName = titleEl.textContent;
                }
                if (!cName || cName === '{{char}}') cName = 'default';
                // ä½¿ç”¨æ’ä»¶ä¸Šä¼ 
                const result = await window.parent.__fayePhoneSupport_upload(pendingFile, cName);
                if (result && result.url) {
                    if (pendingFile.type.startsWith('image/')) {
                        // 1. base64 ç”¨äº AI è¯†å›¾
                        const base64Data = await toBase64(pendingFile);
                        lastUploadedImageForAI = base64Data;
                        // 2. url ç”¨äºæ¶ˆæ¯æ˜¾ç¤º
                        await sendPhoto(result.url);
                    } else if (pendingFile.type.startsWith('audio/')) {
                        await sendRealAudio(result.url);
                    } else if (pendingFile.type.startsWith('video/')) {
                        await sendVideo(result.url);
                    }
                }
            } catch (err) {
                console.error("Plugin upload failed:", err);
                alert("å›¾ç‰‡ä¸Šä¼ å¤±è´¥: " + (err.message || "æœªçŸ¥é”™è¯¯"));
            }
        } else {
            alert('æœªæ£€æµ‹åˆ°é€‚é…å™¨æ’ä»¶ï¼Œæ— æ³•å‘é€æ–‡ä»¶ã€‚è¯·å®‰è£… FayephoneSupport æ’ä»¶ã€‚');
        }
        window.clearPreview();
    }

// 2. å¤„ç†æ–‡å­—æ¶ˆæ¯
if (text) {
    const t = getTime(); 
    const u = window.userName || '{{user}}'; 
    // å¦‚æœè¢«æ‹‰é»‘ï¼Œåœ¨æ¶ˆæ¯å¤´ä¸­æ·»åŠ æ ‡è®° (ç”¨äºæŒä¹…åŒ–)
    let header = `[${u}|${t}]`;
    if (appSettings.blockUser) {
        header = `[${u}|${t}|!]`; // ! è¡¨ç¤ºè¢«æ‹‰é»‘/å‘é€å¤±è´¥
    }
    renderMessageToUI({ header: header, body: text, isUser: true });
    messageInput.value = ''; 
    adjustTextareaHeight(); 
    await rebuildAndSaveHistory();
} 

// 3. è§¦å‘AIå›å¤é€»è¾‘ï¼šåªæœ‰è¾“å…¥æ¡†ä¸ºç©ºä¸”æœ¬æ¬¡æ²¡æœ‰å‘é€æ–‡ä»¶æ—¶æ‰è§¦å‘AI
if (!text && !fileSent) {
    // ç¨ä½œå»¶è¿Ÿï¼Œç¡®ä¿DOMå’ŒHistoryæ›´æ–°å®Œæ¯•
    setTimeout(() => {
        showTypingIndicator(); 
        triggerGenerate();
    }, 100);
}
// renderMessageList(); // æš‚ä¸åˆ·æ–°åˆ—è¡¨ï¼Œé¿å…è·³åŠ¨ï¼ŒsendMessageåªæ›´æ–°å½“å‰èŠå¤©çª—å£
}

function getTime() {
if (appSettings.timeOffset) {
    const now = new Date();
    const target = new Date(now.getTime() + appSettings.timeOffset);
    return `${target.getHours().toString().padStart(2,'0')}:${target.getMinutes().toString().padStart(2,'0')}`;
}
if (appSettings.customTime && /^\d{1,2}:\d{2}$/.test(appSettings.customTime)) return appSettings.customTime;
const now = new Date(); return `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
}

function triggerLoveEffect() {
    const container = document.getElementById('love-effect-layer');
    if (!container) return;
    
    const hearts = ['â¤ï¸', 'ğŸ’–', 'ğŸ’—', 'ğŸ’“', 'ğŸ’•'];
    const count = 15; // Number of hearts
    
    for (let i = 0; i < count; i++) {
        setTimeout(() => {
            const heart = document.createElement('div');
            heart.className = 'love-heart';
            heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
            heart.style.left = Math.random() * 100 + '%';
            heart.style.animationDuration = (3 + Math.random() * 2) + 's';
            container.appendChild(heart);
            
            // Cleanup
            setTimeout(() => heart.remove(), 5000);
        }, i * 200);
    }
}

function renderMessageToUI(msg) {
if(!chatMessages) return;
// è¿‡æ»¤æ‰æš—ç½‘æœç´¢è®°å½•å’Œæ—¥è®°
if (msg.header && (msg.header.includes('ã€æœç´¢è®°å½•') || msg.header.includes('ã€æ—¥è®°') || msg.type === 'search-history')) return;
// é¢å¤–æ£€æŸ¥æ¶ˆæ¯ä½“ï¼Œé˜²æ­¢è§£æå¤±è´¥å¯¼è‡´æ—¥è®°æ˜¾ç¤º
if (msg.body && (msg.body.startsWith('ã€æ—¥è®°') || msg.body.startsWith('ã€æœç´¢è®°å½•') || msg.body.includes('<riji:') || msg.body.includes('<jilu:'))) return;

// è¿‡æ»¤éå½“å‰èŠå¤©å¯¹è±¡çš„æ¶ˆæ¯ï¼ˆé™¤éæ˜¯ç”¨æˆ·è‡ªå·±å‘çš„ï¼‰
// ç”¨æˆ·è‡ªå·±å‘çš„æ¶ˆæ¯æš‚æ—¶æ— æ³•é€šè¿‡ header åŒºåˆ†å‘ç»™è°ï¼Œæ‰€ä»¥æ€»æ˜¯æ˜¾ç¤º
// æ³¨æ„ï¼šAI ç”Ÿæˆçš„å›å¤å¯èƒ½å¸¦ Headerï¼Œä¹Ÿå¯èƒ½ä¸å¸¦ï¼ˆä¸å¸¦æ—¶é€šå¸¸æ˜¯é»˜è®¤è§’è‰²ï¼‰
// æˆ‘ä»¬åœ¨ parseMessages ä¸­ä¼šå°½é‡ç»™æ¯æ¡æ¶ˆæ¯åŠ  Header

    // è¿‡æ»¤é€»è¾‘ï¼š
    // 1. å¦‚æœæœ‰å½“å‰èŠå¤©å¯¹è±¡ï¼Œä¸”æ¶ˆæ¯ä¸æ˜¯ç”¨æˆ·å‘çš„ï¼Œä¸”æ¶ˆæ¯ Header ä¸­çš„åå­—ä¸å½“å‰å¯¹è±¡ä¸ç¬¦ï¼Œåˆ™ä¸æ˜¾ç¤º
    if (currentChatTarget && !msg.isUser) {
        let senderName = null;
        if (msg.header) {
            const parts = msg.header.replace(/^\[|\]$|^ã€|ã€‘$/g, '').split('|');
            if (parts.length > 0) senderName = parts[0];
        }
        
        // å¦‚æœå½“å‰æ˜¯ç¾¤èŠï¼Œåˆ™ Header ä¸­çš„å‘é€è€…åº”è¯¥æ˜¯ç¾¤æˆå‘˜ä¹‹ä¸€
        // ä½†æˆ‘ä»¬çš„ Tag æ˜¯ group:NameCount
        let isValid = false;
        
        // æ£€æŸ¥æ˜¯å¦åœ¨ç¾¤èŠä¸­
        const isGroup = currentChatTag && currentChatTag.startsWith('group:');
        if (isGroup) {
             // ç¾¤èŠæ¨¡å¼ï¼šåªè¦æ¶ˆæ¯ä¸æ˜¯æ¥è‡ªç”¨æˆ·ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½æ˜¾ç¤ºï¼Œå› ä¸ºè¿™æ˜¯ç¾¤èŠå†å²çš„ä¸€éƒ¨åˆ†ã€‚
             // ä½†è¿™åªæœ‰åœ¨è¯»å–å†å²æ—¶æœ‰æ•ˆã€‚å¦‚æœæ˜¯å®æ—¶ç”Ÿæˆï¼Œæˆ‘ä»¬éœ€è¦ AI é…åˆã€‚
             isValid = true;
        } else {
            // ç§èŠæ¨¡å¼
            const mainCharName = window.charName || '{{char}}';
            // å¦‚æœæ²¡æœ‰ senderNameï¼Œé»˜è®¤è§†ä¸ºå½“å‰è§’è‰²
            if (!senderName) senderName = mainCharName;
            
            // å®½æ¾åŒ¹é…ï¼šå¦‚æœ senderName åŒ…å« currentChatTargetï¼Œæˆ–è€… currentChatTarget åŒ…å« senderName
            // æˆ–è€… senderName æ˜¯é»˜è®¤è§’è‰²å
            if (senderName === currentChatTarget || senderName === mainCharName || currentChatTarget.includes(senderName) || senderName.includes(currentChatTarget)) {
                isValid = true;
            }
        }
        
        if (!isValid) {
            console.log('Message filtered:', senderName, currentChatTarget);
            // return; // æš‚æ—¶ç¦ç”¨è¿‡æ»¤ï¼Œä»¥ä¾¿è°ƒè¯•
        }
    }
// NEW: å¤„ç†æ’¤å›æ¶ˆæ¯
if (msg.header && msg.header.includes('|æ’¤å›|')) {
    const row = document.createElement('div'); 
    row.className = 'message-row system';
    row.style.justifyContent = 'center';
    row.style.margin = '10px 0';
    
    const el = document.createElement('div');
    el.className = 'recall-notice';
    el.style.fontSize = '12px';
    el.style.color = '#999';
    el.style.backgroundColor = 'rgba(0,0,0,0.05)';
    el.style.padding = '4px 12px';
    el.style.borderRadius = '10px';
    
    let displayName = msg.isUser ? (window.userName || '{{user}}') : (window.charName || '{{char}}');
    if (msg.header) {
         const parts = msg.header.replace(/^\[|\]$|^ã€|ã€‘$/g, '').split('|');
         if (parts.length > 0 && parts[0]) displayName = parts[0];
    }
    
    const isVoice = msg.header.includes('è¯­éŸ³');
    const typeText = isVoice ? 'è¯­éŸ³' : 'ä¿¡æ¯';
    
    el.textContent = `${displayName}æ’¤å›äº†ä¸€æ¡${typeText}ï¼š${msg.body}`;
    el.dataset.fullHeader = msg.header;
    el.dataset.rawBody = msg.body;
    
    row.appendChild(el);
    chatMessages.appendChild(row);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return;
}

const row = document.createElement('div'); row.className = `message-row ${msg.isUser ? 'sent' : 'received'}`;

// Check for Love Keywords
if (msg.body && typeof msg.body === 'string') {
    const text = msg.body.toLowerCase();
    // æ‰©å±•è§¦å‘è¯ï¼šåŒ…å«ä¸­æ–‡ã€è‹±æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡ã€æ³•æ–‡ã€å¾·æ–‡ã€è¥¿æ–‡ç­‰å¸¸è§è¡¨è¾¾
    // åªè¦åŒ…å« "çˆ±ä½ " æˆ– "å–œæ¬¢ä½ " å°±ä¼šè§¦å‘ï¼Œå“ªæ€•æ˜¯ "æˆ‘ä¸çˆ±ä½ " ä¹Ÿä¼šè§¦å‘ï¼ˆæŒ‰ç”¨æˆ·è¦æ±‚ä¿ç•™è¿™ç§è¶£å‘³æ€§ï¼‰
    if (text.includes('çˆ±ä½ ') || text.includes('å–œæ¬¢ä½ ') || 
        text.includes('love you') || text.includes('miss you') ||
        text.includes('æ„›ã—ã¦ã‚‹') || text.includes('å¥½ã') || // æ—¥è¯­
        text.includes('ì‚¬ë‘í•´') || // éŸ©è¯­
        text.includes('je t\'aime') || // æ³•è¯­
        text.includes('te amo') || // è¥¿ç­ç‰™è¯­
        text.includes('ich liebe dich') || // å¾·è¯­
        text.includes('è¡¨ç™½')) {
        triggerLoveEffect();
    }
}

// ç¾¤èŠæˆå‘˜å¤´åƒå§‹ç»ˆç”¨é»˜è®¤å¤´åƒ
let avatarSrc;
let displayName = msg.isUser ? (window.userName || '{{user}}') : (window.charName || '{{char}}');
if (msg.header) {
    const parts = msg.header.replace(/^[\[ã€]|[\]ã€‘]$/g, '').split('|');
    if (parts.length > 0 && parts[0]) displayName = parts[0];
}
const isGroupChat = currentChatTag && currentChatTag.startsWith('group:');
if (isGroupChat) {
    // ç¾¤èŠæ¨¡å¼ï¼šä¼˜å…ˆä½¿ç”¨è®¾ç½®çš„æˆå‘˜å¤´åƒ
    if (msg.isUser) {
        avatarSrc = appSettings.userAvatar;
    } else if (appSettings.memberAvatars && appSettings.memberAvatars[displayName]) {
        avatarSrc = appSettings.memberAvatars[displayName];
    } else {
        // é»˜è®¤å¤´åƒ
        avatarSrc = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2IwYjBiMCI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZjJmMmYyIi8+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OS00IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==';
    }
} else {
    avatarSrc = msg.isUser ? appSettings.userAvatar : appSettings.charAvatar;
    // å°è¯•æŸ¥æ‰¾ç‰¹å®šæˆå‘˜å¤´åƒï¼ˆä»…ç§èŠï¼‰
    if (!msg.isUser && appSettings.memberAvatars && appSettings.memberAvatars[displayName]) {
        avatarSrc = appSettings.memberAvatars[displayName];
    }
}
const avatar = document.createElement('img'); avatar.className = 'avatar'; avatar.src = avatarSrc;

const container = document.createElement('div'); container.className = 'msg-container';
const nameEl = document.createElement('div'); nameEl.className = 'msg-name';
nameEl.textContent = displayName;
container.appendChild(nameEl);

const wrapper = document.createElement('div'); wrapper.className = 'msg-wrapper';

let el;
const isLoc = msg.type === 'location' || (msg.header && msg.header.includes('ä½ç½®'));
const isTra = msg.type === 'transfer' || (msg.header && msg.header.includes('è½¬è´¦'));
const isFile = msg.type === 'file' || (msg.header && msg.header.includes('æ–‡ä»¶'));
const isVoice = msg.type === 'voice' || (msg.header && msg.header.includes('è¯­éŸ³'));
const isVideo = msg.type === 'video' || (msg.header && msg.header.includes('è§†é¢‘'));
let isPhoto = msg.type === 'photo' || (msg.header && msg.header.includes('å›¾ç‰‡'));
const isSticker = msg.type === 'sticker' || (msg.header && msg.header.includes('è¡¨æƒ…åŒ…'));
const isCallMsg = msg.type === 'call_message' || (msg.header && msg.header.includes('é€šè¯'));

const timeMatch = msg.header ? msg.header.match(/\|(\d{2}:\d{2})/) : null;
const timeStr = timeMatch ? timeMatch[1] : getTime();
const timeEl = document.createElement('div'); timeEl.className = 'msg-time'; timeEl.textContent = timeStr;

let displayBody = msg.body;
let displayThought = msg.thought || '';
if (!displayThought && displayBody) {
const thoughtMatch = displayBody.match(/^([\s\S]*?)\*([^\*]+)\*\s*$/);
if (thoughtMatch) { displayBody = thoughtMatch[1].trim(); displayThought = thoughtMatch[2].trim(); }
}

// Auto-detect Pollinations AI images or Markdown images OR <img> tag images
if (!isLoc && !isTra && !isFile && !isVoice && !isSticker && !isCallMsg) {
    if (/^!\[.*?\]\(.*?\)$/.test(displayBody) || 
        /^https?:\/\/image\.pollinations\.ai\/prompt\//.test(displayBody) ||
        /^<img>.*?<\/img>$/.test(displayBody)) {
        isPhoto = true;
        // Ensure header has |å›¾ç‰‡| tag for consistency
        if (msg.header && !msg.header.includes('å›¾ç‰‡')) {
            const parts = msg.header.replace(/^\[|\]$|^ã€|ã€‘$/g, '').split('|');
            if (parts.length >= 2) {
                const t = parts.pop();
                msg.header = `[${parts.join('|')}|å›¾ç‰‡|${t}]`;
            }
        }
    }
}
if (isPhoto) {
    const mdMatch = displayBody.match(/!\[.*?\]\((.*?)\)/);
    const imgTagMatch = displayBody.match(/<img>(.*?)<\/img>/);
    if (mdMatch) displayBody = mdMatch[1];
    else if (imgTagMatch) displayBody = imgTagMatch[1];
}

if (isLoc) {
el = document.createElement('div'); el.className = `location-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<div class="location-info"><div class="location-name">${displayBody}</div></div><div class="location-map"><svg class="location-pin" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"></path><circle cx="12" cy="9" r="2.5" fill="#fff"/></svg></div>`;
} else if (isTra) {
const parts = displayBody.split('|');
el = document.createElement('div'); el.className = `transfer-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<div class="transfer-top"><div class="transfer-icon-circle"><svg viewBox="0 0 24 24"><path d="M7 10h14l-4-4"></path><path d="M17 14H3l4 4"></path></svg></div><div class="transfer-content"><div class="transfer-amount">${parts[0]||'Â¥ 0.00'}</div><div class="transfer-note">${parts[1]||'è½¬è´¦ç»™æ‚¨'}</div></div></div><div class="transfer-bottom">è½¬è´¦</div>`;
} else if (isFile) {
el = document.createElement('div'); el.className = `file-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<div class="file-info"><div class="file-name">${displayBody}</div><div class="file-size">128 KB</div></div><div class="file-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" fill="#eee"></path><polyline points="14 2 14 8 20 8" fill="#ddd"></polyline><text x="50%" y="18" font-size="6" fill="#888" text-anchor="middle" font-family="Arial">FILE</text></svg></div>`;
} else if (isCallMsg) {
    el = document.createElement('div'); 
    el.className = `bubble ${msg.isUser ? 'bubble-sent' : 'bubble-received'}`; 
    // å°åœ†è§’é•¿æ–¹å½¢ï¼Œæ— é€æ˜åº¦
    el.style.borderRadius = '10px';
    el.style.opacity = '1';
    el.textContent = displayBody;
    
    if (msg.isUser) {
        el.style.backgroundColor = appSettings.userBubble; 
        el.style.color = appSettings.userText;
    } else {
        el.style.backgroundColor = appSettings.charBubble; 
        el.style.color = appSettings.charText;
    }
} else if (isVoice) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯çœŸå®éŸ³é¢‘URL (httpå¼€å¤´æˆ–characterså¼€å¤´)
    if (displayBody.startsWith('http') || displayBody.startsWith('characters/') || displayBody.startsWith('UserUploads/') || displayBody.startsWith('/user/images/')) {
        el = document.createElement('div'); 
        el.className = `real-audio-card ${msg.isUser ? 'sent' : 'received'}`;
        // ä¸ºäº†å®‰å…¨å’Œè·¯å¾„æ­£ç¡®ï¼Œå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå¯èƒ½éœ€è¦è¡¥å…¨ã€‚ä½†åœ¨SillyTavernä¸­ç›¸å¯¹è·¯å¾„é€šå¸¸æ˜¯ç›¸å¯¹äºæ ¹ç›®å½•
        el.innerHTML = `<audio controls src="${displayBody}"></audio>`;
    } else {
        // å¾®ä¿¡é£æ ¼æ¨¡æ‹Ÿè¯­éŸ³æ°”æ³¡
        const parts = displayBody.split('|');
        const dur = Math.max(1, Math.min(45, parseInt(parts[0]) || 5));
        const txt = parts.slice(1).join('|');
        const minWidth = 66; // æœ€çŸ­æ°”æ³¡å®½åº¦ï¼ˆpxï¼‰
        // åŠ¨æ€è®¡ç®—æœ€å¤§å®½åº¦ï¼šæ‰‹æœºå®½åº¦çš„ 65%
        const phoneW = (appSettings.phoneWidth && !isNaN(appSettings.phoneWidth)) ? parseInt(appSettings.phoneWidth) : 330;
        const maxWidth = phoneW * 0.65; 
        const width = Math.round(minWidth + (maxWidth - minWidth) * (dur / 45));
        el = document.createElement('div'); el.className = `voice-card ${msg.isUser ? 'sent' : 'received'}`; el.style.width = width + 'px';
        // å£°çº¹3~4æ ¹
        let waves = '';
        const barCount = 3 + Math.floor(Math.random()*2); // 3æˆ–4æ ¹
        for (let i = 0; i < barCount; i++) waves += `<div class="wave" style="height:${8 + Math.random()*10}px"></div>`;
        let barHtml = '';
        if (msg.isUser) {
            // user: å£°çº¹åœ¨å³ï¼Œæ—¶é•¿åœ¨å·¦
            barHtml = `<div class="voice-bar" style="flex-direction: row-reverse; justify-content: flex-end;"><div class="voice-waves">${waves}</div><div class="voice-duration">${dur}"</div></div>`;
        } else {
            // char: å£°çº¹åœ¨å·¦ï¼Œæ—¶é•¿åœ¨å³ï¼Œæ•´ä½“é å³
            barHtml = `<div class="voice-bar" style="flex-direction: row; justify-content: flex-end;"><div class="voice-waves">${waves}</div><div class="voice-duration">${dur}"</div></div>`;
        }
        el.innerHTML = `${barHtml}<div class="voice-text" style="text-align:left;word-break:break-word;white-space:normal;">${txt}</div>`;
        el.classList.remove('show-text');
        el.addEventListener('click', (e) => { el.classList.toggle('show-text'); });
        if (msg.isUser) { el.style.backgroundColor = appSettings.userBubble; el.style.color = appSettings.userText; }
        else { el.style.backgroundColor = appSettings.charBubble; el.style.color = appSettings.charText; }
    }
} else if (isSticker) {
el = document.createElement('div'); el.className = `sticker-bubble ${msg.isUser ? 'sent' : 'received'}`;
let src = displayBody;
const fileMatch = displayBody.match(/([a-zA-Z0-9_-]+\.[a-zA-Z0-9]+)$/);
if (fileMatch && !displayBody.startsWith('http')) { src = 'https://catbox.pengcyril.dpdns.org/' + fileMatch[1]; }
el.innerHTML = `<img src="${src}">`;
el.dataset.stickerBody = displayBody;
} else if (isVideo) {
el = document.createElement('div'); el.className = `photo-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<video src="${displayBody}" controls style="width:100%;border-radius:12px;"></video>`;
if (msg.isUser) { el.style.backgroundColor = appSettings.userBubble; }
else { el.style.backgroundColor = appSettings.charBubble; }
} else if (isPhoto) {
el = document.createElement('div'); el.className = `photo-card ${msg.isUser ? 'sent' : 'received'}`;
el.innerHTML = `<img src="${displayBody}">`;
if (msg.isUser) { el.style.backgroundColor = appSettings.userBubble; }
else { el.style.backgroundColor = appSettings.charBubble; }
} else {
el = document.createElement('div'); el.className = `bubble ${msg.isUser ? 'bubble-sent' : 'bubble-received'}`; el.textContent = displayBody;
if (msg.isUser) { el.style.backgroundColor = appSettings.userBubble; el.style.color = appSettings.userText; }
else { el.style.backgroundColor = appSettings.charBubble; el.style.color = appSettings.charText; }
}

if (msg.header) {
    if (msg.header.startsWith('[') || msg.header.startsWith('ã€')) {
         el.dataset.fullHeader = msg.header;
    } else {
         const isPic = isPhoto || (msg.header && msg.header.includes('å›¾ç‰‡'));
         // ç»Ÿä¸€ä½¿ç”¨ [ ]
         el.dataset.fullHeader = `[${msg.header}]`;
    }
} else { 
    const n = msg.isUser ? (window.userName || '{{user}}') : (window.charName || '{{char}}'); 
    const t = getTime(); 
    const isPic = isPhoto;
    el.dataset.fullHeader = isPic ? `[${n}|å›¾ç‰‡|${t}]` : `[${n}|${t}]`; 
}

// æ£€æŸ¥æ˜¯å¦è¢«æ‹‰é»‘
// 1. å¦‚æœæ˜¯ç”¨æˆ·å‘çš„æ¶ˆæ¯ï¼Œä¸”å½“å‰å¤„äº Charæ‹‰é»‘User çŠ¶æ€ (appSettings.blockUser)ï¼Œæ˜¾ç¤ºçº¢è‰²æ„Ÿå¹å·
// 2. å¦‚æœæ˜¯Charå‘çš„æ¶ˆæ¯ï¼Œä¸”å½“å‰å¤„äº Useræ‹‰é»‘Char çŠ¶æ€ (appSettings.blockChar)ï¼Œæ˜¾ç¤ºçº¢è‰²æ„Ÿå¹å·
let isBlocked = false;
if (msg.isUser && appSettings.blockUser) isBlocked = true;
if (!msg.isUser && appSettings.blockChar) isBlocked = true;

// æ£€æŸ¥æ¶ˆæ¯å¤´ä¸­æ˜¯å¦å·²æœ‰æ ‡è®° (æŒä¹…åŒ–)
if (msg.header && msg.header.includes('!')) isBlocked = true;

// åˆ›å»ºå…ƒæ•°æ®å®¹å™¨ï¼ˆåŒ…å«æ—¶é—´å’ŒçŠ¶æ€å›¾æ ‡ï¼‰
const metaContainer = document.createElement('div');
metaContainer.className = 'msg-meta';

if (isCallMsg) {
    const callIcon = document.createElement('img');
    callIcon.src = msg.isUser ? "https://api.iconify.design/si:phone-duotone.svg" : "https://api.iconify.design/si:phone-enabled-duotone.svg";
    callIcon.style.width = '12px';
    callIcon.style.height = '12px';
    callIcon.style.marginBottom = '1px';
    callIcon.style.opacity = '0.6'; // Make it subtle like timestamp
    metaContainer.appendChild(callIcon);
}

if (isBlocked) {
    const blockIcon = document.createElement('span');
    blockIcon.className = 'msg-status-blocked';
    blockIcon.textContent = '!';
    blockIcon.title = 'æ¶ˆæ¯è¢«æ‹¦æˆª/å‘é€å¤±è´¥';
    metaContainer.appendChild(blockIcon);
}
metaContainer.appendChild(timeEl);

addLongPressHandler(el);
wrapper.appendChild(el); wrapper.appendChild(metaContainer); container.appendChild(wrapper);

if (displayThought) {
const thoughtEl = document.createElement('div'); thoughtEl.className = 'msg-thought';
thoughtEl.textContent = displayThought; container.appendChild(thoughtEl);
}

row.appendChild(avatar); row.appendChild(container); chatMessages.appendChild(row); chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function rebuildAndSaveHistory() {
try { 
    // if (typeof getCurrentMessageId === 'undefined') return; 

    // 1. è·å–å½“å‰ DOM ä¸­çš„æœ€æ–°èŠå¤©å†…å®¹ (Current active chat)
    const cn = window.charName || '{{char}}'; 
    const rows = Array.from(chatMessages.children); 
    let nc = '';
    
    for (const row of rows) {
        if (row.id === 'typing-bubble' || row.classList.contains('delete-btn')) continue;
        const el = row.querySelector('.bubble, .location-card, .transfer-card, .file-card, .voice-card, .real-audio-card, .photo-card, .sticker-bubble, .recall-notice'); 
        if (!el) continue;
        
        let t = "", h = el.dataset.fullHeader;
        const thoughtEl = row.querySelector('.msg-thought');
        const thoughtSuffix = thoughtEl ? `*${thoughtEl.textContent}*` : '';
        
        // ... (æå–æ–‡æœ¬é€»è¾‘ä¿æŒä¸å˜) ...
        if (el.classList.contains('bubble')) t = el.textContent;
        else if (el.classList.contains('recall-notice')) t = el.dataset.rawBody;
        else if (el.classList.contains('location-card')) t = el.querySelector('.location-name').textContent;
        else if (el.classList.contains('transfer-card')) t = `${el.querySelector('.transfer-amount').textContent}|${el.querySelector('.transfer-note').textContent}`;
        else if (el.classList.contains('file-card')) t = el.querySelector('.file-name').textContent;
        else if (el.classList.contains('voice-card')) t = `${el.querySelector('.voice-duration').textContent.replace('"','')}|${el.querySelector('.voice-text').textContent}`;
        else if (el.classList.contains('real-audio-card')) t = el.querySelector('audio').getAttribute('src');
        else if (el.classList.contains('sticker-bubble')) { t = el.dataset.stickerBody || el.querySelector('img').src; }
        else if (el.classList.contains('photo-card')) {
            const img = el.querySelector('img');
            const vid = el.querySelector('video');
            if (img) {
                let src = img.getAttribute('src');
                try { src = decodeURI(src); } catch(e) {}
                let promptPath = src;
                if (promptPath.includes('UserUploads')) {
                     const parts = promptPath.split('UserUploads');
                     let suffix = parts[1];
                     promptPath = '/user/images' + (suffix.startsWith('/') ? '' : '/') + suffix;
                }
                promptPath = promptPath.replace(/\\/g, '/');
                const encodedPath = promptPath.replace(/ /g, '%20').replace(/\(/g, '%28').replace(/\)/g, '%29');
                t = `<img>${encodedPath}</img>`;
                if (h) {
                    h = h.replace(/^ã€/, '[').replace(/ã€‘$/, ']');
                    if (!h.includes('|å›¾ç‰‡|')) {
                         const content = h.replace(/^\[|\]$/g, '');
                         h = `[${content}|å›¾ç‰‡]`; 
                    }
                }
            }
            else if (vid) t = vid.getAttribute('src');
        }
        if (h && t) nc += `${h}${t}${thoughtSuffix}\n`;
    }

    // 2. ä¿å­˜é€»è¾‘åˆ†æµ
    if (typeof getCurrentMessageId !== 'undefined') {
        // ST ç¯å¢ƒé€»è¾‘
        let allChatsMap = new Map();
        const history = getChatMessages(getCurrentMessageId());
        if (history && history[0]) {
             const m = history[0].message.match(/<fphone>([\s\S]*?)<\/fphone>/i);
             if (m) {
                 allChatsMap = getAllChatsFromHistory(m[1]);
             }
        }

        let activeTag = currentChatTag;
        if (!activeTag) {
            const mainChar = window.charName || '{{char}}';
            activeTag = `chat:${mainChar}`;
        }

        allChatsMap.set(activeTag, "\n" + nc.trim() + "\n");

        let newFphoneContent = "";
        allChatsMap.forEach((content, key) => {
            const colonIndex = key.indexOf(':');
            if (colonIndex > 0) {
                const type = key.substring(0, colonIndex);
                const name = key.substring(colonIndex + 1);
                newFphoneContent += `<${type}:${name}>${content}</${type}>\n`;
            }
        });

        const finalMsg = `<fphone>\n${newFphoneContent}</fphone>`;
        await setChatMessages([{ message_id: getCurrentMessageId(), message: finalMsg }], { refresh: 'none' });
    } else {
        // ç‹¬ç«‹ç¯å¢ƒé€»è¾‘ï¼šä¿å­˜åˆ° localStorage
        let activeTag = currentChatTag;
        if (!activeTag) {
            const mainChar = window.charName || '{{char}}';
            activeTag = `chat:${mainChar}`;
        }
        localStorage.setItem(`faye-phone-history-${activeTag}`, nc);
    }

} catch (e) { console.error(e); }
}

function handleGenerationResponse(resp) {
    const removeTyping = () => { const tb = document.getElementById('typing-bubble'); if (tb) tb.remove(); };
    removeTyping();
    let rt = typeof resp === 'string' ? resp : (resp.text || '');

    if (isWaitingForDarkSearch) {
        isWaitingForDarkSearch = false;
        renderDarkSearchResults(rt);
        if (window.parent && window.parent.__fayePhoneSupport_deleteLastMessage) {
            window.parent.__fayePhoneSupport_deleteLastMessage(rt);
        }
        return;
    }

    if (isWaitingForDiary) {
        isWaitingForDiary = false;
        renderDiaryEntries(rt);
        if (window.parent && window.parent.__fayePhoneSupport_deleteLastMessage) {
            window.parent.__fayePhoneSupport_deleteLastMessage(rt);
        }
        return;
    }

    if (rt.includes('[æ‹‰é»‘ç”¨æˆ·]')) {
        appSettings.blockUser = true;
        saveSettingsToStorage();
    }
    if (rt.includes('[è§£é™¤æ‹‰é»‘]')) {
        appSettings.blockUser = false;
        saveSettingsToStorage();
    }

    if (/\[.*?\|å‘èµ·é€šè¯\|.*?\]/.test(rt)) {
        receiveVoiceCall();
        rt = rt.replace(/\[.*?\|å‘èµ·é€šè¯\|.*?\]\s*å‘èµ·é€šè¯/g, '').trim();
        rt = rt.replace(/\[.*?\|å‘èµ·é€šè¯\|.*?\]/g, '').trim();
        if (!rt) return;
    }

    rt = rt.replace(/<riji:.*?>[\s\S]*?<\/riji:.*?>/gi, '').replace(/<jilu:.*?>[\s\S]*?<\/jilu:.*?>/gi, '').trim();
    rt = rt.replace(/<fphone>|<\/fphone>|<\/?chat(:.*?)?>/gi, '').trim();

    if (isCalling) {
        hideCallTyping();
        const callTextEl = document.getElementById('call-char-text');
        const callScreen = document.getElementById('call-screen');
        if (callTextEl) {
            let cleanText = rt.replace(/^["â€œ]/, '').replace(/["â€]$/, '');
            callTextEl.textContent = `"${cleanText}"`;
        }
        if (callScreen) callScreen.classList.add('speaking');
        setTimeout(() => { if(callScreen) callScreen.classList.remove('speaking'); }, 3000);
        
        const msgs = parseMessages(rt);
        msgs.forEach(msg => {
            if (!msg.isUser) {
                if (msg.header && !msg.header.includes('é€šè¯')) {
                    if (/\|\d{2}:\d{2}\]$/.test(msg.header)) {
                        msg.header = msg.header.replace(/\|(\d{2}:\d{2})\]$/, '|é€šè¯|$1]');
                    } else {
                        msg.header = msg.header.replace(/\]$/, '|é€šè¯]');
                    }
                }
                if (!msg.header) {
                    const cn = window.charName || '{{char}}';
                    const t = getTime();
                    msg.header = `[${cn}|é€šè¯|${t}]`;
                }
                addCallBubble(msg.body, false);
                renderMessageToUI(msg);
            }
        });
        rebuildAndSaveHistory().then(() => renderMessageList());
        return;
    }

    parseMessages(rt).filter(msg => !msg.isUser).forEach(msg => renderMessageToUI(msg)); 
    rebuildAndSaveHistory().then(() => renderMessageList());
}

if (typeof eventOn !== 'undefined') {
    eventOn(iframe_events.GENERATION_ENDED, handleGenerationResponse);
    eventOn(iframe_events.GENERATION_STOPPED, () => { const tb = document.getElementById('typing-bubble'); if (tb) tb.remove(); });
}

async function callLLM(params) {
    if (typeof generate !== 'undefined' && !appSettings.apiKey) {
        generate(params);
        return;
    }

    if (!appSettings.apiUrl || !appSettings.apiKey) {
        alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API åœ°å€å’Œ Keyï¼Œæˆ–åœ¨ SillyTavern ç¯å¢ƒä¸­ä½¿ç”¨ã€‚');
        const tb = document.getElementById('typing-bubble'); if (tb) tb.remove();
        return;
    }

    let messages = [];
    if (params.injects) {
        params.injects.forEach(inj => {
            messages.push({ role: inj.role || 'system', content: inj.content });
        });
    }

    let activeTag = currentChatTag;
    if (!activeTag) {
        const mainChar = window.charName || '{{char}}';
        activeTag = `chat:${mainChar}`;
    }
    const historyText = localStorage.getItem(`faye-phone-history-${activeTag}`) || '';
    const historyMsgs = parseMessages(historyText);
    
    historyMsgs.slice(-20).forEach(msg => {
        if (msg.body && !msg.body.startsWith('[')) {
             messages.push({
                role: msg.isUser ? 'user' : 'assistant',
                content: msg.body
            });
        }
    });

    try {
        let url = appSettings.apiUrl;
        if (url.endsWith('/')) url = url.slice(0, -1);
        if (!url.endsWith('/chat/completions')) url += '/chat/completions';

        const res = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${appSettings.apiKey}`
            },
            body: JSON.stringify({
                model: appSettings.modelName || 'gpt-3.5-turbo',
                messages: messages,
                temperature: 0.7
            })
        });
        
        if (!res.ok) {
            const errText = await res.text();
            throw new Error(`API Error ${res.status}: ${errText}`);
        }
        const data = await res.json();
        const reply = data.choices[0].message.content;
        handleGenerationResponse(reply);
    } catch (e) {
        console.error(e);
        alert('API è¯·æ±‚å¤±è´¥: ' + e.message);
        const tb = document.getElementById('typing-bubble'); if (tb) tb.remove();
    }
}



function parseMessages(txt) {
const lines = txt.split('\n'), res = [], dr = /^\d{1,2}æœˆ\d{1,2}æ—¥$/, hr = /^(\[([^\]]+)\]|ã€([^ã€‘]+)ã€‘)/, cn = window.charName || '{{char}}';
for (const l of lines) {
const tr = l.trim(); if (!tr) continue; if (dr.test(tr)) { res.push({ type: 'date', body: tr }); continue; }
const m = tr.match(hr);
if (m) {
const hc = m[2] || m[3];
// ä½¿ç”¨åŸå§‹å®Œæ•´ Header (m[0]) åŒ…å«æ‹¬å·ï¼Œä»¥ä¾¿ä¿ç•™å†å²è®°å½•ä¸­çš„ã€ã€‘æ ¼å¼
const fullHeader = m[0]; 
let b = tr.substring(m[0].length).trim();
let thought = '';
const thoughtMatch = b.match(/^([\s\S]*?)\*([^\*]+)\*\s*$/);
if (thoughtMatch) { b = thoughtMatch[1].trim(); thought = thoughtMatch[2].trim(); }
let type = 'text';
if (hc.includes('ä½ç½®')) type = 'location'; else if (hc.includes('è½¬è´¦')) type = 'transfer'; else if (hc.includes('æ–‡ä»¶')) type = 'file'; else if (hc.includes('è¯­éŸ³')) type = 'voice'; else if (hc.includes('å›¾ç‰‡')) type = 'photo';
else if (hc.includes('è¡¨æƒ…åŒ…')) type = 'sticker';
// Determine if message is from user or char based on header content
const isUser = hc.startsWith('User') || hc.includes(window.userName || '{{user}}');
res.push({ header: fullHeader, body: b, type: type, thought: thought, isUser: isUser });
} else res.push({ header: `${cn}|${getTime()}`, body: tr, type: 'text', isUser: false });
}
return res;
}

function loadInitialChat() {
    if(!chatMessages) return;
    chatMessages.innerHTML = '';
    
    let activeTag = currentChatTag;
    if (!activeTag) {
        const mainChar = window.charName || '{{char}}';
        activeTag = `chat:${mainChar}`;
    }

    try { 
        if (typeof getCurrentMessageId !== 'undefined') {
            const h = getChatMessages(getCurrentMessageId()); 
            if (!h?.[0]?.message) return;
            
            const m = h[0].message.match(/<fphone>([\s\S]*?)<\/fphone>/i); 
            if (!m) return;
            
            const allChats = getAllChatsFromHistory(m[1]);
            const content = allChats.get(activeTag);
            if (content) {
                parseMessages(content).forEach(msg => renderMessageToUI(msg));
            }
        } else {
            // Standalone mode: Load from localStorage
            const content = localStorage.getItem(`faye-phone-history-${activeTag}`);
            if (content) {
                parseMessages(content).forEach(msg => renderMessageToUI(msg));
            }
        }
    } catch (e) { console.error(e); }
}

function triggerGenerate() {
const cn = currentChatTarget || window.charName || '{{char}}'; // ä½¿ç”¨å½“å‰èŠå¤©å¯¹è±¡æˆ–é»˜è®¤è§’è‰²
const t = getTime();
let injects = [];
const myName = window.userName || '{{user}}';

// 1. åŸºç¡€ç³»ç»ŸæŒ‡ä»¤ï¼šæ¨¡ä»¿æ‰‹æœºçŸ­ä¿¡
let roleInstruction = "";

// æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠ
let isGroup = false;
if (currentChatTag && currentChatTag.startsWith('group:')) {
    isGroup = true;
    const groupName = currentChatTag.replace(/^group:/, '');
    
    // è·å–ç¾¤æˆå‘˜
    let memberList = [];
    const g = (appSettings.groups || []).find(x => x.name === groupName);
    if (g && Array.isArray(g.members)) memberList = g.members.slice();
    
    const memberStr = memberList.length > 0 ? memberList.join(', ') : 'æœªçŸ¥';

    roleInstruction = `[åœºæ™¯æ¨¡å¼ï¼šå¤šäººç¾¤èŠ]
å½“å‰ç¾¤ç»„åç§°ï¼š${groupName}
ç¾¤å†…æˆå‘˜åå•ï¼š[${memberStr}]
å½“å‰ç”¨æˆ·ï¼š${myName}
æŒ‡ä»¤è¦æ±‚ï¼š
1. ä½ éœ€è¦æ ¹æ®å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæ‰®æ¼”ã€ç¾¤æˆå‘˜åå•ã€‘ä¸­çš„ä¸€ä½æˆ–å¤šä½æˆå‘˜è¿›è¡Œå›å¤ã€‚
2. ä¸¥ç¦æ‰®æ¼”ç”¨æˆ·ï¼ˆ${myName}ï¼‰å‘è¨€ã€‚
3. ä¸¥ç¦è™šæ„ä¸åœ¨åå•ä¸­çš„äººç‰©å‘è¨€ã€‚`;

} else {
    // ç§èŠ
    roleInstruction = `[åœºæ™¯æ¨¡å¼ï¼šä¸€å¯¹ä¸€ç§èŠ]
èŠå¤©å¯¹è±¡ï¼š${cn}
å½“å‰ç”¨æˆ·ï¼š${myName}
æŒ‡ä»¤è¦æ±‚ï¼š
1. ä½ åªèƒ½æ‰®æ¼” ${cn} å›å¤æ¶ˆæ¯ã€‚
2. ä¸¥ç¦æ‰®æ¼”ç”¨æˆ·ï¼ˆ${myName}ï¼‰è¯´è¯ã€‚`;
}

// å¦‚æœæ˜¯ç¾¤èŠï¼Œç”Ÿæˆä¸€æ¡ç³»ç»Ÿæç¤ºï¼Œåˆ—å‡ºå½“å‰ç¾¤èŠæˆå‘˜å¹¶æ ‡æ³¨å¤´åƒåˆ—è¡¨ä¸­æ˜¯å¦å­˜åœ¨
if (isGroup) {
    try {
        const groupName = currentChatTag.replace(/^group:/, '');
        let memberList = [];
        const g = (appSettings.groups || []).find(x => x.name === groupName);
        if (g && Array.isArray(g.members)) memberList = g.members.slice();
        // æ„é€ æ¯ä¸ªæˆå‘˜çš„æ ‡æ³¨ï¼šåœ¨å¤´åƒåˆ—è¡¨ä¸­/ä¸åœ¨å¤´åƒåˆ—è¡¨ä¸­
        const memberLines = memberList.map(m => {
            const isPresent = (appSettings.memberAvatars && (appSettings.memberAvatars[m] || (m === myName && appSettings.memberAvatars[m])));
            return `- ${m} (${isPresent ? 'åœ¨å¤´åƒåˆ—è¡¨ä¸­' : 'æœªåœ¨å¤´åƒåˆ—è¡¨ä¸­'})`;
        });

        const p_members = `[ç¾¤æˆå‘˜è¯¦ç»†ä¿¡æ¯]
${memberLines.length ? memberLines.join('\n') : '- ï¼ˆæ— æˆå‘˜ä¿¡æ¯ï¼‰'}
è¯·æ‰®æ¼”å¤´åƒåˆ—è¡¨ä¸­çš„æˆå‘˜çš„æ€§æ ¼è¿›è¡Œæ‰®æ¼”ï¼Œæœªå†å¤´åƒåˆ—è¡¨ä¸­çš„æˆå‘˜è¯´æ˜ä¸åœ¨ç¾¤é‡Œã€‚`;
        injects.push({ role: 'system', content: p_members, position: 'at_depth', depth: 1 });
    } catch (e) { /* ignore */ }
}

// å…¼å®¹æ—§ç‰ˆé€—å·åˆ†éš”çš„ç¾¤èŠæ£€æµ‹ (å¦‚æœä¸æ˜¯é€šè¿‡ group: æ ‡ç­¾è¿›å…¥ï¼Œä½†åå­—é‡Œæœ‰é€—å·)
if (!isGroup && (cn.includes(',') || cn.includes('ï¼Œ'))) {
    roleInstruction = `[åœºæ™¯æ¨¡å¼ï¼šå¤šäººä¼šè¯]
ä½ æ­£åœ¨ç¾¤èŠä¸­ï¼Œä½ éœ€è¦æ‰®æ¼” ${cn} ä¸­çš„ä¸€äººæˆ–å¤šäººè¿›è¡Œå›å¤ã€‚ç¦æ­¢æ‰®æ¼”ç”¨æˆ·ã€‚`;
}

const p = `[ç³»ç»ŸæŒ‡ä»¤] å½“å‰æ—¶é—´${t}ã€‚æˆ‘ä»¬æ­£åœ¨è¿›è¡Œçº¿ä¸ŠèŠå¤©ã€‚
è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š
1. è¯­å¢ƒï¼šå®Œå…¨æ¨¡ä»¿æ‰‹æœºèŠå¤©è½¯ä»¶çš„é£æ ¼ï¼Œä½¿ç”¨çŸ­å¥ã€å£è¯­ã€é¢œæ–‡å­—ã€‚ä¸å…è®¸ä»»ä½•åŠ¨ä½œæå†™å’Œå°è¯´å™è¿°æ–‡æœ¬ã€‚
2. æ ¼å¼ï¼šè¯·å›å¤ 2-5 æ¡ç®€çŸ­æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿè¿ç»­å‘é€ã€‚
3. ${roleInstruction}`;

    injects.push({ role: 'system', content: p, position: 'at_depth', depth: 0 });

    // NEW: User Persona Injection
    if (appSettings.userPersona) {
        const p_user = `[ç”¨æˆ·è®¾å®š]
ç”¨æˆ·åç§°ï¼š${myName}
ç”¨æˆ·äººè®¾ï¼š${appSettings.userPersona}`;
        injects.push({ role: 'system', content: p_user, position: 'at_depth', depth: 0 });
    }

    // ... (åç»­æŒ‡ä»¤ä¿æŒä¸å˜) ...
    const p2 = `[æ ·å¼å¼ºåˆ¶]
1. æ ¼å¼ï¼šä»…è¾“å‡ºçº¯æ–‡æœ¬æ¶ˆæ¯ã€‚ç¦æ­¢ä½¿ç”¨ Markdownã€ä»£ç å—æˆ– XML æ ‡ç­¾ã€‚
2. è¯­æ°”ï¼šä¼‘é—²ã€å¯¹è¯å¼ã€çŸ­ä¿¡é£æ ¼ã€‚é€‚å½“ä½¿ç”¨ä¿šè¯­/è¡¨æƒ…ç¬¦å·ã€‚
3. æ‹‰é»‘æŒ‡ä»¤ï¼šå¦‚æœä½ æƒ³æ‹‰é»‘ç”¨æˆ·ï¼Œè¯·åœ¨å›å¤æœ«å°¾åŠ ä¸Š [æ‹‰é»‘ç”¨æˆ·]ã€‚å¦‚æœä½ æƒ³è§£é™¤æ‹‰é»‘ï¼Œè¯·åŠ ä¸Š [è§£é™¤æ‹‰é»‘]ã€‚`;
    injects.push({ role: 'system', content: p2, position: 'at_depth', depth: 1 });

    // 3. æ‹‰é»‘çŠ¶æ€æ³¨å…¥
    if (appSettings.blockChar) {
        const blockPrompt = `[ç³»ç»Ÿé€šçŸ¥] ç”¨æˆ·å·²å°†ä½ æ‹‰é»‘ã€‚ä½ çš„æ¶ˆæ¯æ— æ³•æ­£å¸¸ä¼ è¾¾ï¼ˆæ˜¾ç¤ºçº¢è‰²æ„Ÿå¹å·ï¼‰ã€‚è¯·è¡¨ç°å‡ºè¢«æ‹‰é»‘çš„ååº”ï¼ˆå¦‚ç„¦æ€¥ã€è½°ç‚¸æ¶ˆæ¯ã€ç–‘æƒ‘ç­‰ï¼‰ã€‚`;
        injects.push({ role: 'system', content: blockPrompt, position: 'at_depth', depth: 0 });
    }
    if (appSettings.blockUser) {
        const blockPrompt = `[ç³»ç»Ÿé€šçŸ¥] ä½ å·²å°†ç”¨æˆ·æ‹‰é»‘ã€‚ä½ æ— æ³•çœ‹åˆ°ç”¨æˆ·çš„æ¶ˆæ¯å†…å®¹ï¼ˆæ˜¾ç¤ºä¸ºè¢«æ‹¦æˆªï¼‰ã€‚è¯·æ— è§†ç”¨æˆ·çš„å‘è¨€ï¼Œæˆ–è€…è‡ªè¯´è‡ªè¯ã€‚`;
        injects.push({ role: 'system', content: blockPrompt, position: 'at_depth', depth: 0 });
    }

    // 4. è¯­éŸ³é€šè¯åŠŸèƒ½è¯´æ˜
    const p_call = `[è¯­éŸ³é€šè¯åŠŸèƒ½è¯´æ˜]
å‘èµ·é€šè¯
å‘{{user}}å‘èµ·è¯­éŸ³é€šè¯é‚€è¯·ã€‚
è§„åˆ™ï¼š
- å‘èµ·é€šè¯æ—¶ï¼Œä»…è¾“å‡ºä»¥ä¸‹æ ¼å¼ï¼Œä¸å¾—é™„åŠ ä»»ä½•å…¶ä»–ä¿¡æ¯æ ¼å¼ã€æ–‡å­—ã€è¯´æ˜æˆ–å†…å¿ƒæ´»åŠ¨ã€‚
- æ ¼å¼ï¼š[åå­—|å‘èµ·é€šè¯|æ—¶é—´]å‘èµ·è¯­éŸ³é€šè¯â€¦
  ç¤ºä¾‹ï¼š
  [char|å‘èµ·é€šè¯|21:23]å‘èµ·è¯­éŸ³é€šè¯â€¦
è¯­éŸ³é€šè¯ä¸­
ä¸{{user}}è¿›è¡Œå®æ—¶è¯­éŸ³é€šè¯å¯¹è¯ã€‚
è§„åˆ™ï¼š
1. é€šè¯ä¸åŒ…å«ä»»ä½•å†…å¿ƒç‹¬ç™½ï¼Œä¸è¾“å‡ºæ˜Ÿå·ï¼ˆ*ï¼‰åŒ…è£¹çš„å†…å¿ƒæ´»åŠ¨ã€‚
2. ç¯å¢ƒéŸ³æ•ˆã€è¯­æ°”æˆ–åŠ¨ä½œæç¤ºï¼Œä½¿ç”¨æ‹¬å·æ ‡æ³¨ï¼Œä¾‹å¦‚ï¼š
   ï¼ˆè¢«å­æ‘©æ“¦çš„å£°éŸ³ï¼‰ ï¼ˆè½»è½»å¹ä¸€å£æ°”ï¼‰
3. é€šè¯å†…å®¹å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š
   [åå­—|é€šè¯|æ—¶é—´]å¯¹è¯å†…å®¹
   ç¤ºä¾‹ï¼š
   [char|é€šè¯|12:23]ï¼ˆè°ƒæ•´å‘¼å¸ï¼‰å–‚ï¼Ÿå¬å¾—è§å—ï¼Ÿæˆ‘çœ‹ä½ æ¶ˆæ¯å›å¾—é‚£ä¹ˆæ€¥ï¼Œèµ¶ç´§å°±æ‹¨è¿‡æ¥äº†ã€‚
å…³é”®æ³¨æ„ï¼š
- [åå­—|å‘èµ·é€šè¯|æ—¶é—´] ä»…ç”¨äºå‘èµ·é€šè¯é‚€è¯·ï¼Œè¡¨ç¤ºå‘¼å«å¼€å§‹ã€‚
- [åå­—|é€šè¯|æ—¶é—´] ä»…ç”¨äºé€šè¯æ¥é€šåçš„å®æ—¶å¯¹è¯ï¼Œè¡¨ç¤ºåŒæ–¹å·²æ¥é€šå¹¶æ­£åœ¨äº¤æµã€‚
- ä¸€æ—¦{{user}}æ¥å¬ç”µè¯ï¼Œå¿…é¡»ç«‹å³åˆ‡æ¢è‡³é€šè¯æ ¼å¼ã€‚
- æœªæ¥é€šç”µè¯åˆ™æ™®é€šæ¶ˆæ¯æ–‡æœ¬æ ¼å¼`;
    injects.push({ role: 'system', content: p_call, position: 'at_depth', depth: 1 });

    const genParams = { 
        injects: injects, 
        should_stream: false, 
        max_chat_history: 300 
    };

    // 2. å›¾åƒè¯†åˆ«/å¤šæ¨¡æ€é€»è¾‘
    if (lastUploadedImageForAI) {
        genParams.image = lastUploadedImageForAI;
        const imagePrompt = `[ç³»ç»ŸæŒ‡ä»¤] ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡ã€‚è¯·è°ƒç”¨ä½ çš„è§†è§‰èƒ½åŠ›åˆ†æè¿™å¼ å›¾ç‰‡ã€‚
        é‡è¦ï¼šä¸å¯ä»¥ç›´ç™½æè¿°å›¾ç‰‡å†…å®¹ï¼ˆå¦‚"è¿™æ˜¯ä¸€å¼ ..."ï¼‰ã€‚è¦å¯¹æ ¹æ®äººç‰©è®¾å®šå¯¹å›¾ç‰‡åšå‡ºè‡ªç„¶ååº”ï¼ˆå¦‚è¯„ä»·ã€è¡¨è¾¾æ„Ÿå—ã€åæ§½ç­‰ï¼‰ï¼Œå°±åƒåœ¨èŠå¤©è½¯ä»¶ä¸­æ”¶åˆ°è¿™å¼ å›¾ä¸€æ ·ã€‚`;
        injects.push({ role: 'system', content: imagePrompt, position: 'at_depth', depth: 0 });
        lastUploadedImageForAI = null;
    }
    callLLM(genParams);
}// ç§»é™¤ä¹‹å‰é‡å¤çš„ç›‘å¬å™¨é€»è¾‘ï¼Œæ‰€æœ‰å¤„ç†å·²åˆå¹¶è‡³ä¸Šæ–¹çš„ä¸» eventOn(iframe_events.GENERATION_ENDED) ä¸­

function showTypingIndicator() {
const row = document.createElement('div'); row.id = 'typing-bubble'; row.className = 'message-row received';
const el = document.createElement('div'); el.className = 'bubble bubble-received typing-only';
el.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
el.style.backgroundColor = appSettings.charBubble;
row.appendChild(el); chatMessages.appendChild(row); chatMessages.scrollTop = chatMessages.scrollHeight;
// ç‚¹å‡»æ°”æ³¡ç§»é™¤åŠ¨ç”»
row.onclick = () => row.remove();
}
function adjustTextareaHeight() {
    if (!messageInput) return;
    messageInput.style.height = 'auto';
    const max = parseInt(getComputedStyle(messageInput).maxHeight) || 80;
    const scrollH = messageInput.scrollHeight;
    if (scrollH > max) {
        messageInput.style.height = max + 'px';
    } else {
        messageInput.style.height = scrollH + 'px';
    }
}
function clearDeleteButton() { if (activeDeleteBtn) { activeDeleteBtn.remove(); activeDeleteBtn = null; } document.querySelectorAll('.delete-mode').forEach(el => el.classList.remove('delete-mode')); }
function executeDelete(el) { const r = el.closest('.message-row'); r.style.transform = 'scale(0)'; setTimeout(async () => { r.remove(); clearDeleteButton(); await rebuildAndSaveHistory(); }, 200); }
function addLongPressHandler(el) {
let timer; const start = (e) => { if(e.target.closest('.delete-btn')) return; el.classList.add('pressing'); timer = setTimeout(() => { el.classList.remove('pressing'); showDeleteButton(el); }, 500); };
const cancel = () => { clearTimeout(timer); el.classList.remove('pressing'); };
el.addEventListener('mousedown', start);
el.addEventListener('touchstart', start, {passive:true});
['mouseup','mouseleave','touchend','touchmove'].forEach(ev => el.addEventListener(ev, cancel));
}
function showDeleteButton(el) {
clearDeleteButton(); el.classList.add('delete-mode'); const btn = document.createElement('div'); btn.className = 'delete-btn';
btn.innerHTML = `<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
btn.onclick = (e) => { e.stopPropagation(); executeDelete(el); }; el.appendChild(btn); activeDeleteBtn = btn;
}
document.onclick = (e) => {
    if(activeDeleteBtn && !e.target.closest('.location-card, .transfer-card, .file-card, .bubble, .voice-card, .real-audio-card, .photo-card, .sticker-bubble')) clearDeleteButton();
    
    if (!e.target.closest('.sticker-item')) {
        document.querySelectorAll('.sticker-item .delete-btn').forEach(b => b.remove());
        document.querySelectorAll('.sticker-item.delete-mode').forEach(i => i.classList.remove('delete-mode'));
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
    if (actionMenu && actionMenu.classList.contains('open') && !e.target.closest('#action-menu') && !e.target.closest('#plus-button')) {
        closeMenus();
    }
    if (emojiMenu && emojiMenu.classList.contains('open') && !e.target.closest('#emoji-menu') && !e.target.closest('#emoji-button')) {
        closeMenus();
    }
};

function triggerSettingsUpload(type) {
    currentSettingsUploadType = type;
    const input = document.getElementById('settings-file-input');
    if (input) input.click();
}

function init() {
// Initialize references
phoneContainer = document.getElementById('phone-container');
homeScreen = document.getElementById('home-screen');
chatScreen = document.getElementById('chat-screen');
settingsScreen = document.getElementById('settings-screen');
messageListScreen = document.getElementById('message-list-screen');
messageListBody = document.getElementById('message-list-body');
chatMessages = document.getElementById('chat-messages');
messageInput = document.getElementById('message-input');
sendButton = document.getElementById('send-button');
plusButton = document.getElementById('plus-button');
emojiButton = document.getElementById('emoji-button');
actionMenu = document.getElementById('action-menu');
emojiMenu = document.getElementById('emoji-menu');
modal = document.getElementById('input-modal');
modalTitle = document.getElementById('modal-title');
modalInputsContainer = document.getElementById('modal-inputs-container');
modalConfirmBtn = document.getElementById('modal-confirm-btn');
chatSettingsScreen = document.getElementById('chat-settings-screen');
headerTitle = document.getElementById('header-title');
clockEl = document.getElementById('clock');
homeClockEl = document.getElementById('home-clock');
statusBar = document.getElementById('status-bar');
photoInput = document.getElementById('photo-upload-input');
// New References
audioInput = document.getElementById('audio-upload-input');
videoInput = document.getElementById('video-upload-input');
mediaPreviewBar = document.getElementById('media-preview-bar');
previewImage = document.getElementById('preview-image');
previewFileIcon = document.getElementById('preview-file-icon');
adapterStatus = document.getElementById('adapter-status');
darkSearchScreen = document.getElementById('dark-search-screen');
darkSearchInput = document.getElementById('dark-search-input');
diaryScreen = document.getElementById('diary-screen');
addContactModal = document.getElementById('add-contact-modal');

// Bind Events
// å›¾ç‰‡ä¸Šä¼ 
if(photoInput) photoInput.addEventListener('change', async (e) => {
    if (e.target.files && e.target.files[0]) {
        handleFileSelect(e.target.files[0]);
        e.target.value = ''; // Reset for re-selection
        closeMenus(); // Close action menu
    }
});

// éŸ³é¢‘ä¸Šä¼ 
if(audioInput) audioInput.addEventListener('change', async (e) => {
    if (e.target.files && e.target.files[0]) {
        handleFileSelect(e.target.files[0]);
        e.target.value = '';
        closeMenus();
    }
});

// è§†é¢‘ä¸Šä¼ 
if(videoInput) videoInput.addEventListener('change', async (e) => {
    if (e.target.files && e.target.files[0]) {
        handleFileSelect(e.target.files[0]);
        e.target.value = '';
        closeMenus();
    }
});

// è®¾ç½®é¡µé¢æ–‡ä»¶ä¸Šä¼ 
const settingsFileInput = document.getElementById('settings-file-input');
if (settingsFileInput) {
    settingsFileInput.addEventListener('change', async (e) => {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            try {
                let url = '';
                // å°è¯•ä½¿ç”¨çˆ¶çº§ä¸Šä¼ æ¥å£
                if (window.parent && window.parent.__fayePhoneSupport_upload) {
                    // è·å–è§’è‰²å (é€»è¾‘åŒ sendMessage)
                    let cName = 'default';
                    if (window.parent && window.parent.SillyTavern) {
                        try {
                            const ctx = window.parent.SillyTavern.getContext();
                            if (ctx) {
                                let chars = ctx.characters;
                                if (chars && typeof chars.then === 'function') chars = await chars;
                                if (chars && ctx.characterId && chars[ctx.characterId]) {
                                    cName = chars[ctx.characterId].name;
                                }
                            }
                        } catch(e) { console.log('Parent context unavailable in settings upload'); }
                    }
                    if (!cName || cName === 'default' || cName === '{{char}}') {
                        const titleEl = document.getElementById('header-title');
                        if (titleEl) cName = titleEl.textContent;
                    }
                    if (!cName || cName === '{{char}}') cName = 'default';

                    // ä½¿ç”¨æ’ä»¶ä¸Šä¼ ï¼Œä¼ å…¥è§’è‰²åä»¥ä¿æŒè·¯å¾„ä¸€è‡´
                    const result = await window.parent.__fayePhoneSupport_upload(file, cName);
                    
                    if (result && typeof result === 'object' && result.url) {
                        url = result.url;
                    } else if (typeof result === 'string') {
                        url = result;
                    }
                } else {
                    // é™çº§å¤„ç†ï¼šè½¬ä¸º Base64
                    url = await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (ev) => resolve(ev.target.result);
                        reader.readAsDataURL(file);
                    });
                }

                if (url) {
                    // åªå­˜urlè·¯å¾„ï¼Œé¿å…base64æ’‘çˆ†localStorage
                    if (currentSettingsUploadType === 'char-avatar') {
                        appSettings.charAvatar = url;
                        renderAvatarSettings();
                        saveSettingsToStorage();
                    } else if (currentSettingsUploadType === 'user-avatar') {
                        appSettings.userAvatar = url;
                        renderAvatarSettings();
                        saveSettingsToStorage();
                    } else if (currentSettingsUploadType === 'chat-bg') {
                        appSettings.chatBg = url;
                        const preview = document.getElementById('preview-chat-bg');
                        if(preview) preview.src = url;
                        saveSettingsToStorage();
                    } else if (currentSettingsUploadType === 'home-bg') {
                        appSettings.homeBg = url;
                        const preview = document.getElementById('preview-home-bg');
                        if(preview) preview.src = url;
                        saveSettingsToStorage();
                    } else if (currentSettingsUploadType === 'group-avatar') {
                        if (!appSettings.groupAvatars) appSettings.groupAvatars = {};
                        appSettings.groupAvatars[currentChatTag] = url;
                        renderAvatarSettings();
                        saveSettingsToStorage();
                    } else if (currentSettingsUploadType && currentSettingsUploadType.startsWith('member:')) {
                        const memberName = currentSettingsUploadType.split(':')[1];
                        if (memberName) {
                            if (!appSettings.memberAvatars) appSettings.memberAvatars = {};
                            appSettings.memberAvatars[memberName] = url;
                            renderAvatarSettings();
                            saveSettingsToStorage();
                        }
                    }
                }
            } catch (err) {
                console.error("Upload failed", err);
                alert("ä¸Šä¼ å¤±è´¥: " + err.message);
            }
            e.target.value = ''; // Reset
        }
    });
}

if(plusButton) plusButton.addEventListener('click', () => {
if (actionMenu.classList.contains('open')) closeMenus();
else { closeMenus(); actionMenu.classList.add('open'); plusButton.classList.add('active'); clearDeleteButton(); setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 300); }
});
if(emojiButton) emojiButton.addEventListener('click', () => {
if (emojiMenu.classList.contains('open')) closeMenus();
else { closeMenus(); emojiMenu.classList.add('open'); setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 300); }
});
if(messageInput) {
messageInput.addEventListener('focus', closeMenus);
messageInput.oninput = adjustTextareaHeight;
messageInput.onkeydown = (e) => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
}
if(sendButton) sendButton.onclick = sendMessage;
if(modalConfirmBtn) modalConfirmBtn.onclick = (e) => {
if(e) e.preventDefault();
if (currentConfirmAction) {
const inputs = modalInputsContainer.querySelectorAll('input');
const values = Array.from(inputs).map(i => i.value.trim());
if (values[0]) {
currentConfirmAction(values);
// Only remove the 'show' class from the input modal, explicitly do not call closeModal
if(modal) modal.classList.remove('show');
currentConfirmAction = null; // Clean up immediately after execution
}
}
};

loadSettings();
migrateChats(); // NEW: Migrate legacy chats to ID-based
const savedStickers = localStorage.getItem('st-phone-stickers');
myStickerList = savedStickers ? JSON.parse(savedStickers) : defaultStickerList;
const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2IwYjBiMCI+PHJlY3Qgd2lkdGg9IjI0IiBoZWlnaHQ9IjI0IiBmaWxsPSIjZjJmMmYyIi8+PHBhdGggZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OS00IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==';
if(!appSettings.charAvatar) appSettings.charAvatar = defaultAvatar;
if(!appSettings.userAvatar) appSettings.userAvatar = defaultAvatar;
applySettings();
// Store initial char name for stability (fix reset issue)
const hTitle = document.getElementById('header-title');
initialCharName = window.charName || (hTitle ? hTitle.textContent : null);
if(headerTitle) headerTitle.textContent = window.charName || '{{char}}';
updateClock();
initStickers();
setInterval(updateClock, 1000);
// ç«‹å³æ£€æŸ¥ä¸€æ¬¡è§’è‰²å˜åŒ–ï¼Œä»¥ä¾¿å°½å¿«åŠ è½½ç‰¹å®šè§’è‰²çš„è®¾ç½®
checkCharacterChange();
setInterval(checkCharacterChange, 1000);
try { loadInitialChat(); setTimeout(loadInitialChat, 500); } catch(e){}
}

// Attach globally
window.openChat = openChat;
window.openMessageList = openMessageList;
window.goBack = goBack;
window.openSettings = openSettings;
window.closeSettings = closeSettings;
window.openChatSettings = openChatSettings;
window.saveHomeSettings = saveHomeSettings;
window.saveChatSettings = saveChatSettings;
window.handleAction = handleAction;
window.closeModal = closeModal;
window.handleUploadUrl = handleUploadUrl;
window.triggerSettingsUpload = triggerSettingsUpload;
window.openDarkSearch = openDarkSearch;
window.closeDarkSearch = closeDarkSearch;
window.searchDarkWeb = searchDarkWeb;
window.openDiary = openDiary;
window.closeDiary = closeDiary;
window.generateDiary = generateDiary;
window.openAddContactModal = openAddContactModal;
window.closeAddContactModal = closeAddContactModal;
window.switchContactTab = switchContactTab;
window.renderGroupInputs = renderGroupInputs;
window.confirmAddContact = confirmAddContact;
window.closeChatSettings = closeChatSettings;
window.deleteCurrentChat = deleteCurrentChat;

// Initialize on Load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { init(); setScreenDisplay(); });
} else {
    init(); setScreenDisplay();
}

function setScreenDisplay() {
    if (homeScreen) homeScreen.style.display = 'flex';
    if (chatScreen) chatScreen.style.display = 'none';
    if (settingsScreen) settingsScreen.style.display = 'none';
    if (messageListScreen) messageListScreen.style.display = 'none';
    if (darkSearchScreen) darkSearchScreen.style.display = 'none';
    if (diaryScreen) diaryScreen.style.display = 'none';
    if (chatSettingsScreen) chatSettingsScreen.style.display = 'none';
    if (document.getElementById('call-screen')) document.getElementById('call-screen').style.display = 'none';
    
    // é¡µé¢åŠ è½½å®Œæˆåï¼Œæ·¡å…¥æ˜¾ç¤ºæ‰‹æœºå®¹å™¨
    if (phoneContainer) {
        setTimeout(() => {
            phoneContainer.style.opacity = '1';
        }, 100);
    }
}

// Voice Call Logic
let isCalling = false;
let callTimerInterval = null;
let callSeconds = 0;
let callConnectionTimeout = null;

function startVoiceCall(isIncoming = false) {
    closeMenus();
    const callScreen = document.getElementById('call-screen');
    const nameEl = document.getElementById('call-name');
    const avatarEl = document.getElementById('call-avatar');
    const textEl = document.getElementById('call-char-text');
    const timerEl = document.getElementById('call-timer');
    
    if (!callScreen) return;
    
    // Set Info
    const targetName = currentChatTarget || window.charName || '{{char}}';
    if (nameEl) nameEl.textContent = targetName;
    
    let avatarSrc = appSettings.charAvatar;
    if (appSettings.memberAvatars && appSettings.memberAvatars[targetName]) {
        avatarSrc = appSettings.memberAvatars[targetName];
    }
    if (avatarEl) avatarEl.src = avatarSrc;
    
    // Clear Call Chat Container
    const callChatContainer = document.getElementById('call-chat-container');
    if (callChatContainer) callChatContainer.innerHTML = '';

    // Show Screen
    callScreen.style.display = 'flex';
    callScreen.style.visibility = 'visible';
    isCalling = true;
    callSeconds = 0;
    
    // Clear previous timers
    if (callTimerInterval) clearInterval(callTimerInterval);
    if (callConnectionTimeout) clearTimeout(callConnectionTimeout);

    if (isIncoming) {
        // Direct Connect for Incoming Call
        if (timerEl) {
            timerEl.textContent = '00:00';
            timerEl.style.opacity = '1';
        }
        if (textEl) {
            textEl.textContent = 'é€šè¯ä¸­';
            textEl.style.fontSize = '12px';
            textEl.style.opacity = '0.8';
        }
        
        // Start Timer Immediately
        callTimerInterval = setInterval(() => {
            callSeconds++;
            const m = Math.floor(callSeconds / 60).toString().padStart(2, '0');
            const s = (callSeconds % 60).toString().padStart(2, '0');
            if (timerEl) timerEl.textContent = `${m}:${s}`;
        }, 1000);

        // Trigger AI Greeting (Incoming Call Context)
        showCallTyping();
        
        const injects = [
            { role: 'system', content: `[ç³»ç»ŸæŒ‡ä»¤] ä½ ä¸»åŠ¨ç»™ç”¨æˆ·æ‹¨æ‰“äº†ç”µè¯ï¼Œç”¨æˆ·å·²æ¥å¬ã€‚
è¯·ç›´æ¥å¼€å§‹å¯¹è¯ï¼Œè¯´æ˜ä½ çš„æ¥æ„ã€‚
å›å¤æ ¼å¼è¦æ±‚ï¼š
1. å¿…é¡»æ˜¯è¯­éŸ³é€šè¯çš„å£å»ï¼Œç®€çŸ­ã€å£è¯­åŒ–ã€‚
2. ç¦æ­¢è¾“å‡ºå¿ƒå£°æˆ–åŠ¨ä½œæå†™ï¼ˆé™¤éæ˜¯å£°éŸ³æå†™ï¼‰ã€‚
3. å£°éŸ³æå†™ï¼ˆå¦‚ç¬‘å£°ã€å¹æ°”ï¼‰è¯·ç”¨æ‹¬å·åŒ…è£¹ã€‚
ä½ çš„å›å¤å°†ç›´æ¥æ˜¾ç¤ºåœ¨é€šè¯å­—å¹•ä¸­ã€‚`, position: 'at_depth', depth: 0 }
        ];
        
        if (typeof generate !== 'undefined') {
            generate({ injects: injects, should_stream: false });
        }

    } else {
        // Outgoing Call Logic (Dialing)
        if (timerEl) {
            timerEl.textContent = 'æ­£åœ¨æ‹¨æ‰“...';
            timerEl.style.opacity = '0.6';
        }
        if (textEl) {
            textEl.innerHTML = 'ç­‰å¾…æ¥å¬<span class="jumping-dot">.</span><span class="jumping-dot">.</span><span class="jumping-dot">.</span>';
        }

        // Simulate Connection Delay (2-6 seconds)
        const delay = Math.floor(Math.random() * 4000) + 2000;
        
        callConnectionTimeout = setTimeout(() => {
            // Connected
            if (timerEl) {
                timerEl.textContent = '00:00';
                timerEl.style.opacity = '1';
            }
            if (textEl) {
                textEl.textContent = 'å¯¹æ–¹å·²æ¥é€š';
                textEl.style.fontSize = '12px';
                textEl.style.opacity = '0.8';
            }
            
            // Start Timer
            callTimerInterval = setInterval(() => {
                callSeconds++;
                const m = Math.floor(callSeconds / 60).toString().padStart(2, '0');
                const s = (callSeconds % 60).toString().padStart(2, '0');
                if (timerEl) timerEl.textContent = `${m}:${s}`;
            }, 1000);

            // Trigger AI Greeting (Outgoing Call Context)
            showCallTyping();
            
            const injects = [
                { role: 'system', content: `[ç³»ç»ŸæŒ‡ä»¤] ç”¨æˆ·æ‹¨æ‰“äº†ä½ çš„ç”µè¯ã€‚
è¯·æ¥å¬ç”µè¯å¹¶æ‰“æ‹›å‘¼ã€‚
è¯·ä»¥è¯­éŸ³é€šè¯çš„å£å»å›å¤ï¼Œå†…å®¹è¦ç®€çŸ­ã€å£è¯­åŒ–ã€‚
ç¦æ­¢è¾“å‡ºå¿ƒå£°ã€‚
åŒ…å«è¯­éŸ³å†…å®¹å’Œå£°éŸ³æå†™ï¼ˆå¦‚ç¬‘å£°ã€å¹æ°”ç­‰ï¼‰ï¼Œç”¨æ‹¬å·åŒ…è£¹å£°éŸ³æå†™ã€‚
ä½ çš„å›å¤å°†ç›´æ¥æ˜¾ç¤ºåœ¨é€šè¯ç•Œé¢çš„å­—å¹•ä¸­ã€‚`, position: 'at_depth', depth: 0 }
            ];
            
            if (typeof generate !== 'undefined') {
                generate({ injects: injects, should_stream: false });
            }
            
        }, delay);
    }
    
    updateStatusBar('dark-search'); // Use dark status bar style
}

function addCallBubble(text, isUser) {
    const container = document.getElementById('call-chat-container');
    if (!container) return;
    
    const bubble = document.createElement('div');
    bubble.className = `call-bubble ${isUser ? 'sent' : 'received'}`;
    bubble.innerHTML = text; // Use innerHTML to support HTML content like typing indicator
    
    container.appendChild(bubble);
    container.scrollTop = container.scrollHeight;
    return bubble;
}

function showCallTyping() {
    const container = document.getElementById('call-chat-container');
    if (!container) return;
    // Remove existing typing indicator if any
    hideCallTyping();
    
    const bubble = document.createElement('div');
    bubble.id = 'call-typing-indicator';
    bubble.className = 'call-bubble received';
    bubble.innerHTML = '<span class="jumping-dot">.</span><span class="jumping-dot">.</span><span class="jumping-dot">.</span>';
    
    container.appendChild(bubble);
    container.scrollTop = container.scrollHeight;
}

function hideCallTyping() {
    const el = document.getElementById('call-typing-indicator');
    if (el) el.remove();
}

function endVoiceCall() {
    const callScreen = document.getElementById('call-screen');
    if (callScreen) callScreen.style.display = 'none';
    
    isCalling = false;
    if (callTimerInterval) clearInterval(callTimerInterval);
    if (callConnectionTimeout) clearTimeout(callConnectionTimeout);
    
    // Stop AI Generation if active
    if (typeof stopGeneration !== 'undefined') {
        stopGeneration();
    }
    
    // Add system message to chat
    let bodyText = "";
    if (callSeconds > 0) {
        const m = Math.floor(callSeconds / 60).toString().padStart(2, '0');
        const s = (callSeconds % 60).toString().padStart(2, '0');
        bodyText = `é€šè¯ç»“æŸï¼Œæ—¶é•¿ï¼š${m}:${s}`;
    } else {
        bodyText = "é€šè¯å–æ¶ˆ";
    }
    
    const t = getTime();
    const u = window.userName || '{{user}}';
    
    // Save to history
    renderMessageToUI({ header: `[${u}|é€šè¯|${t}]`, body: bodyText, isUser: true });
    rebuildAndSaveHistory();
    
    updateStatusBar('chat');
}

function sendCallMessage() {
    const input = document.getElementById('call-input');
    if (!input) return;
    const text = input.value.trim();
    // Allow empty text to trigger AI response (silence)
    
    input.value = '';
    
    // Show User Message in Call Screen (Only if text is not empty)
    if (text) {
        addCallBubble(text, true);
    }
    
    // Show Thinking Animation
    showCallTyping();
    
    // Trigger AI
    const t = getTime();
    const cn = currentChatTarget || window.charName || '{{char}}';
    
    let userActionDesc = `ç”¨æˆ·è¯´ï¼šâ€œ${text}â€ã€‚`;
    if (!text) {
        userActionDesc = `ç”¨æˆ·ä¿æŒäº†æ²‰é»˜ï¼ˆæ²¡æœ‰è¯´è¯ï¼‰ã€‚`;
    }

    const injects = [
        { role: 'system', content: `[ç³»ç»ŸæŒ‡ä»¤] å½“å‰æ­£åœ¨ä¸ç”¨æˆ·è¿›è¡Œè¯­éŸ³é€šè¯ã€‚
${userActionDesc}
è¯·ä»¥è¯­éŸ³é€šè¯çš„å£å»å›å¤ï¼Œå†…å®¹è¦ç®€çŸ­ã€å£è¯­åŒ–ã€‚
ç¦æ­¢è¾“å‡ºå¿ƒå£°ã€‚
åŒ…å«è¯­éŸ³å†…å®¹å’Œå£°éŸ³æå†™ï¼ˆå¦‚ç¬‘å£°ã€å¹æ°”ç­‰ï¼‰ï¼Œç”¨æ‹¬å·åŒ…è£¹å£°éŸ³æå†™ã€‚
ä½ çš„å›å¤å°†ç›´æ¥æ˜¾ç¤ºåœ¨é€šè¯ç•Œé¢çš„å­—å¹•ä¸­ã€‚`, position: 'at_depth', depth: 0 }
    ];
    
    const u = window.userName || '{{user}}';
    // Only log to history if text is not empty
    if (text) {
        renderMessageToUI({ header: `[${u}|é€šè¯|${t}]`, body: text, isUser: true });
        rebuildAndSaveHistory();
    }
    
    if (typeof generate !== 'undefined') {
        generate({ injects: injects, should_stream: false });
    }
}

// Incoming Call Logic
function receiveVoiceCall() {
    const incomingScreen = document.getElementById('incoming-call-screen');
    const nameEl = document.getElementById('incoming-call-name');
    const avatarEl = document.getElementById('incoming-call-avatar');
    
    if (!incomingScreen) return;
    
    const targetName = currentChatTarget || window.charName || '{{char}}';
    if (nameEl) nameEl.textContent = targetName;
    
    let avatarSrc = appSettings.charAvatar;
    if (appSettings.memberAvatars && appSettings.memberAvatars[targetName]) {
        avatarSrc = appSettings.memberAvatars[targetName];
    }
    if (avatarEl) avatarEl.src = avatarSrc;
    
    incomingScreen.style.display = 'flex';
    incomingScreen.style.visibility = 'visible';
    updateStatusBar('dark-search');
}

function acceptIncomingCall() {
    const incomingScreen = document.getElementById('incoming-call-screen');
    if (incomingScreen) incomingScreen.style.display = 'none';
    
    // Start call directly (skip dialing)
    startVoiceCall(true);
}

function declineIncomingCall() {
    const incomingScreen = document.getElementById('incoming-call-screen');
    if (incomingScreen) incomingScreen.style.display = 'none';
    updateStatusBar('chat');
    
    // Log system message
    const t = getTime();
    const u = window.userName || '{{user}}';
    renderMessageToUI({ header: `[${u}|${t}]`, body: `å·²æ‹’ç»é€šè¯`, isUser: true });
    rebuildAndSaveHistory();
    
    // Trigger AI response (Text format)
    const injects = [
        { role: 'system', content: `[ç³»ç»ŸæŒ‡ä»¤] ä½ ç»™ç”¨æˆ·æ‹¨æ‰“äº†è¯­éŸ³é€šè¯ï¼Œä½†ç”¨æˆ·æ‹’ç»äº†ï¼ˆæŒ‚æ–­ï¼‰ã€‚
è¯·ä»¥æ™®é€šæ–‡å­—æ¶ˆæ¯å›å¤ï¼Œè¡¨è¾¾ä½ çš„ååº”ï¼ˆå¦‚ç–‘æƒ‘ã€å¤±è½æˆ–è¯¢é—®åŸå› ï¼‰ã€‚
ç¦æ­¢ä½¿ç”¨è¯­éŸ³é€šè¯æ ¼å¼ã€‚`, position: 'at_depth', depth: 0 }
    ];
    
    if (typeof generate !== 'undefined') {
        generate({ injects: injects, should_stream: false });
    }
}

// Expose new functions
window.startVoiceCall = startVoiceCall;
window.endVoiceCall = endVoiceCall;
window.sendCallMessage = sendCallMessage;
window.receiveVoiceCall = receiveVoiceCall;
window.acceptIncomingCall = acceptIncomingCall;
window.declineIncomingCall = declineIncomingCall;
window.testApiConnection = testApiConnection;

})();
</script>
</body>
</html>